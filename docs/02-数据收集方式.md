# 数据收集方式

**版本：** v1.0  
**编制日期：** 2025.11.18  
**负责人/单位：** AI产业部  
**适用范围：** 日本地区陆上工厂化养殖的南美白对虾数据收集方式规范

---

## 1. 数据收集方式总览

### 1.1 收集方式分类

根据数据源类型，数据收集方式分为：

1. **自动采集**：设备自动采集并上传
2. **触发采集**：用户触发采集
3. **人工录入**：人工手动录入
4. **批量导入**：历史数据批量导入

### 1.2 数据流向

```
数据源 → 采集方式 → 客户端/中间件 → 服务器接收 → 数据清洗 → 数据存储
```

---

## 2. 各数据源收集方式详解

### 2.1 传感器数据收集

#### 采集流程

```
设备侧定时采集 → 客户端定时上传 → 服务器接收、清洗、入库
```

#### 详细步骤

1. **设备侧采集**
   - 传感器设备按配置的采样周期自动采集数据
   - 采样周期：建议1–10分钟，按场景配置
   - 数据格式：设备原始格式（通常为数字信号）

2. **客户端上传**
   - 客户端定时从设备读取数据
   - 数据打包：包含设备ID、时间戳、指标值、单位等
   - 上传方式：HTTP/HTTPS POST 或 MQTT 消息队列
   - 上传频率：与采样周期一致或批量上传

3. **服务器接收**
   - 接收数据包
   - 基本格式校验
   - 生成接收时间戳

4. **数据清洗**
   - 时间标准化（UTC + 本地时间）
   - 单位统一
   - 异常值初步检测

5. **数据入库**
   - 写入 `sensor_readings` 表
   - 记录质量标记（quality_flag）
   - 生成完整性校验（checksum）

#### 技术要求

- **网络要求**：稳定的网络连接，支持断线重传
- **时间同步**：设备时间需与服务器时间同步（NTP）
- **数据压缩**：大量数据可考虑压缩传输
- **错误处理**：网络故障时本地缓存，恢复后补传

#### 元数据要求

- `device_id`：设备唯一标识
- `batch_id`：关联批次（可选，可通过pool_id关联）
- `pool_id`：池号/分区标识
- `ts_utc`：UTC时间戳（毫秒精度）
- `ts_local`：本地时间戳（日本时区）
- `metric`：指标名称（如：do, ph, temp等）
- `value`：指标数值
- `unit`：计量单位
- `quality_flag`：质量标记（ok/missing/anomaly）
- `checksum`：完整性校验

---

### 2.2 图像目标监测数据收集

#### 采集流程

```
摄像头 → 客户端用户触发上传 → 服务器算法推理（检测/估计）→ 生成标注与汇总 → 存储与索引
```

#### 详细步骤

1. **图像采集**
   - 用户通过客户端触发图像/视频采集
   - 摄像头捕获图像或视频帧
   - 图像格式：JPG/PNG（静态）或 MP4（视频）

2. **客户端上传**
   - 用户确认后上传图像/视频
   - 上传元数据：camera_id, pool_id, batch_id, 时间戳等
   - 上传方式：HTTP/HTTPS POST（multipart/form-data）

3. **服务器接收**
   - 接收图像文件和元数据
   - 图像文件存储到对象存储（OSS/S3等）
   - 生成存储URI

4. **算法推理**
   - 调用AI模型进行目标检测和估计
   - 检测内容：
     - 数量（count）
     - 长度（avg_length_mm）
     - 高度（avg_height_mm）
     - 体重估计（est_weight_g_avg）
     - 饲料存在（feed_present）
     - 虾皮存在（shrimp_shell_present）
   - 生成置信度（confidence_avg）

5. **数据存储**
   - 图像元数据写入 `image_frames` 表
   - 检测结果写入 `image_detections` 表
   - 关联 `frame_id`

#### 技术要求

- **图像质量**：建议分辨率不低于1920x1080
- **文件大小**：单张图像建议不超过10MB
- **模型版本**：记录使用的模型名称和版本
- **处理延迟**：推理时间建议控制在5秒以内

#### 元数据要求

**image_frames 表**：
- `camera_id`：摄像头设备ID
- `batch_id`：批次ID
- `pool_id`：池号/分区
- `ts_utc`, `ts_local`：时间戳
- `storage_uri`：对象存储路径
- `width_px`, `height_px`：图像尺寸
- `format`：格式（jpg/png/mp4）
- `codec`：编解码（视频）
- `quality_flag`：质量标记
- `checksum`：完整性校验

**image_detections 表**：
- `frame_id`：关联image_frames.id
- `ts_utc`：推理时间戳
- `count`：检测数量
- `avg_length_mm`：平均长度（毫米）
- `avg_height_mm`：平均高度（毫米）
- `est_weight_g_avg`：平均估算体重（克）
- `feed_present`：是否存在饲料（0/1）
- `shrimp_shell_present`：是否存在虾皮（0/1）
- `model_name`：模型名称
- `model_version`：模型版本
- `confidence_avg`：平均置信度

---

### 2.3 喂食机数据收集

#### 采集流程

```
设备侧记录 → 客户端上传 → 服务器处理与入库
```

#### 详细步骤

1. **设备侧记录**
   - 喂食机执行喂食操作时自动记录
   - 记录内容：喂食时间、喂食量、运行时长、设备状态等
   - 数据存储在设备本地（可配置存储容量）

2. **客户端上传**
   - 客户端定时或事件触发从设备读取数据
   - 上传方式：HTTP/HTTPS POST 或 MQTT
   - 上传频率：每次喂食后或定时批量上传

3. **服务器处理**
   - 接收数据包
   - 数据格式校验
   - 时间标准化

4. **数据入库**
   - 写入 `feeders_logs` 表
   - 关联 `feeder_id`（设备ID）和 `batch_id`

#### 技术要求

- **设备状态监控**：实时监控设备状态（ok/warning/error）
- **数据完整性**：确保每次喂食都有记录
- **异常处理**：设备故障时记录异常状态

#### 元数据要求

- `feeder_id`：喂食机设备ID
- `batch_id`：批次ID
- `pool_id`：池号/分区
- `ts_utc`, `ts_local`：时间戳
- `feed_amount_g`：投喂量（克）
- `run_time_s`：运行时长（秒）
- `status`：状态（ok/warning/error）
- `leftover_estimate_g`：剩余饵料估计（克）
- `notes`：备注
- `checksum`：完整性校验

---

### 2.4 操作日志数据收集

#### 采集流程

```
人工录入 → 上传 → 规范化处理 → 知识库/数据库
```

#### 详细步骤

1. **人工录入**
   - 操作人员通过客户端界面录入操作信息
   - 录入内容：
     - 操作时间（自动获取或手动输入）
     - 操作人（从登录信息获取）
     - 操作类型（下拉选择）
     - 备注（自由文本）
     - 附件（可选，上传图片或文档）

2. **数据上传**
   - 客户端提交表单
   - 上传方式：HTTP/HTTPS POST
   - 实时上传或批量提交

3. **规范化处理**
   - 操作类型标准化（枚举值）
   - 时间格式标准化
   - 文本内容清理

4. **数据入库**
   - 写入 `operations_logs` 表
   - 附件存储到对象存储，记录URI

#### 技术要求

- **用户界面**：提供友好的录入界面
- **数据校验**：前端和后端双重校验
- **附件管理**：支持图片和文档上传，限制文件大小

#### 元数据要求

- `operator_id`：操作人ID
- `batch_id`：批次ID
- `pool_id`：池号/分区
- `ts_utc`, `ts_local`：时间戳
- `action_type`：操作类型（枚举值）
- `remarks`：备注
- `attachment_uri`：附件URI（可选）

---

### 2.5 养殖手册文档收集

#### 采集流程

```
人工上传 → 解析（必要时OCR/NLP）→ 结构化抽取 → 知识库
```

#### 详细步骤

1. **人工上传**
   - 管理员通过管理界面上传文档
   - 支持格式：PDF、Word、TXT等
   - 填写元数据：版本、来源、描述等

2. **文档解析**
   - 文本提取（PDF/Word解析）
   - OCR识别（如为图片格式）
   - NLP处理（提取关键信息）

3. **结构化抽取**
   - 提取操作流程
   - 提取注意事项
   - 提取异常处置SOP

4. **知识库存储**
   - 文档文件存储到对象存储或文件系统
   - 索引信息写入 `manuals_docs` 表
   - 结构化内容可存入知识库

#### 技术要求

- **文档格式**：支持常见文档格式
- **版本管理**：支持文档版本控制
- **全文检索**：支持文档内容检索

#### 元数据要求

- `doc_uri`：文档URI
- `version`：版本号
- `created_at`, `updated_at`：创建和更新时间
- `notes`：备注

---

### 2.6 往期养殖记录收集

#### 采集流程

```
人工上传 → 清洗 → 结构化 → 知识库/数据库
```

#### 详细步骤

1. **人工上传**
   - 管理员上传历史数据文件
   - 支持格式：CSV、Excel、JSON等
   - 数据内容：批次记录、苗种来源、放养密度、成活率等

2. **数据清洗**
   - 格式转换
   - 数据去重
   - 缺失值处理
   - 异常值检测

3. **结构化处理**
   - 字段映射
   - 数据类型转换
   - 单位统一

4. **数据入库**
   - 批量导入 `history_records` 表
   - 关联 `batch_id`

#### 技术要求

- **数据模板**：提供标准数据模板
- **批量导入**：支持大批量数据导入
- **数据校验**：导入前数据校验
- **错误处理**：导入失败时提供详细错误信息

#### 元数据要求

- `batch_id`：批次ID
- `metric_name`：指标名称
- `value`：值（文本存储）
- `unit`：单位
- `ts_utc`, `ts_local`：时间戳
- `notes`：备注

---

### 2.7 当期养殖记录收集

#### 采集流程

```
人工录入/系统自动汇总 → 数据库存储
```

#### 详细步骤

1. **批次创建**
   - 管理员创建新批次
   - 录入批次基本信息：
     - 物种（默认：Litopenaeus vannamei）
     - 池号（pool_id）
     - 场地位置（location）
     - 苗种来源（seed_origin）
     - 放养密度（stocking_density）
     - 开始日期（start_date）

2. **数据更新**
   - 人工更新：管理员定期更新批次信息
   - 自动汇总：系统根据其他数据源自动汇总（如成活率）

3. **数据存储**
   - 主信息写入 `batches` 表
   - 详细记录写入 `history_records` 表

#### 技术要求

- **数据关联**：确保与其他数据源的关联正确
- **数据完整性**：关键字段不能为空
- **版本管理**：支持数据变更历史记录（可选）

---

## 3. 文件命名规范

### 3.1 传感器数据文件

**格式**：`sensor_{deviceId}_{poolId}_{batchId}_{YYYYMMDDHHmmss}.csv`

**示例**：
```
sensor_001_pool01_batch2025001_20251118143000.csv
```

**字段说明**：
- `deviceId`：设备ID（3位数字或字母数字组合）
- `poolId`：池号（字母数字组合）
- `batchId`：批次ID（字母数字组合）
- `YYYYMMDDHHmmss`：时间戳（年月日时分秒）

### 3.2 图像文件

**格式**：`img_{cameraId}_{poolId}_{batchId}_{YYYYMMDDHHmmss}.{ext}`

**示例**：
```
img_cam01_pool01_batch2025001_20251118143000.jpg
```

**扩展名**：
- `.jpg` / `.jpeg`：静态图像
- `.png`：静态图像（无损）
- `.mp4`：视频文件

### 3.3 标注汇总文件

**格式**：`ann_{cameraId}_{poolId}_{batchId}_{YYYYMMDDHHmmss}.json`

**示例**：
```
ann_cam01_pool01_batch2025001_20251118143000.json
```

**JSON格式**：
```json
{
  "frame_id": 12345,
  "count": 150,
  "avg_length_mm": 85.5,
  "avg_height_mm": 12.3,
  "est_weight_g_avg": 8.5,
  "feed_present": 1,
  "shrimp_shell_present": 0,
  "model_name": "shrimp_detection_v2",
  "model_version": "2.1.0",
  "confidence_avg": 0.92
}
```

### 3.4 日志文件

**格式**：`log_{operatorId}_{poolId}_{YYYYMMDD}.csv`

**示例**：
```
log_op001_pool01_20251118.csv
```

---

## 4. 目录结构规范

### 4.1 原始数据目录

```
/data/raw/
├── sensor/
│   └── {YYYY}/
│       └── {MM}/
│           └── {DD}/
│               └── sensor_{deviceId}_{poolId}_{batchId}_{timestamp}.csv
├── image/
│   └── {YYYY}/
│       └── {MM}/
│           └── {DD}/
│               └── img_{cameraId}_{poolId}_{batchId}_{timestamp}.jpg
├── feed/
│   └── {YYYY}/
│       └── {MM}/
│           └── {DD}/
│               └── feed_{feederId}_{poolId}_{batchId}_{timestamp}.csv
└── log/
    └── {YYYY}/
        └── {MM}/
            └── {DD}/
                └── log_{operatorId}_{poolId}_{YYYYMMDD}.csv
```

### 4.2 处理后数据目录

```
/data/processed/
├── sensor/
│   └── {batchId}/
│       └── processed_sensor_{batchId}_{YYYYMMDD}.csv
├── image/
│   └── {batchId}/
│       └── processed_image_{batchId}_{YYYYMMDD}.json
└── feed/
    └── {batchId}/
        └── processed_feed_{batchId}_{YYYYMMDD}.csv
```

### 4.3 标注数据目录

```
/data/annotations/
└── {batchId}/
    ├── ann_{cameraId}_{poolId}_{batchId}_{timestamp}.json
    └── annotations_summary_{batchId}.json
```

### 4.4 文档目录

```
/data/docs/
├── manuals/
│   └── manual_v{version}_{YYYYMMDD}.pdf
└── history/
    └── history_batch_{batchId}_{YYYYMMDD}.csv
```

---

## 5. 元数据标准

### 5.1 通用元数据字段

所有数据源必须包含以下元数据：

| 字段名 | 类型 | 说明 | 是否必填 |
|--------|------|------|----------|
| `data_id` | VARCHAR(64) | 数据唯一标识 | 是 |
| `source_type` | ENUM | 数据源类型（sensor/image/feed/log/manual/history） | 是 |
| `device_id` / `camera_id` / `feeder_id` | BIGINT | 设备ID（根据类型选择） | 条件必填 |
| `operator_id` | VARCHAR(64) | 操作人ID（人工数据） | 条件必填 |
| `timestamp_utc` | DATETIME(3) | UTC时间戳（毫秒精度） | 是 |
| `timestamp_local` | DATETIME(3) | 本地时间戳（日本时区） | 推荐 |
| `location` | VARCHAR(128) | 场地/车间/池号 | 推荐 |
| `batch_id` | BIGINT | 养殖批次ID | 推荐 |
| `unit` | VARCHAR(16) | 计量单位 | 条件必填 |
| `sampling_rate` | INT | 采样频率（秒） | 条件必填 |
| `quality_flag` | ENUM | 质量标记（ok/missing/anomaly） | 是 |
| `checksum` | VARCHAR(64) | 完整性校验（MD5/SHA256） | 推荐 |

### 5.2 图像与标注元数据补充

图像数据额外包含：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| `resolution` | VARCHAR(32) | 分辨率（如：1920x1080） |
| `format` | VARCHAR(16) | 格式（jpg/png/mp4） |
| `codec` | VARCHAR(32) | 编解码（视频） |
| `annotation_type` | VARCHAR(32) | 标注类型（count/size/weight/boolean_flags） |
| `model_name` | VARCHAR(128) | 模型名称 |
| `model_version` | VARCHAR(64) | 模型版本 |

---

## 6. 数据收集频率与时机

### 6.1 高频数据（自动采集）

| 数据源 | 采集频率 | 触发方式 |
|--------|----------|----------|
| 传感器数据 | 1-10分钟 | 定时自动 |
| 图像检测数据 | 用户触发 | 手动触发 |
| 喂食机数据 | 每次喂食 | 事件触发 |

### 6.2 低频数据（人工录入）

| 数据源 | 采集频率 | 触发方式 |
|--------|----------|----------|
| 操作日志 | 每次操作 | 人工录入 |
| 养殖手册 | 版本更新 | 人工上传 |
| 历史记录 | 批次结束 | 批量导入 |
| 当期记录 | 定期更新 | 人工录入/自动汇总 |

---

## 7 附录

### 7.1 数据收集流程图

```
┌─────────────┐
│  数据源     │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  采集方式   │ (自动/触发/人工)
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  客户端     │ (数据打包/格式化)
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  网络传输   │ (HTTP/MQTT/其他)
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  服务器接收 │ (校验/解析)
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  数据存储   │ (数据库/对象存储)
└─────────────┘
```

---

**文档状态**：待确认  
**最后更新**：2025.11.18





