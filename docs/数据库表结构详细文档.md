# 数据库表结构详细文档

**数据库名称：** `cognitive`  
**数据库类型：** MySQL  
**文档生成日期：** 2025-01-XX  
**文档版本：** v1.0

---

## 目录

1. [表概览](#表概览)
2. [核心业务表](#核心业务表)
3. [设备管理表](#设备管理表)
4. [图像检测表](#图像检测表)
5. [系统管理表](#系统管理表)
6. [AI决策表](#ai决策表)
7. [消息队列表](#消息队列表)
8. [会话管理表](#会话管理表)

---

## 表概览

数据库 `cognitive` 共包含 **30个表**，分为以下几类：

| 类别 | 表数量 | 说明 |
|------|--------|------|
| 核心业务表 | 8 | 传感器、批次、喂食机、操作日志等 |
| 设备管理表 | 3 | 设备、传感器、摄像头等 |
| 图像检测表 | 4 | 摄像头图像、健康检查、虾类统计 |
| 系统管理表 | 5 | 用户、会话、任务、工具等 |
| AI决策表 | 3 | AI决策、决策规则、聊天历史 |
| 消息队列表 | 2 | 消息队列、消息类型 |
| 其他表 | 5 | 工作流、主题记忆等 |

---

## 核心业务表

### 1. sensor_readings（传感器读数表）

**表说明：** 存储传感器采集的实时数据，是系统的核心数据表

**字段详情：**

| 字段名 | 类型 | 可空 | 键 | 默认值 | 说明 |
|--------|------|------|-----|--------|------|
| id | int | NO | PRI | auto_increment | 主键ID |
| sensor_id | int | NO | MUL | NULL | 传感器设备ID（FK） |
| batch_id | bigint unsigned | YES | MUL | NULL | 批次ID（FK） |
| pool_id | varchar(64) | YES | | NULL | 池号/分区标识 |
| value | float | NO | | NULL | 传感器读数值 |
| recorded_at | timestamp | YES | | NULL | 数据记录时间 |
| ts_utc | datetime(3) | YES | | NULL | UTC时间戳（毫秒精度） |
| ts_local | datetime(3) | YES | | NULL | 本地时间戳（日本时区） |
| metric | varchar(32) | YES | | NULL | 指标名称（如：temperature, ph, do等） |
| type_name | varchar(128) | YES | | NULL | 指标名称的前端映射类型名称 |
| description | text | YES | | NULL | 描述 |
| unit | varchar(50) | YES | | NULL | 计量单位 |
| quality_flag | enum('ok','missing','anomaly') | NO | | 'ok' | 质量标记 |
| checksum | varchar(64) | YES | | NULL | 完整性校验 |
| created_at | timestamp | NO | | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | timestamp | NO | | CURRENT_TIMESTAMP | 更新时间 |

**索引：**
- PRIMARY KEY (`id`)
- INDEX `idx_sensor_id_recorded_at` (`sensor_id`, `recorded_at`)
- INDEX `idx_sr_batch_metric_ts` (`batch_id`, `metric`, `ts_utc`)

**数据量：** 约 62,069 条记录

---

### 2. sensors（传感器表）

**表说明：** 存储传感器设备的基本信息

**字段详情：**

| 字段名 | 类型 | 可空 | 键 | 默认值 | 说明 |
|--------|------|------|-----|--------|------|
| id | int | NO | PRI | auto_increment | 主键ID |
| sensor_id | varchar(128) | NO | UNI | NULL | 传感器唯一标识符 |
| name | varchar(128) | YES | | NULL | 传感器名称 |
| pond_id | int | NO | MUL | NULL | 所属养殖池ID（FK） |
| sensor_type_id | int | NO | MUL | NULL | 传感器类型ID（FK） |
| model | varchar(128) | YES | | NULL | 传感器型号 |
| installed_at | timestamp | YES | | NULL | 安装日期 |
| status | varchar(50) | NO | | 'active' | 传感器状态 |
| created_at | timestamp | NO | | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | timestamp | NO | | CURRENT_TIMESTAMP | 更新时间 |

**索引：**
- PRIMARY KEY (`id`)
- UNIQUE KEY `idx_sensor_uuid` (`sensor_id`)

**数据量：** 约 8 条记录

---

### 3. sensor_types（传感器类型表）

**表说明：** 定义传感器类型，如温度、pH、溶解氧等

**字段详情：**

| 字段名 | 类型 | 可空 | 键 | 默认值 | 说明 |
|--------|------|------|-----|--------|------|
| id | int | NO | PRI | auto_increment | 主键ID |
| type_name | varchar(64) | NO | UNI | NULL | 类型名称（如：temperature） |
| unit | varchar(32) | YES | | NULL | 计量单位 |
| description | text | YES | | NULL | 描述 |
| created_at | timestamp | NO | | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | timestamp | NO | | CURRENT_TIMESTAMP | 更新时间 |

**索引：**
- PRIMARY KEY (`id`)
- UNIQUE KEY (`type_name`)

**数据量：** 约 7 条记录

---

### 4. batches（批次信息表）

**表说明：** 存储养殖批次的基本信息

**字段详情：**

| 字段名 | 类型 | 可空 | 键 | 默认值 | 说明 |
|--------|------|------|-----|--------|------|
| batch_id | bigint unsigned | NO | PRI | auto_increment | 批次ID（主键） |
| pool_id | varchar(64) | NO | MUL | NULL | 池号/分区标识 |
| species | varchar(64) | NO | | 'Litopenaeus vannamei' | 物种（默认南美白对虾学名） |
| location | varchar(128) | YES | | NULL | 场地/车间位置 |
| seed_origin | varchar(128) | YES | | NULL | 苗种来源 |
| stocking_density | decimal(10,2) | YES | | NULL | 放养密度（尾/㎡或尾/m³） |
| start_date | date | NO | | NULL | 开始日期 |
| end_date | date | YES | | NULL | 结束日期（可空） |
| notes | text | YES | | NULL | 备注 |
| created_at | timestamp | NO | | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | timestamp | NO | | CURRENT_TIMESTAMP | 更新时间 |

**索引：**
- PRIMARY KEY (`batch_id`)
- INDEX `idx_batches_pool_dates` (`pool_id`, `start_date`, `end_date`)

**数据量：** 约 1 条记录

---

### 5. feeders_logs（喂食机记录表）

**表说明：** 存储喂食机的运行记录

**字段详情：**

| 字段名 | 类型 | 可空 | 键 | 默认值 | 说明 |
|--------|------|------|-----|--------|------|
| id | bigint unsigned | NO | PRI | auto_increment | 主键ID |
| feeder_id | int | NO | | NULL | 喂食机设备ID（FK） |
| batch_id | bigint unsigned | YES | MUL | NULL | 批次ID（FK） |
| pool_id | varchar(64) | YES | | NULL | 池号/分区（冗余） |
| ts_utc | datetime(3) | NO | | NULL | UTC时间戳 |
| ts_local | datetime(3) | YES | | NULL | 本地时间戳 |
| feed_amount_g | decimal(12,3) | YES | | NULL | 投喂量（克） |
| run_time_s | int | YES | | NULL | 运行时长（秒） |
| status | enum('ok','warning','error') | NO | | 'ok' | 状态 |
| leftover_estimate_g | decimal(12,3) | YES | | NULL | 剩余饵料估计（克） |
| notes | text | YES | | NULL | 备注 |
| checksum | varchar(64) | YES | | NULL | 完整性校验 |
| created_at | timestamp | NO | | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | timestamp | NO | | CURRENT_TIMESTAMP | 更新时间 |

**索引：**
- PRIMARY KEY (`id`)
- INDEX `idx_fl_feeder_ts` (`feeder_id`, `ts_utc`)
- INDEX `idx_fl_batch_ts` (`batch_id`, `ts_utc`)

**数据量：** 约 1 条记录

---

### 6. operations_logs（操作日志表）

**表说明：** 存储人工操作日志

**字段详情：**

| 字段名 | 类型 | 可空 | 键 | 默认值 | 说明 |
|--------|------|------|-----|--------|------|
| id | bigint unsigned | NO | PRI | auto_increment | 主键ID |
| operator_id | varchar(64) | NO | MUL | NULL | 操作人 |
| batch_id | bigint unsigned | YES | MUL | NULL | 批次ID（FK） |
| pool_id | varchar(64) | YES | | NULL | 池号/分区 |
| ts_utc | datetime(3) | NO | | NULL | UTC时间戳 |
| ts_local | datetime(3) | YES | | NULL | 本地时间戳 |
| action_type | varchar(64) | NO | | NULL | 操作类型（投料/水质调控/巡检/清洗等） |
| remarks | text | YES | | NULL | 备注 |
| attachment_uri | varchar(512) | YES | | NULL | 附件URI |
| created_at | timestamp | NO | | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | timestamp | NO | | CURRENT_TIMESTAMP | 更新时间 |

**索引：**
- PRIMARY KEY (`id`)
- INDEX `idx_ol_operator_ts` (`operator_id`, `ts_utc`)
- INDEX `idx_ol_batch_ts` (`batch_id`, `ts_utc`)

**数据量：** 约 1 条记录

---

### 7. manuals_docs（养殖手册文档表）

**表说明：** 存储养殖手册/文档索引

**字段详情：**

| 字段名 | 类型 | 可空 | 键 | 默认值 | 说明 |
|--------|------|------|-----|--------|------|
| id | bigint unsigned | NO | PRI | auto_increment | 主键ID |
| doc_uri | varchar(512) | NO | | NULL | 文档URI |
| version | varchar(64) | YES | MUL | NULL | 版本 |
| source | varchar(64) | YES | | NULL | 来源 |
| created_at | timestamp | NO | | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | timestamp | NO | | CURRENT_TIMESTAMP | 更新时间 |
| notes | text | YES | | NULL | 备注 |

**索引：**
- PRIMARY KEY (`id`)
- INDEX `idx_md_version` (`version`)
- INDEX `idx_md_created` (`created_at`)

**数据量：** 约 1 条记录

---

### 8. history_records（往期养殖记录表）

**表说明：** 存储往期养殖记录（结构化）

**字段详情：**

| 字段名 | 类型 | 可空 | 键 | 默认值 | 说明 |
|--------|------|------|-----|--------|------|
| id | bigint unsigned | NO | PRI | auto_increment | 主键ID |
| batch_id | bigint unsigned | YES | MUL | NULL | 批次ID（FK） |
| metric_name | varchar(64) | NO | | NULL | 指标名称 |
| value | varchar(128) | NO | | NULL | 值（文本存储） |
| unit | varchar(16) | YES | | NULL | 单位 |
| ts_utc | datetime(3) | YES | | NULL | UTC时间戳 |
| ts_local | datetime(3) | YES | | NULL | 本地时间戳 |
| notes | text | YES | | NULL | 备注 |
| created_at | timestamp | NO | | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | timestamp | NO | | CURRENT_TIMESTAMP | 更新时间 |

**索引：**
- PRIMARY KEY (`id`)
- INDEX `idx_hr_batch_metric_ts` (`batch_id`, `metric_name`, `ts_utc`)

**数据量：** 约 1 条记录

---

## 设备管理表

### 9. devices（设备表）

**表说明：** 存储设备管理信息，包括传感器、执行器等

**字段详情：**

| 字段名 | 类型 | 可空 | 键 | 默认值 | 说明 |
|--------|------|------|-----|--------|------|
| id | int | NO | PRI | auto_increment | 主键ID |
| device_id | varchar(128) | NO | UNI | NULL | 设备唯一标识符 |
| name | varchar(128) | NO | | NULL | 设备名称 |
| description | text | YES | | NULL | 设备描述信息 |
| ownership | varchar(128) | NO | | NULL | 设备归属 |
| device_type_id | int | YES | MUL | NULL | 设备类型ID（FK） |
| model | varchar(128) | YES | | NULL | 设备型号/规格 |
| manufacturer | varchar(128) | YES | | NULL | 制造商 |
| serial_number | varchar(128) | YES | UNI | NULL | 设备序列号 |
| location | varchar(255) | YES | | NULL | 设备安装位置 |
| pond_id | int | YES | MUL | NULL | 所属养殖池ID（FK） |
| firmware_version | varchar(64) | YES | | NULL | 固件版本 |
| hardware_version | varchar(64) | YES | | NULL | 硬件版本 |
| ip_address | varchar(45) | YES | | NULL | 设备IP地址 |
| mac_address | varchar(17) | YES | | NULL | MAC地址 |
| config_json | json | YES | | NULL | 设备配置参数（JSON格式） |
| tags | varchar(255) | YES | | NULL | 设备标签 |
| installed_at | timestamp | YES | | NULL | 安装时间 |
| last_maintenance_at | timestamp | YES | | NULL | 最后维护时间 |
| next_maintenance_at | timestamp | YES | | NULL | 下次维护时间 |
| warranty_expires_at | timestamp | YES | | NULL | 保修到期时间 |
| retired_at | timestamp | YES | | NULL | 设备退役时间 |
| status | varchar(50) | NO | | 'active' | 设备状态 |
| switch_status | varchar(50) | NO | | 'off' | 开关状态 |
| priority | varchar(20) | YES | | 'medium' | 设备优先级 |
| created_at | timestamp | YES | | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | timestamp | YES | | CURRENT_TIMESTAMP | 更新时间 |

**索引：**
- PRIMARY KEY (`id`)
- UNIQUE KEY `device_id` (`device_id`)
- INDEX `idx_device_status` (`status`)
- INDEX `idx_device_ownership` (`ownership`)
- INDEX `idx_device_type` (`device_type_id`)

**数据量：** 约 6 条记录

---

### 10. device_types（设备类型表）

**表说明：** 定义不同类型的设备分类

**字段详情：**

| 字段名 | 类型 | 可空 | 键 | 默认值 | 说明 |
|--------|------|------|-----|--------|------|
| id | int | NO | PRI | auto_increment | 主键ID |
| name | varchar(64) | NO | UNI | NULL | 设备类型名称 |
| description | text | YES | | NULL | 设备类型描述 |
| type_code | varchar(64) | NO | UNI | NULL | 设备类型代码 |
| created_at | timestamp | YES | | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | timestamp | YES | | CURRENT_TIMESTAMP | 更新时间 |

**索引：**
- PRIMARY KEY (`id`)
- UNIQUE KEY `name` (`name`)
- UNIQUE KEY `type_code` (`type_code`)

**数据量：** 约 3 条记录

---

### 11. ponds（池塘表）

**表说明：** 存储养殖池的基本信息

**字段详情：**

| 字段名 | 类型 | 可空 | 键 | 默认值 | 说明 |
|--------|------|------|-----|--------|------|
| id | int | NO | PRI | auto_increment | 主键ID |
| name | varchar(128) | NO | | NULL | 池塘名称 |
| location | varchar(255) | YES | | NULL | 位置 |
| description | text | YES | | NULL | 描述 |
| created_at | timestamp | NO | | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | timestamp | NO | | CURRENT_TIMESTAMP | 更新时间 |

**索引：**
- PRIMARY KEY (`id`)

**数据量：** 约 4 条记录

---

## 图像检测表

### 12. camera_images（摄像头图像表）

**表说明：** 存储摄像头拍摄的图片信息

**字段详情：**

| 字段名 | 类型 | 可空 | 键 | 默认值 | 说明 |
|--------|------|------|-----|--------|------|
| id | int | NO | PRI | auto_increment | 主键ID |
| camera_id | int | NO | MUL | NULL | 摄像头ID |
| batch_id | bigint unsigned | YES | MUL | NULL | 批次ID（FK） |
| pool_id | varchar(64) | YES | | NULL | 池号/分区（冗余） |
| name | varchar(255) | NO | | NULL | 摄像头名称 |
| location | varchar(255) | NO | | NULL | 摄像头位置 |
| status | varchar(50) | NO | MUL | NULL | 摄像头状态 |
| image_url | varchar(500) | NO | | NULL | 图片URL |
| storage_uri | varchar(512) | YES | | NULL | 对象存储路径/URI |
| last_update | bigint | NO | | NULL | 最后更新时间戳（毫秒） |
| timestamp | bigint | NO | MUL | NULL | 图片时间戳（毫秒） |
| ts_utc | datetime(3) | YES | | NULL | UTC时间戳 |
| ts_local | datetime(3) | YES | | NULL | 本地时间戳 |
| fps | int | NO | | 0 | 帧率 |
| created_at | timestamp | NO | MUL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | timestamp | NO | | CURRENT_TIMESTAMP | 更新时间 |
| timestamp_str | varchar(50) | NO | | '' | 图片时间戳字符串 |
| width | int | NO | | 1920 | 图片宽度 |
| width_px | int | YES | | NULL | 宽度像素 |
| height | int | NO | | 1080 | 图片高度 |
| height_px | int | YES | | NULL | 高度像素 |
| format | varchar(20) | NO | | 'jpg' | 图片格式 |
| codec | varchar(32) | YES | | NULL | 编解码（视频） |
| quality_flag | enum('ok','missing','anomaly') | NO | | 'ok' | 质量标记 |
| checksum | varchar(64) | YES | | NULL | 完整性校验 |
| size | int | NO | | 0 | 图片大小（字节） |

**索引：**
- PRIMARY KEY (`id`)
- INDEX `idx_camera_id` (`camera_id`)
- INDEX `idx_status` (`status`)
- INDEX `idx_timestamp` (`timestamp`)
- INDEX `idx_created_at` (`created_at`)
- INDEX `idx_if_batch_ts` (`batch_id`, `ts_utc`)

**数据量：** 约 14 条记录

---

### 13. camera_status（摄像头状态表）

**表说明：** 存储摄像头的基本状态信息

**字段详情：**

| 字段名 | 类型 | 可空 | 键 | 默认值 | 说明 |
|--------|------|------|-----|--------|------|
| id | int | NO | PRI | auto_increment | 主键ID |
| camera_id | int | NO | MUL | NULL | 摄像头ID |
| name | varchar(255) | NO | | NULL | 摄像头名称 |
| location | varchar(255) | NO | MUL | NULL | 摄像头位置 |
| status | varchar(50) | NO | MUL | NULL | 摄像头状态（在线/离线） |
| quality | varchar(50) | NO | | NULL | 画质（高/中/低） |
| resolution | varchar(50) | NO | | NULL | 分辨率 |
| last_update | bigint | NO | | NULL | 最后更新时间戳（毫秒） |
| last_update_time | varchar(50) | NO | | NULL | 最后更新时间字符串 |
| temperature | decimal(5,2) | YES | | NULL | 温度 |
| fps | int | NO | | 0 | 帧率 |
| connectivity | int | NO | | 0 | 连通性百分比 |
| recording | boolean | NO | | False | 是否正在录制 |
| night_vision | boolean | NO | | False | 是否开启夜视功能 |
| motion_detection | boolean | NO | | False | 是否开启运动检测 |
| created_at | timestamp | NO | MUL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | timestamp | NO | | CURRENT_TIMESTAMP | 更新时间 |

**索引：**
- PRIMARY KEY (`id`)
- INDEX `idx_camera_id` (`camera_id`)
- INDEX `idx_status` (`status`)
- INDEX `idx_location` (`location`)
- INDEX `idx_created_at` (`created_at`)

**数据量：** 约 11 条记录

---

### 14. camera_health（摄像头健康检查表）

**表说明：** 存储摄像头的健康状态和检查结果

**字段详情：**

| 字段名 | 类型 | 可空 | 键 | 默认值 | 说明 |
|--------|------|------|-----|--------|------|
| id | int | NO | PRI | auto_increment | 主键ID |
| camera_id | int | NO | MUL | NULL | 摄像头ID |
| name | varchar(255) | NO | | NULL | 摄像头名称 |
| location | varchar(255) | NO | | NULL | 摄像头位置 |
| health_status | varchar(50) | NO | MUL | NULL | 健康状态 |
| overall_score | decimal(5,2) | NO | MUL | NULL | 总体健康分数（0-100） |
| connectivity_status | varchar(50) | NO | | NULL | 连通性检查状态 |
| connectivity_score | int | NO | | NULL | 连通性分数 |
| connectivity_message | varchar(500) | NO | | NULL | 连通性检查消息 |
| image_quality_status | varchar(50) | NO | | NULL | 图像质量检查状态 |
| image_quality_score | int | NO | | NULL | 图像质量分数 |
| image_quality_message | varchar(500) | NO | | NULL | 图像质量检查消息 |
| hardware_status | varchar(50) | NO | | NULL | 硬件检查状态 |
| hardware_score | int | NO | | NULL | 硬件分数 |
| hardware_message | varchar(500) | NO | | NULL | 硬件检查消息 |
| storage_status | varchar(50) | NO | | NULL | 存储检查状态 |
| storage_score | int | NO | | NULL | 存储分数 |
| storage_message | varchar(500) | NO | | NULL | 存储检查消息 |
| temperature | decimal(5,2) | YES | | NULL | 温度 |
| uptime_hours | int | YES | | NULL | 运行时间（小时） |
| timestamp | bigint | NO | | NULL | 检查时间戳（毫秒） |
| last_check | varchar(50) | NO | | NULL | 最后检查时间字符串 |
| created_at | timestamp | NO | MUL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | timestamp | NO | | CURRENT_TIMESTAMP | 更新时间 |

**索引：**
- PRIMARY KEY (`id`)
- INDEX `idx_camera_id` (`camera_id`)
- INDEX `idx_health_status` (`health_status`)
- INDEX `idx_overall_score` (`overall_score`)
- INDEX `idx_created_at` (`created_at`)

**数据量：** 约 11 条记录

---

### 15. shrimp_stats（虾类统计表）

**表说明：** 存储图像识别统计结果

**字段详情：**

| 字段名 | 类型 | 可空 | 键 | 默认值 | 说明 |
|--------|------|------|-----|--------|------|
| id | bigint | NO | PRI | auto_increment | 主键ID |
| frame_id | bigint unsigned | YES | MUL | NULL | 图像帧ID（FK） |
| ts_utc | datetime(3) | YES | MUL | NULL | UTC时间戳（推理） |
| uuid | char(36) | YES | UNI | NULL | UUID |
| pond_id | varchar(255) | NO | MUL | NULL | 池塘ID |
| input_subdir | varchar(255) | NO | | NULL | 输入子目录 |
| output_dir | varchar(512) | NO | | NULL | 输出目录 |
| created_at_source_iso | varchar(64) | NO | | NULL | 源创建时间ISO格式 |
| created_at_source | datetime(6) | YES | | NULL | 源创建时间 |
| conf | double | YES | | NULL | 置信度 |
| confidence_avg | decimal(5,4) | YES | | NULL | 平均置信度 |
| notes | text | YES | | NULL | 备注 |
| iou | double | YES | | NULL | IoU值 |
| total_live | int | NO | | NULL | 总活体数 |
| count | int | YES | | NULL | 检测数量 |
| total_dead | int | NO | | NULL | 总死体数 |
| size_min_cm | double | YES | | NULL | 最小尺寸（厘米） |
| size_max_cm | double | YES | | NULL | 最大尺寸（厘米） |
| size_mean_cm | double | YES | | NULL | 平均尺寸（厘米） |
| avg_length_mm | decimal(12,3) | YES | | NULL | 平均长度（毫米） |
| avg_height_mm | decimal(12,3) | YES | | NULL | 平均高度（毫米） |
| size_median_cm | double | YES | | NULL | 中位数尺寸（厘米） |
| weight_min_g | double | YES | | NULL | 最小重量（克） |
| weight_max_g | double | YES | | NULL | 最大重量（克） |
| weight_mean_g | double | YES | | NULL | 平均重量（克） |
| est_weight_g_avg | decimal(12,3) | YES | | NULL | 平均估算体重（克） |
| feed_present | tinyint(1) | NO | | 0 | 是否存在饲料（布尔） |
| shrimp_shell_present | tinyint(1) | NO | | 0 | 是否存在虾皮（布尔） |
| model_name | varchar(128) | YES | MUL | NULL | 模型名称 |
| model_version | varchar(64) | YES | | NULL | 模型版本 |
| weight_median_g | double | YES | | NULL | 中位数重量（克） |
| source_file | varchar(512) | YES | | NULL | 源文件 |
| created_at | timestamp | YES | | NULL | 创建时间 |
| updated_at | timestamp | YES | | NULL | 更新时间 |

**索引：**
- PRIMARY KEY (`id`)
- UNIQUE KEY (`uuid`)
- INDEX `idx_id_frame` (`frame_id`)
- INDEX `idx_id_ts` (`ts_utc`)
- INDEX `idx_id_modelver` (`model_name`, `model_version`)

**数据量：** 约 20 条记录

---

## 系统管理表

### 16. user（用户表）

**表说明：** 存储用户信息

**字段详情：** （需要查看实际表结构）

**数据量：** 约 1 条记录

---

### 17. session（会话表）

**表说明：** 存储会话信息

**字段详情：** （需要查看实际表结构）

**数据量：** 约 1 条记录

---

### 18. tasks（任务表）

**表说明：** 存储任务信息

**字段详情：** （需要查看实际表结构）

**数据量：** 约 1 条记录

---

### 19. tools（工具表）

**表说明：** 存储工具信息

**字段详情：** （需要查看实际表结构）

**数据量：** 约 1 条记录

---

### 20. workflows（工作流表）

**表说明：** 存储工作流信息

**字段详情：** （需要查看实际表结构）

**数据量：** 约 1 条记录

---

## AI决策表

### 21. ai_decisions（AI决策表）

**表说明：** 存储AI决策消息

**字段详情：**

| 字段名 | 类型 | 可空 | 键 | 默认值 | 说明 |
|--------|------|------|-----|--------|------|
| id | int | NO | PRI | auto_increment | 主键ID |
| decision_id | varchar(64) | NO | UNI | NULL | 决策ID |
| type | enum('analysis','warning','action','optimization') | NO | MUL | NULL | 决策类型 |
| message | text | NO | | NULL | 消息内容 |
| action | text | YES | | NULL | 建议操作 |
| source | varchar(100) | YES | MUL | NULL | 来源 |
| source_id | varchar(100) | YES | | NULL | 来源ID |
| expires_at | timestamp | YES | MUL | NULL | 过期时间 |
| priority | int | NO | MUL | NULL | 优先级 |
| confidence | decimal(5,2) | YES | | NULL | 置信度 |
| status | enum('active','processed','expired') | NO | MUL | NULL | 状态 |
| created_at | timestamp | NO | MUL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | timestamp | NO | | CURRENT_TIMESTAMP | 更新时间 |

**索引：**
- PRIMARY KEY (`id`)
- UNIQUE KEY `decision_id` (`decision_id`)
- INDEX `idx_type` (`type`)
- INDEX `idx_status` (`status`)
- INDEX `idx_priority` (`priority`)
- INDEX `idx_source` (`source`, `source_id`)
- INDEX `idx_expires_at` (`expires_at`)
- INDEX `idx_created_at` (`created_at`)

**数据量：** 约 1 条记录

---

### 22. decision_rules（决策规则表）

**表说明：** 存储AI决策规则

**字段详情：**

| 字段名 | 类型 | 可空 | 键 | 默认值 | 说明 |
|--------|------|------|-----|--------|------|
| id | int | NO | PRI | auto_increment | 主键ID |
| rule_id | varchar(64) | NO | UNI | NULL | 规则ID |
| decision_type | varchar(50) | NO | MUL | NULL | 决策类型 |
| condition_type | varchar(50) | NO | MUL | NULL | 条件类型 |
| condition_value | text | NO | | NULL | 条件值 |
| action | text | NO | | NULL | 动作 |
| priority | int | NO | MUL | NULL | 优先级 |
| is_active | boolean | NO | MUL | True | 是否激活 |
| created_at | timestamp | NO | | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | timestamp | NO | | CURRENT_TIMESTAMP | 更新时间 |

**索引：**
- PRIMARY KEY (`id`)
- UNIQUE KEY `rule_id` (`rule_id`)
- INDEX `idx_decision_type` (`decision_type`)
- INDEX `idx_condition_type` (`condition_type`)
- INDEX `idx_priority` (`priority`)
- INDEX `idx_is_active` (`is_active`)

**数据量：** 约 1 条记录

---

### 23. chat_history（聊天历史表）

**表说明：** 存储聊天历史记录

**字段详情：** （需要查看实际表结构）

**索引：**
- INDEX `idx_session_id` (`session_id`)

**数据量：** 约 1 条记录

---

## 消息队列表

### 24. message_queue（消息队列表）

**表说明：** 存储消息队列

**字段详情：**

| 字段名 | 类型 | 可空 | 键 | 默认值 | 说明 |
|--------|------|------|-----|--------|------|
| id | bigint | NO | PRI | auto_increment | 主键ID |
| message_id | varchar(64) | NO | UNI | NULL | 消息ID |
| content | text | NO | | NULL | 消息内容 |
| message_type | varchar(50) | NO | | 'general' | 消息类型 |
| priority | int | NO | | 5 | 优先级（0-10） |
| status | enum('pending','processing','completed','failed','expired') | NO | | 'pending' | 消息状态 |
| retry_count | int | NO | | 0 | 重试次数 |
| max_retries | int | NO | | 3 | 最大重试次数 |
| consumed_at | timestamp | YES | | NULL | 处理开始时间 |
| completed_at | timestamp | YES | | NULL | 处理完成时间 |
| error_message | text | YES | | NULL | 错误信息 |
| expires_at | timestamp | YES | | NULL | 过期时间 |
| message_metadata | text | YES | | NULL | 消息元数据 |
| created_at | timestamp | NO | | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | timestamp | NO | | CURRENT_TIMESTAMP | 更新时间 |

**索引：**
- PRIMARY KEY (`id`)
- UNIQUE KEY (`message_id`)

**数据量：** 约 1 条记录

---

### 25. message_types（消息类型表）

**表说明：** 定义消息类型

**字段详情：** （需要查看实际表结构）

**数据量：** 约 1 条记录

---

## 其他表

### 26. agent_task（代理任务表）

**表说明：** 存储代理任务信息

**字段详情：**

| 字段名 | 类型 | 可空 | 键 | 默认值 | 说明 |
|--------|------|------|-----|--------|------|
| id | bigint | NO | PRI | auto_increment | 主键ID |
| task_id | varchar(255) | NO | UNI | NULL | 任务ID |
| session_id | varchar(255) | YES | MUL | NULL | 会话ID |
| parent_task_id | varchar(255) | YES | MUL | NULL | 父任务ID |
| goal | text | NO | | NULL | 目标 |
| input_params | json | YES | | NULL | 输入参数 |
| result | json | YES | | NULL | 结果 |
| error_message | text | YES | | NULL | 错误信息 |
| logs | text | YES | | NULL | 日志 |
| tool_calls | json | YES | | NULL | 工具调用 |
| token_usage | int | YES | | NULL | Token使用量 |
| completed_at | timestamp | YES | | NULL | 完成时间 |
| status | varchar(50) | NO | | NULL | 状态 |
| priority | int | NO | | NULL | 优先级 |
| created_at | timestamp | NO | | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | timestamp | NO | | CURRENT_TIMESTAMP | 更新时间 |

**索引：**
- PRIMARY KEY (`id`)
- UNIQUE KEY `ix_agent_task_task_id` (`task_id`)
- INDEX `ix_agent_task_session_id` (`session_id`)
- INDEX `ix_agent_task_parent_task_id` (`parent_task_id`)

**数据量：** 约 1 条记录

---

### 27. chatflow_summary（聊天流摘要表）

**表说明：** 存储聊天流摘要

**字段详情：** （需要查看实际表结构）

**索引：**
- INDEX `ix_chatflow_summary_session_id` (`session_id`)

**数据量：** 约 1 条记录

---

### 28. prompts（提示词表）

**表说明：** 存储提示词信息

**字段详情：** （需要查看实际表结构）

**数据量：** 约 1 条记录

---

### 29. topic_memory（主题记忆表）

**表说明：** 存储主题记忆信息

**字段详情：** （需要查看实际表结构）

**数据量：** 约 1 条记录

---

### 30. alembic_version（数据库迁移版本表）

**表说明：** Alembic数据库迁移版本记录

**字段详情：**

| 字段名 | 类型 | 可空 | 键 | 默认值 | 说明 |
|--------|------|------|-----|--------|------|
| version_num | varchar(32) | NO | PRI | NULL | 版本号 |

**数据量：** 约 1 条记录

---

## 表关系图

### 核心业务数据流

```
ponds (池塘)
  ├── sensors (传感器) ──> sensor_readings (传感器读数)
  ├── devices (设备) ──> feeders_logs (喂食机记录)
  └── batches (批次)
      ├── sensor_readings (传感器读数)
      ├── camera_images (摄像头图像)
      ├── feeders_logs (喂食机记录)
      ├── operations_logs (操作日志)
      └── history_records (历史记录)
```

### 图像检测数据流

```
camera_images (摄像头图像)
  └── shrimp_stats (虾类统计)
      └── frame_id (关联到图像帧)
```

### 设备管理关系

```
device_types (设备类型)
  └── devices (设备)
      ├── sensors (传感器)
      └── feeders (喂食机)
```

---

## 数据统计

### 表数据量统计

| 表名 | 数据量 | 说明 |
|------|--------|------|
| sensor_readings | ~62,069 | 传感器读数（核心数据表，数据量最大） |
| shrimp_stats | ~20 | 虾类统计 |
| camera_images | ~14 | 摄像头图像 |
| camera_status | ~11 | 摄像头状态 |
| camera_health | ~11 | 摄像头健康检查 |
| sensors | ~8 | 传感器设备 |
| sensor_types | ~7 | 传感器类型 |
| devices | ~6 | 设备 |
| ponds | ~4 | 池塘 |
| device_types | ~3 | 设备类型 |
| 其他表 | ~1 | 大部分表为初始化数据 |

### 存储空间统计

- **数据表总大小：** 需要查询 `DATA_LENGTH`
- **索引总大小：** 需要查询 `INDEX_LENGTH`
- **表数量：** 30个表

---

## 索引优化建议

### 高频查询索引

1. **sensor_readings表**
   - ✅ `idx_sr_batch_metric_ts` - 按批次、指标、时间查询
   - ✅ `idx_sensor_id_recorded_at` - 按传感器和时间查询

2. **camera_images表**
   - ✅ `idx_if_batch_ts` - 按批次和时间查询
   - ✅ `idx_timestamp` - 按时间戳查询

3. **shrimp_stats表**
   - ✅ `idx_id_ts` - 按时间查询
   - ✅ `idx_id_modelver` - 按模型版本查询

### 建议添加的索引

1. **sensor_readings表**
   - 考虑添加 `(pool_id, metric, ts_utc)` 复合索引（如果按池号查询频繁）

2. **operations_logs表**
   - 考虑添加 `(pool_id, action_type, ts_utc)` 复合索引

---

## 外键关系

### 已定义的外键

（需要查询 `information_schema.KEY_COLUMN_USAGE` 获取完整外键信息）

### 建议的外键关系

1. `sensor_readings.sensor_id` → `sensors.id`
2. `sensor_readings.batch_id` → `batches.batch_id`
3. `sensors.pond_id` → `ponds.id`
4. `sensors.sensor_type_id` → `sensor_types.id`
5. `devices.device_type_id` → `device_types.id`
6. `devices.pond_id` → `ponds.id`
7. `feeders_logs.feeder_id` → `devices.id`
8. `feeders_logs.batch_id` → `batches.batch_id`
9. `camera_images.batch_id` → `batches.batch_id`
10. `shrimp_stats.frame_id` → `camera_images.id`

---

## 数据完整性

### 约束检查

- ✅ 主键约束：所有表都有主键
- ✅ 唯一约束：关键字段有唯一索引
- ⚠️ 外键约束：部分表缺少外键约束（建议添加）
- ⚠️ 检查约束：部分枚举字段有约束

### 数据质量

- ✅ 时间戳字段：大部分表有 `created_at` 和 `updated_at`
- ✅ 软删除：部分表有 `retired_at` 字段支持软删除
- ✅ 状态字段：关键表有状态字段

---

## 维护建议

### 定期维护任务

1. **数据清理**
   - 定期清理过期的 `sensor_readings` 数据（保留最近N天）
   - 清理过期的 `message_queue` 消息

2. **索引优化**
   - 定期分析表，更新索引统计信息
   - 监控慢查询，优化索引

3. **数据备份**
   - 定期备份核心业务表
   - 备份策略：每日全量备份 + 每小时增量备份

4. **性能监控**
   - 监控 `sensor_readings` 表的增长
   - 监控查询性能

---

## 附录

### 数据库连接信息

- **主机：** rm-0iwx9y9q368yc877wbo.mysql.japan.rds.aliyuncs.com
- **端口：** 3306
- **数据库：** cognitive
- **字符集：** utf8mb3 / utf8mb4

### 相关文档

- [数据处理计划](./01-数据源清单.md)
- [数据收集方式](./02-数据收集方式.md)
- [数据处理标准](./03-数据处理标准.md)
- [ORM模型文档](../japan_server/db_models/)

---

**文档结束**

