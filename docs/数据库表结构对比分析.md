# 数据库表结构对比分析报告

**版本：** v1.0  
**编制日期：** 2025.11.26  
**目标：** 对比现有数据库表结构与数据处理计划，识别需要创建的新表和需要添加字段的现有表

---

## 1. 现有数据库表清单

通过MCP查看，现有数据库包含以下表：

### 1.1 业务核心表
- `devices` - 设备表
- `sensors` - 传感器表
- `sensor_readings` - 传感器读数表
- `ponds` - 池塘表
- `camera_images` - 摄像头图像表
- `camera_status` - 摄像头状态表
- `camera_health` - 摄像头健康表
- `shrimp_stats` - 虾类统计表

### 1.2 系统管理表
- `user` - 用户表
- `session` - 会话表
- `tasks` - 任务表
- `device_types` - 设备类型表
- `sensor_types` - 传感器类型表
- `message_queue` - 消息队列表
- `message_types` - 消息类型表
- 其他系统表...

---

## 2. 计划中的表清单（从DDL文件）

根据数据处理计划，需要以下9个核心表：

1. `batches` - 批次信息
2. `devices` - 设备清单
3. `sensor_readings` - 传感器读数（窄表设计）
4. `feeders_logs` - 喂食机记录
5. `image_frames` - 图像帧与元数据
6. `image_detections` - 图像检测汇总结果
7. `operations_logs` - 操作日志
8. `manuals_docs` - 养殖手册文档
9. `history_records` - 往期养殖记录

---

## 3. 表对比分析

### 3.1 完全缺失的表（需要新建）

#### 3.1.1 batches（批次信息）
**状态：** 完全缺失，需要新建

**计划字段：**
- `batch_id` (PK, BIGINT UNSIGNED AUTO_INCREMENT)
- `species` (VARCHAR(64), 默认'Litopenaeus vannamei')
- `pool_id` (VARCHAR(64), NOT NULL)
- `location` (VARCHAR(128))
- `seed_origin` (VARCHAR(128))
- `stocking_density` (DECIMAL(10,2))
- `start_date` (DATE, NOT NULL)
- `end_date` (DATE)
- `notes` (TEXT)
- `created_at` (TIMESTAMP)
- `updated_at` (TIMESTAMP)

**说明：** 这是核心关联表，所有数据源都需要关联批次。

---

#### 3.1.2 feeders_logs（喂食机记录）
**状态：** 完全缺失，需要新建

**计划字段：**
- `id` (PK, BIGINT UNSIGNED AUTO_INCREMENT)
- `feeder_id` (FK to devices.device_id)
- `batch_id` (FK to batches.batch_id)
- `pool_id` (VARCHAR(64))
- `ts_utc` (DATETIME(3))
- `ts_local` (DATETIME(3))
- `feed_amount_g` (DECIMAL(12,3))
- `run_time_s` (INT)
- `status` (ENUM('ok','warning','error'))
- `leftover_estimate_g` (DECIMAL(12,3))
- `notes` (TEXT)
- `checksum` (VARCHAR(64))
- `created_at` (TIMESTAMP)
- `updated_at` (TIMESTAMP)

**说明：** 用于记录喂食机的运行数据。

---

#### 3.1.3 operations_logs（操作日志）
**状态：** 完全缺失，需要新建

**计划字段：**
- `id` (PK, BIGINT UNSIGNED AUTO_INCREMENT)
- `operator_id` (VARCHAR(64), NOT NULL)
- `batch_id` (FK to batches.batch_id)
- `pool_id` (VARCHAR(64))
- `ts_utc` (DATETIME(3))
- `ts_local` (DATETIME(3))
- `action_type` (VARCHAR(64), NOT NULL)
- `remarks` (TEXT)
- `attachment_uri` (VARCHAR(512))
- `created_at` (TIMESTAMP)
- `updated_at` (TIMESTAMP)

**说明：** 用于记录人工操作日志。

---

#### 3.1.4 manuals_docs（养殖手册文档）
**状态：** 完全缺失，需要新建

**计划字段：**
- `id` (PK, BIGINT UNSIGNED AUTO_INCREMENT)
- `doc_uri` (VARCHAR(512), NOT NULL)
- `version` (VARCHAR(64))
- `source` (VARCHAR(64))
- `created_at` (TIMESTAMP)
- `updated_at` (TIMESTAMP)
- `notes` (TEXT)

**说明：** 用于存储养殖手册文档索引。

---

#### 3.1.5 history_records（往期养殖记录）
**状态：** 完全缺失，需要新建

**计划字段：**
- `id` (PK, BIGINT UNSIGNED AUTO_INCREMENT)
- `batch_id` (FK to batches.batch_id)
- `metric_name` (VARCHAR(64), NOT NULL)
- `value` (VARCHAR(128), NOT NULL)
- `unit` (VARCHAR(16))
- `ts_utc` (DATETIME(3))
- `ts_local` (DATETIME(3))
- `notes` (TEXT)
- `created_at` (TIMESTAMP)
- `updated_at` (TIMESTAMP)

**说明：** 用于存储往期养殖记录的结构化数据。

---

### 3.2 需要对比字段的表

#### 3.2.1 devices（设备表）

**现有表结构：**
- `id` (PK, Integer)
- `device_id` (String(128), unique) - UUID格式
- `name` (String(128))
- `description` (TEXT)
- `ownership` (String(128))
- `device_type_id` (FK to device_types.id)
- `model` (String(128))
- `manufacturer` (String(128))
- `serial_number` (String(128), unique)
- `location` (String(255)) - 对应计划中的install_location
- `pond_id` (FK to ponds.id) - 对应计划中的pool_id
- `firmware_version` (String(64))
- `hardware_version` (String(64))
- `ip_address` (String(45))
- `mac_address` (String(17))
- `config_json` (JSON)
- `tags` (String(255))
- `installed_at` (TIMESTAMP)
- `last_maintenance_at` (TIMESTAMP)
- `next_maintenance_at` (TIMESTAMP)
- `warranty_expires_at` (TIMESTAMP)
- `retired_at` (TIMESTAMP)
- `status` (String(50)) - 对应计划中的status
- `switch_status` (String(50))
- `priority` (String(20))
- `created_at` (TIMESTAMP)
- `updated_at` (TIMESTAMP)

**计划表结构：**
- `device_id` (PK, BIGINT UNSIGNED AUTO_INCREMENT) - **主键类型不同**
- `type` (ENUM('sensor','camera','feeder'), NOT NULL) - **缺失，需要通过device_type_id关联**
- `model` (VARCHAR(128)) - **已有**
- `install_location` (VARCHAR(128)) - **已有location字段**
- `pool_id` (VARCHAR(64)) - **已有pond_id字段**
- `status` (ENUM('active','inactive','maintenance','fault')) - **已有但类型不同**
- `vendor` (VARCHAR(128)) - **缺失，可用manufacturer替代**
- `calibration_info` (TEXT) - **缺失**
- `created_at` (TIMESTAMP) - **已有**
- `updated_at` (TIMESTAMP) - **已有**

**需要添加的字段：**
1. `type` - ENUM('sensor','camera','feeder') - 可通过device_type_id映射或添加
2. `vendor` - VARCHAR(128) - 可用manufacturer字段，或添加新字段
3. `calibration_info` - TEXT - 校准信息

**字段映射关系：**
- `device_id` (现有UUID) → 需要映射到新的BIGINT主键（可能需要映射表）
- `location` → `install_location`
- `pond_id` (现有INT FK) → `pool_id` (计划VARCHAR(64))
- `manufacturer` → `vendor` (或添加vendor字段)

**注意事项：**
- 现有表使用UUID作为device_id，计划表使用BIGINT自增主键
- 现有表有更丰富的字段（如IP地址、MAC地址、配置JSON等）
- 需要保持现有数据不变，可能需要创建映射关系

---

#### 3.2.2 sensor_readings（传感器读数表）

**现有表结构：**
- `id` (PK, Integer)
- `sensor_id` (FK to sensors.id, Integer)
- `value` (Float)
- `recorded_at` (TIMESTAMP)

**计划表结构（窄表设计）：**
- `id` (PK, BIGINT UNSIGNED AUTO_INCREMENT)
- `device_id` (FK to devices.device_id, BIGINT UNSIGNED) - **现有是sensor_id**
- `batch_id` (FK to batches.batch_id) - **缺失**
- `pool_id` (VARCHAR(64)) - **缺失**
- `ts_utc` (DATETIME(3)) - **现有是recorded_at**
- `ts_local` (DATETIME(3)) - **缺失**
- `metric` (VARCHAR(32), NOT NULL) - **缺失，需要通过sensor关联sensor_type获取**
- `value` (DOUBLE) - **已有**
- `unit` (VARCHAR(16)) - **缺失，需要通过sensor关联sensor_type获取**
- `quality_flag` (ENUM('ok','missing','anomaly')) - **缺失**
- `checksum` (VARCHAR(64)) - **缺失**
- `created_at` (TIMESTAMP) - **缺失**
- `updated_at` (TIMESTAMP) - **缺失**

**需要添加的字段：**
1. `batch_id` - BIGINT UNSIGNED NULL (FK to batches.batch_id)
2. `pool_id` - VARCHAR(64) NULL - 可通过sensor关联pond获取
3. `ts_local` - DATETIME(3) NULL - 日本时区时间戳
4. `metric` - VARCHAR(32) NOT NULL - 指标名称（可通过sensor_type.type_name获取）
5. `unit` - VARCHAR(16) NULL - 单位（可通过sensor_type.unit获取）
6. `quality_flag` - ENUM('ok','missing','anomaly') NOT NULL DEFAULT 'ok'
7. `checksum` - VARCHAR(64) NULL
8. `created_at` - TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
9. `updated_at` - TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP

**字段映射关系：**
- `sensor_id` → `device_id` (需要映射sensors.id到devices.device_id)
- `recorded_at` → `ts_utc` (需要转换格式为DATETIME(3))
- `metric` 和 `unit` 需要通过JOIN sensors和sensor_types表获取

**注意事项：**
- 现有表是宽表设计（每个传感器一条记录），计划表是窄表设计（每个指标一条记录）
- 需要将现有数据转换为窄表格式
- 现有表通过sensor_id关联sensors表，计划表通过device_id关联devices表

---

#### 3.2.3 image_frames（图像帧与元数据）

**对应现有表：** `camera_images`

**现有表结构（camera_images）：**
- `id` (PK, Integer)
- `camera_id` (Integer)
- `name` (String(255))
- `location` (String(255))
- `status` (String(50))
- `image_url` (String(500)) - 对应计划中的storage_uri
- `last_update` (BIGINT) - 毫秒时间戳
- `timestamp` (BIGINT) - 毫秒时间戳
- `created_at` (TIMESTAMP)
- `updated_at` (TIMESTAMP)
- `timestamp_str` (String(50))
- `width` (Integer, default=1920) - 对应计划中的width_px
- `height` (Integer, default=1080) - 对应计划中的height_px
- `format` (String(20), default='jpg') - **已有**
- `size` (Integer, default=0)
- `fps` (Integer, default=0)

**计划表结构：**
- `id` (PK, BIGINT UNSIGNED AUTO_INCREMENT)
- `camera_id` (FK to devices.device_id, BIGINT UNSIGNED) - **现有是Integer**
- `batch_id` (FK to batches.batch_id) - **缺失**
- `pool_id` (VARCHAR(64)) - **缺失**
- `ts_utc` (DATETIME(3)) - **现有是timestamp (BIGINT)**
- `ts_local` (DATETIME(3)) - **缺失**
- `storage_uri` (VARCHAR(512), NOT NULL) - **现有是image_url**
- `width_px` (INT) - **现有是width**
- `height_px` (INT) - **现有是height**
- `format` (VARCHAR(16)) - **已有**
- `codec` (VARCHAR(32)) - **缺失（视频编解码）**
- `quality_flag` (ENUM('ok','missing','anomaly')) - **缺失**
- `checksum` (VARCHAR(64)) - **缺失**
- `created_at` (TIMESTAMP) - **已有**
- `updated_at` (TIMESTAMP) - **已有**

**需要添加的字段：**
1. `batch_id` - BIGINT UNSIGNED NULL (FK to batches.batch_id)
2. `pool_id` - VARCHAR(64) NULL
3. `ts_local` - DATETIME(3) NULL
4. `codec` - VARCHAR(32) NULL - 视频编解码
5. `quality_flag` - ENUM('ok','missing','anomaly') NOT NULL DEFAULT 'ok'
6. `checksum` - VARCHAR(64) NULL

**字段映射关系：**
- `image_url` → `storage_uri`
- `width` → `width_px`
- `height` → `height_px`
- `timestamp` (BIGINT毫秒) → `ts_utc` (DATETIME(3))
- `camera_id` (Integer) → 需要映射到devices.device_id

**注意事项：**
- 现有表有name、location、status等冗余字段（这些信息应该在devices表中）
- 时间戳格式需要转换（BIGINT毫秒 → DATETIME(3)）

---

#### 3.2.4 image_detections（图像检测汇总结果）

**对应现有表：** `shrimp_stats`

**现有表结构（shrimp_stats）：**
- `id` (PK, BIGINT)
- `uuid` (String(36))
- `pond_id` (String(255))
- `input_subdir` (String(255))
- `output_dir` (String(512))
- `created_at_source_iso` (String(64))
- `created_at_source` (TIMESTAMP)
- `conf` (Float) - 对应计划中的confidence_avg
- `iou` (Float)
- `total_live` (Integer) - 对应计划中的count
- `total_dead` (Integer)
- `size_min_cm` (Float)
- `size_max_cm` (Float)
- `size_mean_cm` (Float) - 对应计划中的avg_length_mm（需要单位转换）
- `size_median_cm` (Float)
- `weight_min_g` (Float)
- `weight_max_g` (Float)
- `weight_mean_g` (Float) - 对应计划中的est_weight_g_avg
- `weight_median_g` (Float)
- `source_file` (String(512))
- `created_at` (TIMESTAMP)
- `updated_at` (TIMESTAMP)

**计划表结构：**
- `id` (PK, BIGINT UNSIGNED AUTO_INCREMENT)
- `frame_id` (FK to image_frames.id) - **缺失，需要关联image_frames**
- `ts_utc` (DATETIME(3)) - **现有是created_at_source**
- `count` (INT, NOT NULL) - **现有是total_live**
- `avg_length_mm` (DECIMAL(12,3)) - **现有是size_mean_cm（需要单位转换）**
- `avg_height_mm` (DECIMAL(12,3)) - **缺失**
- `est_weight_g_avg` (DECIMAL(12,3)) - **现有是weight_mean_g**
- `feed_present` (TINYINT(1)) - **缺失**
- `shrimp_shell_present` (TINYINT(1)) - **缺失**
- `model_name` (VARCHAR(128)) - **缺失**
- `model_version` (VARCHAR(64)) - **缺失**
- `confidence_avg` (DECIMAL(5,4)) - **现有是conf**
- `notes` (TEXT) - **缺失**
- `created_at` (TIMESTAMP) - **已有**
- `updated_at` (TIMESTAMP) - **已有**

**需要添加的字段：**
1. `frame_id` - BIGINT UNSIGNED NOT NULL (FK to image_frames.id) - **关键字段**
2. `avg_height_mm` - DECIMAL(12,3) NULL
3. `feed_present` - TINYINT(1) NOT NULL DEFAULT 0
4. `shrimp_shell_present` - TINYINT(1) NOT NULL DEFAULT 0
5. `model_name` - VARCHAR(128) NULL
6. `model_version` - VARCHAR(64) NULL
7. `notes` - TEXT NULL

**字段映射关系：**
- `total_live` → `count`
- `size_mean_cm` → `avg_length_mm` (需要单位转换：cm × 10 = mm)
- `weight_mean_g` → `est_weight_g_avg`
- `conf` → `confidence_avg` (需要精度转换)
- `created_at_source` → `ts_utc`
- `pond_id` → 需要通过frame_id关联image_frames获取pool_id

**注意事项：**
- 现有表缺少frame_id，需要建立与image_frames的关联
- 现有表有更多统计字段（min/max/median），计划表只保留平均值
- 需要单位转换（cm → mm）

---

### 3.3 表映射关系总结

| 计划表名 | 现有表名 | 关系 | 说明 |
|---------|---------|------|------|
| batches | - | 新建 | 完全缺失 |
| devices | devices | 扩展 | 需要添加字段 |
| sensor_readings | sensor_readings | 扩展 | 需要添加字段，窄表设计 |
| feeders_logs | - | 新建 | 完全缺失 |
| image_frames | camera_images | 扩展 | 需要添加字段 |
| image_detections | shrimp_stats | 扩展 | 需要添加字段，需要关联image_frames |
| operations_logs | - | 新建 | 完全缺失 |
| manuals_docs | - | 新建 | 完全缺失 |
| history_records | - | 新建 | 完全缺失 |

---

## 4. 需要创建的新表DDL

### 4.1 batches表

```sql
CREATE TABLE IF NOT EXISTS batches (
  batch_id           BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT COMMENT '批次ID（主键）',
  species            VARCHAR(64) NOT NULL DEFAULT 'Litopenaeus vannamei' COMMENT '物种（默认南美白对虾学名）',
  pool_id            VARCHAR(64) NOT NULL COMMENT '池号/分区标识',
  location           VARCHAR(128) NULL COMMENT '场地/车间位置',
  seed_origin        VARCHAR(128) NULL COMMENT '苗种来源',
  stocking_density   DECIMAL(10,2) NULL COMMENT '放养密度（尾/㎡或尾/m³）',
  start_date         DATE NOT NULL COMMENT '开始日期',
  end_date           DATE NULL COMMENT '结束日期（可空）',
  notes              TEXT NULL COMMENT '备注',
  created_at         TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_at         TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间'
) COMMENT='养殖批次信息';

CREATE INDEX idx_batches_pool_dates ON batches (pool_id, start_date, end_date);
```

### 4.2 feeders_logs表

```sql
CREATE TABLE IF NOT EXISTS feeders_logs (
  id                 BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
  feeder_id          BIGINT UNSIGNED NOT NULL COMMENT '喂食机设备ID（FK）',
  batch_id           BIGINT UNSIGNED NULL COMMENT '批次ID（FK）',
  pool_id            VARCHAR(64) NULL COMMENT '池号/分区（冗余）',
  ts_utc             DATETIME(3) NOT NULL COMMENT 'UTC时间戳',
  ts_local           DATETIME(3) NULL COMMENT '本地时间戳',
  feed_amount_g      DECIMAL(12,3) NULL COMMENT '投喂量（克）',
  run_time_s         INT NULL COMMENT '运行时长（秒）',
  status             ENUM('ok','warning','error') NOT NULL DEFAULT 'ok' COMMENT '状态',
  leftover_estimate_g DECIMAL(12,3) NULL COMMENT '剩余饵料估计（克）',
  notes              TEXT NULL COMMENT '备注',
  checksum           VARCHAR(64) NULL COMMENT '完整性校验',
  created_at         TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_at         TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  CONSTRAINT fk_fl_feeder FOREIGN KEY (feeder_id) REFERENCES devices(device_id),
  CONSTRAINT fk_fl_batch  FOREIGN KEY (batch_id)  REFERENCES batches(batch_id)
) COMMENT='喂食机运行记录';

CREATE INDEX idx_fl_feeder_ts ON feeders_logs (feeder_id, ts_utc);
CREATE INDEX idx_fl_batch_ts   ON feeders_logs (batch_id, ts_utc);
```

### 4.3 operations_logs表

```sql
CREATE TABLE IF NOT EXISTS operations_logs (
  id                 BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
  operator_id        VARCHAR(64) NOT NULL COMMENT '操作人',
  batch_id           BIGINT UNSIGNED NULL COMMENT '批次ID（FK）',
  pool_id            VARCHAR(64) NULL COMMENT '池号/分区',
  ts_utc             DATETIME(3) NOT NULL COMMENT 'UTC时间戳',
  ts_local           DATETIME(3) NULL COMMENT '本地时间戳',
  action_type        VARCHAR(64) NOT NULL COMMENT '操作类型（投料/水质调控/巡检/清洗等）',
  remarks            TEXT NULL COMMENT '备注',
  attachment_uri     VARCHAR(512) NULL COMMENT '附件URI',
  created_at         TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_at         TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  CONSTRAINT fk_ol_batch FOREIGN KEY (batch_id) REFERENCES batches(batch_id)
) COMMENT='人工操作日志';

CREATE INDEX idx_ol_operator_ts ON operations_logs (operator_id, ts_utc);
CREATE INDEX idx_ol_batch_ts    ON operations_logs (batch_id, ts_utc);
```

### 4.4 manuals_docs表

```sql
CREATE TABLE IF NOT EXISTS manuals_docs (
  id                 BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
  doc_uri            VARCHAR(512) NOT NULL COMMENT '文档URI',
  version            VARCHAR(64) NULL COMMENT '版本',
  source             VARCHAR(64) NULL COMMENT '来源',
  created_at         TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_at         TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  notes              TEXT NULL COMMENT '备注'
) COMMENT='养殖手册/文档索引';

CREATE INDEX idx_md_version ON manuals_docs (version);
CREATE INDEX idx_md_created ON manuals_docs (created_at);
```

### 4.5 history_records表

```sql
CREATE TABLE IF NOT EXISTS history_records (
  id                 BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
  batch_id           BIGINT UNSIGNED NULL COMMENT '批次ID（FK）',
  metric_name        VARCHAR(64) NOT NULL COMMENT '指标名称',
  value              VARCHAR(128) NOT NULL COMMENT '值（文本存储）',
  unit               VARCHAR(16) NULL COMMENT '单位',
  ts_utc             DATETIME(3) NULL COMMENT 'UTC时间戳',
  ts_local           DATETIME(3) NULL COMMENT '本地时间戳',
  notes              TEXT NULL COMMENT '备注',
  created_at         TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_at         TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  CONSTRAINT fk_hr_batch FOREIGN KEY (batch_id) REFERENCES batches(batch_id)
) COMMENT='往期养殖记录（结构化）';

CREATE INDEX idx_hr_batch_metric_ts ON history_records (batch_id, metric_name, ts_utc);
```

---

## 5. 需要添加字段的现有表ALTER语句

### 5.1 devices表

```sql
-- 添加type字段（设备类型枚举）
ALTER TABLE devices 
ADD COLUMN type ENUM('sensor','camera','feeder') NULL COMMENT '设备类型' AFTER device_id;

-- 添加vendor字段（供应商，如果manufacturer字段不适用）
ALTER TABLE devices 
ADD COLUMN vendor VARCHAR(128) NULL COMMENT '供应商' AFTER model;

-- 或者使用manufacturer字段映射到vendor（如果manufacturer字段可用）
-- 注意：如果manufacturer字段已存在且可用，可以不用添加vendor字段

-- 添加calibration_info字段（校准信息）
ALTER TABLE devices 
ADD COLUMN calibration_info TEXT NULL COMMENT '校准信息' AFTER vendor;

-- 添加索引（如果计划需要）
-- CREATE INDEX idx_devices_type_pool ON devices (type, pool_id);
-- 注意：现有表使用pond_id，计划表使用pool_id，需要确认映射关系
```

**注意事项：**
- `type`字段可以通过`device_type_id`关联`device_types`表获取，或直接添加枚举字段
- `vendor`字段如果`manufacturer`字段可用，可以不用添加
- `pool_id`字段现有表使用`pond_id`（INT FK），计划表使用`pool_id`（VARCHAR(64)），需要确认是否添加新字段或使用现有字段

---

### 5.2 sensor_readings表

```sql
-- 添加batch_id字段（批次ID）
ALTER TABLE sensor_readings 
ADD COLUMN batch_id BIGINT UNSIGNED NULL COMMENT '批次ID（FK）' AFTER sensor_id;

-- 添加pool_id字段（池号/分区）
ALTER TABLE sensor_readings 
ADD COLUMN pool_id VARCHAR(64) NULL COMMENT '池号/分区（冗余便于查询）' AFTER batch_id;

-- 添加ts_local字段（本地时间戳）
ALTER TABLE sensor_readings 
ADD COLUMN ts_local DATETIME(3) NULL COMMENT '本地时间戳（日本时区）' AFTER recorded_at;

-- 添加metric字段（指标名称）
ALTER TABLE sensor_readings 
ADD COLUMN metric VARCHAR(32) NULL COMMENT '指标，如 do/ph/temp/salinity/conductivity 等' AFTER ts_local;

-- 添加unit字段（计量单位）
ALTER TABLE sensor_readings 
ADD COLUMN unit VARCHAR(16) NULL COMMENT '计量单位' AFTER metric;

-- 添加quality_flag字段（质量标记）
ALTER TABLE sensor_readings 
ADD COLUMN quality_flag ENUM('ok','missing','anomaly') NOT NULL DEFAULT 'ok' COMMENT '质量标记' AFTER unit;

-- 添加checksum字段（完整性校验）
ALTER TABLE sensor_readings 
ADD COLUMN checksum VARCHAR(64) NULL COMMENT '完整性校验' AFTER quality_flag;

-- 添加created_at字段
ALTER TABLE sensor_readings 
ADD COLUMN created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间' AFTER checksum;

-- 添加updated_at字段
ALTER TABLE sensor_readings 
ADD COLUMN updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间' AFTER created_at;

-- 重命名recorded_at为ts_utc（可选，如果不想重命名可以保留两个字段）
-- ALTER TABLE sensor_readings CHANGE recorded_at ts_utc DATETIME(3) NOT NULL COMMENT 'UTC时间戳（毫秒）';

-- 或者添加ts_utc字段，保留recorded_at字段
ALTER TABLE sensor_readings 
ADD COLUMN ts_utc DATETIME(3) NULL COMMENT 'UTC时间戳（毫秒）' AFTER recorded_at;

-- 添加外键约束（如果batches表已创建）
-- ALTER TABLE sensor_readings 
-- ADD CONSTRAINT fk_sr_batch FOREIGN KEY (batch_id) REFERENCES batches(batch_id);

-- 添加索引
CREATE INDEX idx_sr_batch_metric_ts ON sensor_readings (batch_id, metric, ts_utc);
```

**数据迁移说明：**
- `metric`和`unit`字段需要通过JOIN `sensors`和`sensor_types`表获取数据
- `ts_utc`可以从`recorded_at`转换而来
- `ts_local`需要从`ts_utc`转换到日本时区
- `pool_id`可以通过`sensor_id`关联`sensors`表获取`pond_id`，然后转换为VARCHAR格式

---

### 5.3 camera_images表（对应image_frames）

```sql
-- 添加batch_id字段（批次ID）
ALTER TABLE camera_images 
ADD COLUMN batch_id BIGINT UNSIGNED NULL COMMENT '批次ID（FK）' AFTER camera_id;

-- 添加pool_id字段（池号/分区）
ALTER TABLE camera_images 
ADD COLUMN pool_id VARCHAR(64) NULL COMMENT '池号/分区（冗余）' AFTER batch_id;

-- 添加ts_utc字段（UTC时间戳）
ALTER TABLE camera_images 
ADD COLUMN ts_utc DATETIME(3) NULL COMMENT 'UTC时间戳' AFTER timestamp;

-- 添加ts_local字段（本地时间戳）
ALTER TABLE camera_images 
ADD COLUMN ts_local DATETIME(3) NULL COMMENT '本地时间戳（日本时区）' AFTER ts_utc;

-- 添加codec字段（视频编解码）
ALTER TABLE camera_images 
ADD COLUMN codec VARCHAR(32) NULL COMMENT '编解码（视频）' AFTER format;

-- 添加quality_flag字段（质量标记）
ALTER TABLE camera_images 
ADD COLUMN quality_flag ENUM('ok','missing','anomaly') NOT NULL DEFAULT 'ok' COMMENT '质量标记' AFTER codec;

-- 添加checksum字段（完整性校验）
ALTER TABLE camera_images 
ADD COLUMN checksum VARCHAR(64) NULL COMMENT '完整性校验' AFTER quality_flag;

-- 重命名字段（可选）
-- ALTER TABLE camera_images CHANGE image_url storage_uri VARCHAR(512) NOT NULL COMMENT '对象存储路径/URI';
-- ALTER TABLE camera_images CHANGE width width_px INT NULL COMMENT '宽度像素';
-- ALTER TABLE camera_images CHANGE height height_px INT NULL COMMENT '高度像素';

-- 或者添加新字段，保留旧字段
ALTER TABLE camera_images 
ADD COLUMN storage_uri VARCHAR(512) NULL COMMENT '对象存储路径/URI' AFTER image_url;

-- 添加外键约束（如果batches表已创建）
-- ALTER TABLE camera_images 
-- ADD CONSTRAINT fk_if_batch FOREIGN KEY (batch_id) REFERENCES batches(batch_id);

-- 添加索引
CREATE INDEX idx_if_batch_ts ON camera_images (batch_id, ts_utc);
```

**数据迁移说明：**
- `ts_utc`需要从`timestamp`（BIGINT毫秒）转换为DATETIME(3)格式
- `ts_local`需要从`ts_utc`转换到日本时区
- `storage_uri`可以从`image_url`复制
- `width_px`和`height_px`可以从`width`和`height`复制

---

### 5.4 shrimp_stats表（对应image_detections）

```sql
-- 添加frame_id字段（图像帧ID，关键字段）
ALTER TABLE shrimp_stats 
ADD COLUMN frame_id BIGINT UNSIGNED NULL COMMENT '图像帧ID（FK）' AFTER id;

-- 添加ts_utc字段（UTC时间戳）
ALTER TABLE shrimp_stats 
ADD COLUMN ts_utc DATETIME(3) NULL COMMENT 'UTC时间戳（推理）' AFTER frame_id;

-- 添加avg_height_mm字段（平均高度，毫米）
ALTER TABLE shrimp_stats 
ADD COLUMN avg_height_mm DECIMAL(12,3) NULL COMMENT '平均高度（毫米）' AFTER size_mean_cm;

-- 添加feed_present字段（是否存在饲料）
ALTER TABLE shrimp_stats 
ADD COLUMN feed_present TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否存在饲料（布尔）' AFTER weight_mean_g;

-- 添加shrimp_shell_present字段（是否存在虾皮）
ALTER TABLE shrimp_stats 
ADD COLUMN shrimp_shell_present TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否存在虾皮（布尔）' AFTER feed_present;

-- 添加model_name字段（模型名称）
ALTER TABLE shrimp_stats 
ADD COLUMN model_name VARCHAR(128) NULL COMMENT '模型名称' AFTER shrimp_shell_present;

-- 添加model_version字段（模型版本）
ALTER TABLE shrimp_stats 
ADD COLUMN model_version VARCHAR(64) NULL COMMENT '模型版本' AFTER model_name;

-- 添加notes字段（备注）
ALTER TABLE shrimp_stats 
ADD COLUMN notes TEXT NULL COMMENT '备注' AFTER confidence_avg;

-- 添加字段用于存储计划表中的字段（如果需要保留现有字段）
ALTER TABLE shrimp_stats 
ADD COLUMN count INT NULL COMMENT '检测数量' AFTER total_live;
ALTER TABLE shrimp_stats 
ADD COLUMN avg_length_mm DECIMAL(12,3) NULL COMMENT '平均长度（毫米）' AFTER size_mean_cm;
ALTER TABLE shrimp_stats 
ADD COLUMN est_weight_g_avg DECIMAL(12,3) NULL COMMENT '平均估算体重（克）' AFTER weight_mean_g;
ALTER TABLE shrimp_stats 
ADD COLUMN confidence_avg DECIMAL(5,4) NULL COMMENT '平均置信度' AFTER conf;

-- 添加外键约束（如果image_frames表已创建或对应camera_images表）
-- ALTER TABLE shrimp_stats 
-- ADD CONSTRAINT fk_id_frame FOREIGN KEY (frame_id) REFERENCES image_frames(id);
-- 或者如果使用camera_images表：
-- ALTER TABLE shrimp_stats 
-- ADD CONSTRAINT fk_id_frame FOREIGN KEY (frame_id) REFERENCES camera_images(id);

-- 添加索引
CREATE INDEX idx_id_frame ON shrimp_stats (frame_id);
CREATE INDEX idx_id_ts ON shrimp_stats (ts_utc);
CREATE INDEX idx_id_modelver ON shrimp_stats (model_name, model_version);
```

**数据迁移说明：**
- `frame_id`需要建立与`camera_images`或`image_frames`的关联关系（可能需要通过时间戳或其他方式匹配）
- `count`可以从`total_live`复制
- `avg_length_mm`需要从`size_mean_cm`转换（cm × 10 = mm）
- `est_weight_g_avg`可以从`weight_mean_g`复制
- `confidence_avg`需要从`conf`转换（精度调整）
- `ts_utc`可以从`created_at_source`转换

---

## 6. 字段映射关系说明

### 6.1 devices表字段映射

| 计划字段 | 现有字段 | 映射方式 | 说明 |
|---------|---------|---------|------|
| device_id (BIGINT) | device_id (String UUID) | 需要映射表 | 主键类型不同 |
| type | device_type_id | 通过JOIN获取或添加字段 | 需要枚举值 |
| model | model | 直接使用 | 已有 |
| install_location | location | 直接使用 | 已有 |
| pool_id (VARCHAR) | pond_id (INT FK) | 需要转换 | 类型不同 |
| status | status | 需要转换ENUM | 类型不同 |
| vendor | manufacturer | 直接使用或添加字段 | 可选 |
| calibration_info | - | 添加字段 | 缺失 |

### 6.2 sensor_readings表字段映射

| 计划字段 | 现有字段 | 映射方式 | 说明 |
|---------|---------|---------|------|
| device_id | sensor_id | 通过映射表 | 需要sensors→devices映射 |
| batch_id | - | 添加字段 | 缺失 |
| pool_id | - | 通过sensor关联pond获取 | 缺失 |
| ts_utc | recorded_at | 格式转换 | DATETIME(3) |
| ts_local | - | 从ts_utc转换 | 缺失 |
| metric | - | 通过sensor_type.type_name获取 | 缺失 |
| value | value | 直接使用 | 已有 |
| unit | - | 通过sensor_type.unit获取 | 缺失 |
| quality_flag | - | 添加字段 | 缺失 |
| checksum | - | 添加字段 | 缺失 |

### 6.3 camera_images表字段映射

| 计划字段 | 现有字段 | 映射方式 | 说明 |
|---------|---------|---------|------|
| camera_id | camera_id | 需要映射到devices | 类型可能不同 |
| batch_id | - | 添加字段 | 缺失 |
| pool_id | - | 添加字段 | 缺失 |
| ts_utc | timestamp (BIGINT) | 格式转换 | 毫秒→DATETIME(3) |
| ts_local | - | 从ts_utc转换 | 缺失 |
| storage_uri | image_url | 直接使用或重命名 | 已有 |
| width_px | width | 直接使用或重命名 | 已有 |
| height_px | height | 直接使用或重命名 | 已有 |
| format | format | 直接使用 | 已有 |
| codec | - | 添加字段 | 缺失 |
| quality_flag | - | 添加字段 | 缺失 |
| checksum | - | 添加字段 | 缺失 |

### 6.4 shrimp_stats表字段映射

| 计划字段 | 现有字段 | 映射方式 | 说明 |
|---------|---------|---------|------|
| frame_id | - | 建立关联 | 关键缺失字段 |
| ts_utc | created_at_source | 格式转换 | DATETIME(3) |
| count | total_live | 直接使用 | 已有 |
| avg_length_mm | size_mean_cm | 单位转换 | cm × 10 = mm |
| avg_height_mm | - | 添加字段 | 缺失 |
| est_weight_g_avg | weight_mean_g | 直接使用 | 已有 |
| feed_present | - | 添加字段 | 缺失 |
| shrimp_shell_present | - | 添加字段 | 缺失 |
| model_name | - | 添加字段 | 缺失 |
| model_version | - | 添加字段 | 缺失 |
| confidence_avg | conf | 精度转换 | DECIMAL(5,4) |

---

## 7. 数据迁移建议

### 7.1 批次数据迁移

**问题：** 现有数据没有批次概念，需要创建初始批次。

**建议：**
1. 为每个pond创建一个默认批次
2. 或者根据时间范围创建批次
3. 或者让用户手动创建批次并关联现有数据

### 7.2 sensor_readings数据迁移

**问题：** 
- 现有表是宽表设计，计划表是窄表设计
- 需要添加metric和unit字段
- 需要建立device_id映射

**建议：**
1. 通过JOIN sensors和sensor_types表获取metric和unit
2. 建立sensors.id到devices.device_id的映射表
3. 将现有数据转换为窄表格式（每个指标一条记录）

### 7.3 camera_images数据迁移

**问题：**
- 时间戳格式转换（BIGINT毫秒 → DATETIME(3)）
- 需要建立与batches的关联

**建议：**
1. 转换timestamp字段为ts_utc
2. 根据时间范围或pond_id创建批次关联

### 7.4 shrimp_stats数据迁移

**问题：**
- 缺少frame_id关联
- 需要单位转换（cm → mm）

**建议：**
1. 通过时间戳或其他方式匹配camera_images记录建立frame_id关联
2. 转换size_mean_cm为avg_length_mm（×10）

---

## 8. 执行顺序建议

### 第一阶段：创建新表
1. 创建`batches`表
2. 创建`feeders_logs`表
3. 创建`operations_logs`表
4. 创建`manuals_docs`表
5. 创建`history_records`表

### 第二阶段：扩展现有表
1. 为`devices`表添加字段
2. 为`sensor_readings`表添加字段
3. 为`camera_images`表添加字段
4. 为`shrimp_stats`表添加字段

### 第三阶段：数据迁移
1. 创建初始批次数据
2. 迁移sensor_readings数据
3. 迁移camera_images数据
4. 迁移shrimp_stats数据

### 第四阶段：建立关联
1. 建立外键约束
2. 建立索引
3. 验证数据完整性

---

## 9. 注意事项

### 9.1 数据兼容性
- 保持现有数据不变
- 新字段设置为NULL或默认值
- 逐步迁移数据，不一次性删除旧字段

### 9.2 外键约束
- 在数据迁移完成后再添加外键约束
- 确保关联数据存在

### 9.3 索引优化
- 根据查询模式添加索引
- 避免过度索引影响写入性能

### 9.4 字段命名
- 保持现有字段名称不变
- 新字段遵循计划命名规范
- 如需重命名，先添加新字段，迁移数据后再删除旧字段

---

## 10. 待确认事项

### 10.1 设备ID映射
- [ ] devices表的device_id（UUID）如何映射到计划中的BIGINT主键？
- [ ] 是否需要创建device_id映射表？
- [ ] 还是直接修改devices表的主键类型？

### 10.2 批次创建策略
- [ ] 如何为现有数据创建批次？
- [ ] 是否每个pond创建一个默认批次？
- [ ] 还是根据时间范围创建批次？

### 10.3 字段重命名
- [ ] camera_images表的image_url是否需要重命名为storage_uri？
- [ ] width/height是否需要重命名为width_px/height_px？
- [ ] sensor_readings表的recorded_at是否需要重命名为ts_utc？

### 10.4 数据迁移
- [ ] sensor_readings是否需要从宽表转换为窄表？
- [ ] 还是保留现有结构，只添加新字段？
- [ ] shrimp_stats的frame_id如何建立关联？

---

**文档状态：** 待确认  
**最后更新：** 2025.11.26

