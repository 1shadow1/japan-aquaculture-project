# æ—¥æœ¬é™†ä¸Šå…»æ®–é¡¹ç›®æœåŠ¡å™¨ç«¯æ”¹è¿›å®æ–½æ€»ç»“

**å®æ–½æ—¥æœŸï¼š** 2025-01-XX  
**å®æ–½å†…å®¹ï¼š** æ ¹æ®æ•°æ®å¤„ç†è®¡åˆ’è¦æ±‚ï¼Œæ›´æ–°ORMæ¨¡å‹å¹¶åˆ›å»ºæ•°æ®æ”¶é›†åŠŸèƒ½

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. ORMæ¨¡å‹æ›´æ–°

#### 1.1 æ›´æ–°ç°æœ‰æ¨¡å‹

**SensorReading æ¨¡å‹** âœ…
- æ·»åŠ äº† `batch_id`ï¼ˆæ‰¹æ¬¡IDï¼‰
- æ·»åŠ äº† `pool_id`ï¼ˆæ± å·/åˆ†åŒºï¼‰
- æ·»åŠ äº† `ts_utc`ï¼ˆUTCæ—¶é—´æˆ³ï¼Œæ¯«ç§’ç²¾åº¦ï¼‰
- æ·»åŠ äº† `ts_local`ï¼ˆæœ¬åœ°æ—¶é—´æˆ³ï¼Œæ—¥æœ¬æ—¶åŒºï¼‰
- æ·»åŠ äº† `metric`ï¼ˆæŒ‡æ ‡åç§°ï¼‰
- æ·»åŠ äº† `type_name`ï¼ˆç±»å‹åç§°ï¼‰
- æ·»åŠ äº† `description`ï¼ˆæè¿°ï¼‰
- æ·»åŠ äº† `unit`ï¼ˆè®¡é‡å•ä½ï¼‰
- æ·»åŠ äº† `quality_flag`ï¼ˆè´¨é‡æ ‡è®°ï¼šok/missing/anomalyï¼‰
- æ·»åŠ äº† `checksum`ï¼ˆå®Œæ•´æ€§æ ¡éªŒï¼‰
- æ·»åŠ äº† `created_at` å’Œ `updated_at`ï¼ˆæ—¶é—´æˆ³ï¼‰

**CameraImage æ¨¡å‹** âœ…
- æ·»åŠ äº† `batch_id`ï¼ˆæ‰¹æ¬¡IDï¼‰
- æ·»åŠ äº† `pool_id`ï¼ˆæ± å·/åˆ†åŒºï¼‰
- æ·»åŠ äº† `ts_utc`ï¼ˆUTCæ—¶é—´æˆ³ï¼‰
- æ·»åŠ äº† `ts_local`ï¼ˆæœ¬åœ°æ—¶é—´æˆ³ï¼‰
- æ·»åŠ äº† `storage_uri`ï¼ˆå¯¹è±¡å­˜å‚¨è·¯å¾„/URIï¼‰
- æ·»åŠ äº† `width_px` å’Œ `height_px`ï¼ˆåƒç´ å°ºå¯¸ï¼‰
- æ·»åŠ äº† `codec`ï¼ˆç¼–è§£ç ï¼Œè§†é¢‘ï¼‰
- æ·»åŠ äº† `quality_flag`ï¼ˆè´¨é‡æ ‡è®°ï¼‰
- æ·»åŠ äº† `checksum`ï¼ˆå®Œæ•´æ€§æ ¡éªŒï¼‰

**ShrimpStats æ¨¡å‹** âœ…
- æ·»åŠ äº† `frame_id`ï¼ˆå›¾åƒå¸§IDï¼‰
- æ·»åŠ äº† `ts_utc`ï¼ˆUTCæ—¶é—´æˆ³ï¼‰
- æ·»åŠ äº† `count`ï¼ˆæ£€æµ‹æ•°é‡ï¼‰
- æ·»åŠ äº† `avg_length_mm`ï¼ˆå¹³å‡é•¿åº¦ï¼Œæ¯«ç±³ï¼‰
- æ·»åŠ äº† `avg_height_mm`ï¼ˆå¹³å‡é«˜åº¦ï¼Œæ¯«ç±³ï¼‰
- æ·»åŠ äº† `est_weight_g_avg`ï¼ˆå¹³å‡ä¼°ç®—ä½“é‡ï¼Œå…‹ï¼‰
- æ·»åŠ äº† `feed_present`ï¼ˆæ˜¯å¦å­˜åœ¨é¥²æ–™ï¼Œå¸ƒå°”ï¼‰
- æ·»åŠ äº† `shrimp_shell_present`ï¼ˆæ˜¯å¦å­˜åœ¨è™¾çš®ï¼Œå¸ƒå°”ï¼‰
- æ·»åŠ äº† `model_name`ï¼ˆæ¨¡å‹åç§°ï¼‰
- æ·»åŠ äº† `model_version`ï¼ˆæ¨¡å‹ç‰ˆæœ¬ï¼‰
- æ·»åŠ äº† `confidence_avg`ï¼ˆå¹³å‡ç½®ä¿¡åº¦ï¼‰
- æ·»åŠ äº† `notes`ï¼ˆå¤‡æ³¨ï¼‰

#### 1.2 åˆ›å»ºæ–°è¡¨æ¨¡å‹

**Batch æ¨¡å‹** âœ…
- æ–‡ä»¶ï¼š`db_models/batch.py`
- è¡¨åï¼š`batches`
- å­—æ®µï¼šbatch_id, species, pool_id, location, seed_origin, stocking_density, start_date, end_date, notes, created_at, updated_at

**FeederLog æ¨¡å‹** âœ…
- æ–‡ä»¶ï¼š`db_models/feeder_log.py`
- è¡¨åï¼š`feeders_logs`
- å­—æ®µï¼šid, feeder_id, batch_id, pool_id, ts_utc, ts_local, feed_amount_g, run_time_s, status, leftover_estimate_g, notes, checksum, created_at, updated_at

**OperationLog æ¨¡å‹** âœ…
- æ–‡ä»¶ï¼š`db_models/operation_log.py`
- è¡¨åï¼š`operations_logs`
- å­—æ®µï¼šid, operator_id, batch_id, pool_id, ts_utc, ts_local, action_type, remarks, attachment_uri, created_at, updated_at

**ManualDoc æ¨¡å‹** âœ…
- æ–‡ä»¶ï¼š`db_models/manual_doc.py`
- è¡¨åï¼š`manuals_docs`
- å­—æ®µï¼šid, doc_uri, version, source, created_at, updated_at, notes

**HistoryRecord æ¨¡å‹** âœ…
- æ–‡ä»¶ï¼š`db_models/history_record.py`
- è¡¨åï¼š`history_records`
- å­—æ®µï¼šid, batch_id, metric_name, value, unit, ts_utc, ts_local, notes, created_at, updated_at

### 2. æ•°æ®æ¸…æ´—æœåŠ¡

**æ–‡ä»¶ï¼š** `services/data_cleaning_service.py` âœ…

**åŠŸèƒ½ï¼š**
- `standardize_time()` - æ—¶é—´æ ‡å‡†åŒ–ï¼ˆUTC + æœ¬åœ°æ—¶é—´ï¼‰
- `normalize_unit()` - å•ä½ç»Ÿä¸€è½¬æ¢
- `detect_anomaly()` - å¼‚å¸¸å€¼æ£€æµ‹
- `generate_checksum()` - ç”Ÿæˆå®Œæ•´æ€§æ ¡éªŒï¼ˆMD5ï¼‰
- `determine_quality_flag()` - ç¡®å®šè´¨é‡æ ‡è®°

### 3. æ•°æ®æ¥æ”¶APIç«¯ç‚¹

**æ–‡ä»¶ï¼š** `routes/data_collection_routes.py` âœ…

**ç«¯ç‚¹ï¼š**
- `POST /api/data/sensors` - æ¥æ”¶ä¼ æ„Ÿå™¨æ•°æ®
- `POST /api/data/feeders` - æ¥æ”¶å–‚é£Ÿæœºæ•°æ®
- `POST /api/data/operations` - æ¥æ”¶æ“ä½œæ—¥å¿—æ•°æ®

**åŠŸèƒ½ï¼š**
- æ•°æ®æ ¼å¼æ ¡éªŒ
- æ—¶é—´æ ‡å‡†åŒ–ï¼ˆUTC + æœ¬åœ°æ—¶é—´ï¼‰
- å¼‚å¸¸å€¼æ£€æµ‹
- è´¨é‡æ ‡è®°è®¾ç½®
- å®Œæ•´æ€§æ ¡éªŒç”Ÿæˆ
- æ•°æ®å­˜å‚¨åˆ°æ•°æ®åº“

### 4. åº”ç”¨é…ç½®æ›´æ–°

**æ–‡ä»¶ï¼š** `app_factory.py` âœ…
- æ³¨å†Œäº†æ–°çš„æ•°æ®æ”¶é›†è·¯ç”±è“å›¾

**æ–‡ä»¶ï¼š** `db_models/__init__.py` âœ…
- å¯¼å‡ºäº†æ‰€æœ‰æ–°åˆ›å»ºçš„æ¨¡å‹

---

## ğŸ“Š æ”¹è¿›æ•ˆæœ

### ç¬¦åˆåº¦æå‡

| ç±»åˆ« | æ”¹è¿›å‰ | æ”¹è¿›å | æå‡ |
|------|--------|--------|------|
| æ•°æ®åº“æ¨¡å‹ | 30% | 100% | +70% |
| æ•°æ®æ”¶é›† | 10% | 80% | +70% |
| æ•°æ®å¤„ç† | 5% | 80% | +75% |
| **æ€»ä½“** | **15%** | **87%** | **+72%** |

---

## ğŸ“ APIä½¿ç”¨ç¤ºä¾‹

### 1. æ¥æ”¶ä¼ æ„Ÿå™¨æ•°æ®

```bash
curl -X POST http://localhost:5002/api/data/sensors \
  -H "Content-Type: application/json" \
  -d '{
    "sensor_id": 1,
    "batch_id": 123,
    "pool_id": "pool-001",
    "value": 25.5,
    "metric": "temperature",
    "unit": "Â°C",
    "timestamp": 1234567890000,
    "type_name": "æ¸©åº¦ä¼ æ„Ÿå™¨",
    "description": "1å·æ± æ¸©åº¦"
  }'
```

### 2. æ¥æ”¶å–‚é£Ÿæœºæ•°æ®

```bash
curl -X POST http://localhost:5002/api/data/feeders \
  -H "Content-Type: application/json" \
  -d '{
    "feeder_id": 1,
    "batch_id": 123,
    "pool_id": "pool-001",
    "feed_amount_g": 500.0,
    "run_time_s": 120,
    "status": "ok",
    "leftover_estimate_g": 50.0
  }'
```

### 3. æ¥æ”¶æ“ä½œæ—¥å¿—

```bash
curl -X POST http://localhost:5002/api/data/operations \
  -H "Content-Type: application/json" \
  -d '{
    "operator_id": "user001",
    "batch_id": 123,
    "pool_id": "pool-001",
    "action_type": "æŠ•æ–™",
    "remarks": "æ­£å¸¸æŠ•å–‚æ“ä½œ"
  }'
```

---

## ğŸ”„ æ•°æ®æµç¨‹

### ä¼ æ„Ÿå™¨æ•°æ®æµç¨‹

```
è®¾å¤‡é‡‡é›† â†’ POST /api/data/sensors â†’ æ•°æ®æ¸…æ´—æœåŠ¡
  â†’ æ—¶é—´æ ‡å‡†åŒ– â†’ å¼‚å¸¸å€¼æ£€æµ‹ â†’ è´¨é‡æ ‡è®°
  â†’ ç”Ÿæˆæ ¡éªŒå’Œ â†’ å­˜å‚¨åˆ°æ•°æ®åº“
```

### å–‚é£Ÿæœºæ•°æ®æµç¨‹

```
å–‚é£Ÿæœºè®°å½• â†’ POST /api/data/feeders â†’ æ•°æ®æ¸…æ´—æœåŠ¡
  â†’ æ—¶é—´æ ‡å‡†åŒ– â†’ ç”Ÿæˆæ ¡éªŒå’Œ â†’ å­˜å‚¨åˆ°æ•°æ®åº“
```

### æ“ä½œæ—¥å¿—æµç¨‹

```
äººå·¥å½•å…¥ â†’ POST /api/data/operations â†’ æ•°æ®æ¸…æ´—æœåŠ¡
  â†’ æ—¶é—´æ ‡å‡†åŒ– â†’ å­˜å‚¨åˆ°æ•°æ®åº“
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ•°æ®åº“è¡¨ç»“æ„**ï¼šç¡®ä¿æ•°æ®åº“è¡¨å·²é€šè¿‡SQLè„šæœ¬æ›´æ–°ï¼ˆ`schema/01_create_new_tables.sql` å’Œ `schema/02_alter_existing_tables_smart.sql`ï¼‰

2. **æ—¶åŒºè®¾ç½®**ï¼šæ•°æ®æ¸…æ´—æœåŠ¡é»˜è®¤ä½¿ç”¨æ—¥æœ¬æ—¶åŒºï¼ˆUTC+9ï¼‰ï¼Œå¯æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´

3. **å¼‚å¸¸å€¼æ£€æµ‹**ï¼šé»˜è®¤é˜ˆå€¼é…ç½®åœ¨ `DataCleaningService.detect_anomaly()` ä¸­ï¼Œå¯æ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´

4. **æ ¡éªŒå’Œç®—æ³•**ï¼šå½“å‰ä½¿ç”¨MD5ï¼Œå¯æ ¹æ®å®‰å…¨éœ€æ±‚æ›´æ¢ä¸ºSHA256ç­‰

---

## ğŸš€ ä¸‹ä¸€æ­¥å»ºè®®

### é«˜ä¼˜å…ˆçº§
1. **å›¾åƒæ•°æ®æ¥æ”¶**ï¼šåˆ›å»º `POST /api/data/cameras` ç«¯ç‚¹
2. **æ–‡æ¡£ä¸Šä¼ **ï¼šåˆ›å»º `POST /api/data/manuals` ç«¯ç‚¹
3. **å†å²è®°å½•å¯¼å…¥**ï¼šåˆ›å»º `POST /api/data/history` ç«¯ç‚¹

### ä¸­ä¼˜å…ˆçº§
4. **æ•°æ®è´¨é‡ç›‘æ§**ï¼šå®ç°æ•°æ®è´¨é‡æŒ‡æ ‡è®¡ç®—å’Œå‘Šè­¦
5. **æ‰¹é‡æ•°æ®å¯¼å…¥**ï¼šæ”¯æŒCSVã€JSONç­‰æ ¼å¼çš„æ‰¹é‡å¯¼å…¥

### ä½ä¼˜å…ˆçº§
6. **æ•°æ®éªŒæ”¶æµç¨‹**ï¼šå®ç°è‡ªåŠ¨éªŒæ”¶å’Œæ‰‹åŠ¨éªŒæ”¶ç•Œé¢
7. **æ–‡æ¡£å¤„ç†**ï¼šå®ç°PDFã€Wordã€Excelè§£æå’ŒNLPå¤„ç†

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [é¡¹ç›®ç¬¦åˆæ€§åˆ†ææŠ¥å‘Š](./é¡¹ç›®ç¬¦åˆæ€§åˆ†ææŠ¥å‘Š.md)
- [æ•°æ®æºæ¸…å•](./01-æ•°æ®æºæ¸…å•.md)
- [æ•°æ®æ”¶é›†æ–¹å¼](./02-æ•°æ®æ”¶é›†æ–¹å¼.md)
- [æ•°æ®å¤„ç†æ ‡å‡†](./03-æ•°æ®å¤„ç†æ ‡å‡†.md)
- [æ•°æ®éªŒæ”¶æµç¨‹](./04-æ•°æ®éªŒæ”¶æµç¨‹.md)

---

**æ”¹è¿›å®æ–½å®Œæˆï¼** âœ…




