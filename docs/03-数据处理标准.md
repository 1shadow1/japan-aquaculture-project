# 数据处理标准

**版本：** v1.0  
**编制日期：** 2025.11.18  
**负责人/单位：** AI产业部  
**适用范围：** 日本地区陆上工厂化养殖的南美白对虾数据处理标准与规范

---

## 1. 数据处理流程概述

### 1.1 处理流程（ETL/ELT）

数据处理采用ETL（Extract, Transform, Load）或ELT（Extract, Load, Transform）模式：

```
原始数据接收 → 数据清洗与标准化 → 数据转换 → 数据入库 → 数据质量检查
```

### 1.2 处理原则

- **幂等性**：重复处理同一数据应产生相同结果
- **可追溯性**：保留处理日志和版本信息
- **可扩展性**：支持新增数据源和处理规则
- **容错性**：处理失败时支持重试和恢复

---

## 2. 原始数据接收标准

### 2.1 接收前校验

#### 完整性校验

- **数据包完整性**：
  - 检查数据包是否完整
  - 检查必填字段是否存在
  - 检查数据量是否符合预期

#### 格式校验

- **字段校验**：
  - 检查必填字段是否存在
  - 检查字段类型是否正确

- **类型校验**：
  - 数值类型：检查是否为有效数字
  - 日期时间类型：检查格式是否正确
  - 枚举类型：检查值是否在允许范围内

- **单位校验**：
  - 检查单位字段是否存在
  - 检查单位是否符合标准（如：mg/L, °C, pH等）

### 2.2 接收后处理

- **时间戳记录**：记录数据接收时间（receive_time）
- **数据标识**：生成唯一数据ID（data_id）

---

## 3. 数据清洗与标准化

### 3.1 时间标准化

#### UTC时间转换

- **要求**：所有时间戳必须转换为UTC时间
- **格式**：`DATETIME(3)` - 包含毫秒精度
- **示例**：`2025-11-18 14:30:00.123`

#### 本地时间记录

- **时区**：日本时区（Asia/Tokyo, UTC+9）
- **格式**：`DATETIME(3)` - 包含毫秒精度
- **用途**：便于本地化查询和展示

#### 时间校验规则

- **时间范围**：检查时间戳是否在合理范围内
- **时间顺序**：检查时间戳是否按顺序递增（允许小范围波动）
- **时区一致性**：确保UTC和本地时间的时区转换正确

### 3.2 单位换算与统一

#### 传感器数据单位标准

| 指标 | 标准单位 | 允许单位 | 换算规则 |
|------|----------|----------|----------|
| 水温 | °C | °C, K, °F | K = °C + 273.15, °F = °C × 9/5 + 32 |
| 溶解氧 | mg/L | mg/L, ppm, % | 1 mg/L = 1 ppm |
| pH | pH | pH | 无换算 |
| 盐度 | ppt (‰) | ppt, PSU, g/L | 1 ppt ≈ 1 PSU |
| 氨氮 | mg/L | mg/L, ppm | 1 mg/L = 1 ppm |
| 亚硝酸盐 | mg/L | mg/L, ppm | 1 mg/L = 1 ppm |
| 浊度 | NTU | NTU, FTU | 1 NTU ≈ 1 FTU |
| 水位 | m | m, cm, mm | 1 m = 100 cm = 1000 mm |
| 光照强度 | lux | lux, lx | 无换算 |
| 温度（室内） | °C | °C, K, °F | 同水温 |
| 湿度 | % | % | 无换算 |

#### 单位换算处理

- **自动识别**：根据单位字段自动识别单位类型
- **自动换算**：将非标准单位换算为标准单位
- **单位记录**：保留原始单位信息（如需要）
- **异常处理**：无法识别的单位标记为异常

### 3.3 缺失值处理

#### 缺失值识别

- **NULL值**：数据库NULL值
- **空字符串**：空字符串或仅包含空白字符
- **特殊标记**：设备标记的缺失值（如：-999, 9999等）

#### 缺失值处理策略

| 策略 | 适用场景 | 处理方式 |
|------|----------|----------|
| **领域规则插值** | 有业务规则约束 | 根据业务规则插值 |
| **删除** | 缺失比例高，影响分析 | 标记后删除 |
| **标记** | 无法插值或删除 | 标记为missing，保留原始记录 |

#### 缺失值处理规则

- **缺失比例 < 5%**：使用插值方法
- **缺失比例 5-20%**：使用插值方法，标记为可疑
- **缺失比例 > 20%**：标记为异常，需要人工审核

### 3.4 异常值处理

#### 异常值检测方法

1. **范围校验**
   - 基于业务规则的范围检查
   - 超出合理范围的值标记为异常

2. **传感器漂移检测**
   - 检测传感器读数是否持续偏离正常值
   - 检测传感器是否出现系统性偏差

3. **设备故障识别**
   - 检测设备是否返回错误状态
   - 检测设备通信是否异常

#### 异常值处理策略

| 策略 | 适用场景 | 处理方式 |
|------|----------|----------|
| **标记** | 可疑但不确定 | 标记为anomaly，保留数据 |
| **人工审核** | 重要数据或大量异常 | 标记为待审核，通知管理员 |

#### 异常值处理规则

- **单点异常**：标记为anomaly，保留数据
- **连续异常**：标记为设备故障，暂停使用该设备数据
- **批量异常**：触发告警，需要人工介入

---

## 4. 数据转换与入库

### 4.1 结构化数据入库

#### 数据库设计原则

- **主键设计**：使用BIGINT UNSIGNED AUTO_INCREMENT
- **外键约束**：确保数据关联完整性
- **索引设计**：基于查询模式建立索引
- **分区策略**：时间序列表按时间范围分区（可选）

#### 入库流程

1. **数据映射**：将清洗后的数据映射到数据库表结构
2. **数据验证**：再次验证数据是否符合表结构要求
3. **批量插入**：使用批量插入提高性能
4. **事务处理**：确保数据一致性
5. **错误处理**：记录插入失败的数据和原因

#### 入库标准

- **数据完整性**：必填字段不能为空
- **数据一致性**：外键关联必须存在
- **数据准确性**：数值精度符合要求
- **性能要求**：批量插入性能满足要求

### 4.2 非结构化数据存储

#### 对象存储

- **存储位置**：对象存储（OSS/S3等）或文件系统
- **存储路径**：按照目录结构规范存储
- **文件命名**：按照文件命名规范命名
- **元数据记录**：在数据库中记录存储URI和元数据

#### 图像/视频处理

- **格式转换**：统一转换为标准格式（如：JPG, MP4）
- **压缩处理**：适当压缩以减少存储空间
- **缩略图生成**：生成缩略图便于预览
- **元数据提取**：提取EXIF等元数据信息

### 4.3 数据版本化

#### 版本号管理

- **数据版本号**：每次处理生成新的版本号
- **版本格式**：`v{主版本}.{次版本}.{修订版本}`
- **版本记录**：在数据库中记录版本信息

#### 处理流水号

- **pipeline_run_id**：每次处理管道的唯一标识
- **用途**：追踪数据处理过程
- **记录内容**：
  - 处理开始时间
  - 处理结束时间
  - 处理数据量
  - 处理结果（成功/失败）
  - 错误信息（如有）

---

## 5. 图像数据处理

### 5.1 算法推理

#### 检测目标

- **数量检测**：检测图像中的虾数量
- **尺寸检测**：检测虾的平均长度和高度
- **体重估计**：基于尺寸估计体重
- **饲料检测**：检测是否存在饲料
- **虾皮检测**：检测是否存在虾皮

#### 推理流程

1. **图像预处理**
   - 图像格式转换
   - 图像尺寸调整
   - 图像增强（可选）

2. **模型推理**
   - 调用AI模型进行推理
   - 获取检测结果和置信度

3. **结果后处理**
   - 结果格式标准化
   - 置信度阈值过滤
   - 异常结果标记

4. **结果存储**
   - 检测结果写入 `image_detections` 表
   - 关联 `image_frames` 表

#### 质量评分

- **置信度评分**：基于模型输出的置信度
- **完整性评分**：基于检测结果的完整性
- **一致性评分**：基于历史数据的一致性（可选）

### 5.2 标注审核

#### 自动标注

- **流程**：算法推理 → 自动生成标注
- **质量要求**：置信度 ≥ 0.6（可配置）

#### 人工抽检

- **抽检比例**：5%（可配置）
- **抽检方式**：随机抽样或基于置信度抽样
- **审核内容**：
  - 数量准确性
  - 尺寸准确性
  - 体重估计合理性
  - 饲料/虾皮检测准确性

#### 纠偏机制

- **错误标注修正**：人工审核发现错误时修正
- **模型反馈**：将修正结果反馈给模型训练（可选）
- **质量评估**：计算自动标注与人工标注的一致度

---

## 6. 处理管道生命周期

### 6.1 任务编排

#### 定时触发

- **传感器数据**：按采样周期定时处理
- **批量数据**：按计划时间批量处理
- **历史数据**：一次性处理或分批处理

#### 事件触发

- **图像上传**：用户上传图像后立即处理
- **喂食记录**：喂食机记录后立即处理
- **操作日志**：操作录入后立即处理

### 6.2 失败重试

#### 重试策略

- **重试次数**：最多重试3次（可配置）
- **重试间隔**：指数退避（1秒、2秒、4秒）
- **重试条件**：
  - 网络错误
  - 临时性错误
  - 可恢复的错误

#### 失败处理

- **错误记录**：记录失败原因和错误信息
- **告警通知**：连续失败时发送告警
- **人工介入**：严重错误需要人工处理

### 6.3 错误日志记录

#### 日志内容

- **处理时间**：开始时间和结束时间
- **处理数据**：数据ID、数据源、数据量
- **处理结果**：成功/失败、错误信息
- **性能指标**：处理耗时、吞吐量

#### 日志存储

- **存储位置**：日志文件或日志数据库
- **日志级别**：DEBUG、INFO、WARNING、ERROR
- **日志保留**：保留30天（可配置）

### 6.4 指标监控

#### 监控指标

- **时延**：数据处理延迟时间
- **成功率**：数据处理成功率
- **吞吐量**：单位时间处理数据量
- **错误率**：数据处理错误率

#### 监控告警

- **延迟告警**：处理延迟超过阈值时告警
- **失败告警**：失败率超过阈值时告警
- **性能告警**：吞吐量低于阈值时告警

---

## 7. 数据质量管理

### 7.1 核心质量指标

#### 完整性（Completeness）

- **定义**：数据缺失比例
- **计算方法**：`(总记录数 - 缺失记录数) / 总记录数 × 100%`
- **目标值**：≥ 95%
- **评估频率**：每日评估

#### 一致性（Consistency）

- **定义**：字段与单位统一程度
- **评估内容**：
  - 字段命名一致性
  - 单位使用一致性
  - 数据格式一致性
- **目标值**：100%
- **评估频率**：每次处理时评估

#### 准确性（Accuracy）

- **定义**：与标准或人工校验的一致度
- **评估方法**：
  - 与标准值对比
  - 与人工标注对比
  - 与历史数据对比
- **目标值**：≥ 90%
- **评估频率**：定期评估（每周/每月）

#### 及时性（Timeliness）

- **定义**：数据延迟时间
- **计算方法**：`数据入库时间 - 数据产生时间`
- **目标值**：≤ 5分钟（可配置）
- **评估频率**：实时监控

#### 可追溯性（Traceability）

- **定义**：元数据完整度
- **评估内容**：
  - 必填元数据是否完整
  - 数据来源是否可追溯
  - 处理历史是否可追溯
- **目标值**：100%
- **评估频率**：每次处理时评估

### 7.2 质量规则与阈值

#### 传感器数据质量规则

| 指标 | 合理范围 | 越界处理 | 告警级别 |
|------|----------|----------|----------|
| 溶氧（DO） | 0-20 mg/L | 标记异常 | 警告 |
| pH | 6.5-9.0 | 标记异常，触发告警 | 严重 |
| 水温 | 20-35 °C | 标记异常 | 警告 |
| 盐度 | 10-35 ppt | 标记异常 | 警告 |
| 氨氮 | 0-2 mg/L | 标记异常，触发告警 | 严重 |
| 亚硝酸盐 | 0-0.5 mg/L | 标记异常，触发告警 | 严重 |
| 浊度 | 0-50 NTU | 标记异常 | 警告 |

#### 图像检测质量规则

| 指标 | 合理范围 | 越界处理 |
|------|----------|----------|
| count | ≥ 0 | 负数标记异常 |
| confidence_avg | ≥ 0.6 | 低于阈值标记为低质量 |
| avg_length_mm | 10-150 mm | 超出范围标记异常 |
| avg_height_mm | 2-30 mm | 超出范围标记异常 |
| est_weight_g_avg | 0.1-50 g | 超出范围标记异常 |

#### 时间戳延迟规则

- **标准延迟**：设备到入库 ≤ 5分钟
- **可配置延迟**：根据数据源类型配置不同延迟阈值
- **超时处理**：超过延迟阈值时标记为延迟数据

### 7.3 抽检机制

#### 自动验收前抽检

- **抽检比例**：10%（可配置）
- **抽检方式**：随机抽样
- **抽检内容**：
  - 数据完整性
  - 数据格式正确性
  - 数据范围合理性

#### 图像标注人工抽检

- **抽检比例**：5%（可配置）
- **抽检方式**：
  - 随机抽样
  - 基于置信度抽样（低置信度优先）
- **抽检内容**：
  - 数量准确性
  - 尺寸准确性
  - 体重估计合理性
  - 饲料/虾皮检测准确性

#### 一致度计算

- **计算方法**：`一致标注数 / 总抽检数 × 100%`
- **目标值**：≥ 85%
- **处理方式**：低于目标值时增加抽检比例或重新训练模型

### 7.4 问题处理流程

#### 问题识别

1. **自动检测**：系统自动检测数据质量问题
2. **人工发现**：人工审核时发现质量问题
3. **用户反馈**：用户使用数据时反馈问题

#### 问题分类

- **数据缺失**：数据未采集或丢失
- **数据异常**：数据超出合理范围
- **数据错误**：数据明显错误
- **格式错误**：数据格式不符合规范

#### 问题处理

```
问题识别 → 原因分析 → 纠正措施 → 数据修复 → 复验 → 问题关闭
```

1. **原因分析**：
   - 设备故障
   - 网络问题
   - 人工错误
   - 系统错误

2. **纠正措施**：
   - 修复设备
   - 修复网络
   - 修正人工错误
   - 修复系统bug

3. **数据修复**：
   - 补传数据
   - 修正错误数据
   - 删除无效数据

4. **复验**：
   - 验证修复后的数据质量
   - 确认问题已解决

---

## 8. 数据库设计标准

### 8.1 命名规范

- **表名**：小写+下划线，如：`sensor_readings`
- **字段名**：小写+下划线，如：`device_id`
- **索引名**：`idx_{表名缩写}_{字段名}`，如：`idx_sr_device_ts`
- **外键名**：`fk_{表名缩写}_{关联表名缩写}`，如：`fk_sr_device`

### 8.2 数据类型标准

- **主键**：`BIGINT UNSIGNED AUTO_INCREMENT`
- **外键**：`BIGINT UNSIGNED`
- **时间类型**：`DATETIME(3)`（毫秒精度）
- **布尔类型**：`TINYINT(1)`（0/1）
- **文本类型**：`VARCHAR(n)` 或 `TEXT`
- **数值类型**：`DOUBLE` 或 `DECIMAL(p,s)`

### 8.3 约束标准

- **NOT NULL**：必填字段
- **DEFAULT**：设置默认值
- **ENUM**：限定取值范围
- **FOREIGN KEY**：外键约束
- **UNIQUE**：唯一性约束（如需要）
- **CHECK**：检查约束（MySQL 8.0.16+）

### 8.4 索引标准

- **主键索引**：自动创建
- **外键索引**：自动创建
- **时间索引**：基于 `ts_utc` 的索引
- **批次索引**：基于 `batch_id` 的索引
- **联合索引**：基于查询模式的联合索引

---

## 9. 附录

### 9.1 数据处理流程图

```
原始数据
    ↓
[接收校验]
    ↓
[时间标准化]
    ↓
[单位换算]
    ↓
[缺失值处理]
    ↓
[异常值处理]
    ↓
[数据转换]
    ↓
[数据入库]
    ↓
[质量检查]
    ↓
处理完成
```

### 9.2 质量指标计算公式

- **完整性** = (总记录数 - 缺失记录数) / 总记录数 × 100%
- **准确性** = 正确记录数 / 总记录数 × 100%
- **及时性** = 数据入库时间 - 数据产生时间
- **一致度** = 一致标注数 / 总抽检数 × 100%

---

**文档状态**：待确认  
**最后更新**：2025.11.18





