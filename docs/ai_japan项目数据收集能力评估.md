# ai_japan 项目数据收集能力评估报告

**评估日期：** 2025-01-XX  
**评估对象：** `/srv/ai_japan` - 日本陆上养殖实验室客户端服务器代码  
**评估依据：** 
- `docs/01-数据源清单.md`
- `docs/02-数据收集方式.md`
- `docs/03-数据处理标准.md`

---

## 执行摘要

`ai_japan` 项目是一个客户端数据采集和上传系统，部署在日本陆上养殖实验室的客户端服务器上。通过定时任务和触发式请求，将采集的数据发送到服务端。

**总体评估：** ⚠️ **部分满足** - 核心传感器数据采集和上传功能已实现，但缺少部分数据源的支持。

**满足度：** 约 **60%**

---

## 1. 已实现的数据收集功能

### 1.1 ✅ 传感器数据收集（完全满足）

**实现状态：** ✅ **已实现**

**实现位置：**
- `src/services/sensor_data_service.py` - 传感器数据采集服务
- `src/tasks/sensor_data_task.py` - 传感器数据采集任务
- `src/tasks/sensor_data_stream_task.py` - 传感器数据流式上传任务

**已支持的传感器：**
- ✅ 溶解氧传感器（COM18）
- ✅ 液位传感器（COM25）
- ✅ pH传感器（COM4）
- ✅ 浊度传感器（COM5）

**数据采集方式：**
- ✅ 定时自动采集（默认每10秒采样，可配置）
- ✅ 数据记录到CSV文件（`output/sensor/data_collection.csv`）
- ✅ 支持模拟模式（`AIJ_SENSOR_SIMULATE=1`）

**数据上传方式：**
- ✅ 流式上传（`SensorDataStreamTask`）：每10秒（可配置）推送数据到服务端
  - 目标URL：`http://8.216.33.92:5000/api/updata_sensor_data`
  - 数据格式：JSON，字段对齐CSV表头
- ✅ 批量上传（`client/updata.py`）：每10分钟执行一次，上传最近61天的CSV文件
  - 目标URL：`http://8.216.33.92:5000/api/updata_file`
  - 支持干运行模式（`AIJ_UPLOAD_DRY_RUN=1`）

**数据字段：**
- ✅ 时间戳
- ✅ 溶解氧饱和度
- ✅ 液位(mm)
- ✅ PH值
- ✅ PH温度(°C)
- ✅ 浊度(NTU)
- ✅ 浊度温度(°C)

**符合度评估：**
- ✅ 采集频率：符合要求（1-10分钟，当前为10秒，可调整）
- ✅ 数据格式：符合要求（结构化数据）
- ⚠️ 元数据完整性：**部分缺失**
  - ❌ 缺少 `device_id`（设备唯一标识）
  - ❌ 缺少 `batch_id`（批次ID）
  - ❌ 缺少 `pool_id`（池号/分区标识）
  - ❌ 缺少 `ts_utc` 和 `ts_local`（UTC和本地时间戳）
  - ❌ 缺少 `metric`（指标名称，如：do, ph, temp等）
  - ❌ 缺少 `unit`（计量单位，虽然CSV中有单位，但未作为独立字段）
  - ❌ 缺少 `quality_flag`（质量标记）
  - ❌ 缺少 `checksum`（完整性校验）

**改进建议：**
1. 在数据上传时补充完整的元数据字段
2. 添加设备ID配置（从配置文件或环境变量读取）
3. 添加批次ID和池号配置
4. 实现时间标准化（UTC + 本地时间）
5. 实现数据质量标记和校验和生成

---

### 1.2 ✅ 图像目标监测数据收集（部分满足）

**实现状态：** ⚠️ **部分实现**

**实现位置：**
- `src/services/camera_controller_service.py` - 摄像头控制服务
- `src/tasks/camera_controller_task.py` - 摄像头控制任务

**已实现功能：**
- ✅ 键盘触发录制（按键0-4触发对应摄像头）
- ✅ 视频录制（默认60秒，可配置）
- ✅ 视频保存到本地（`logs/videos/`）
- ✅ 录制状态上报（开始/结束事件发送到服务端）
  - 目标URL：`http://8.216.33.92:5000/api/camera_device_status`
- ✅ 视频抽帧（按固定间隔抽取帧，默认1秒）
- ✅ 图片上传（抽帧后的图片上传到服务端）
  - 目标URL：`http://8.216.33.92:5000/api/updata_camera_data`
  - 支持干运行模式（`AIJ_CAMERA_UPLOAD_DRY_RUN=1`）

**上传的元数据：**
- ✅ `camera_index`（摄像头索引）
- ✅ `video_name`（视频名称）
- ✅ `timestamp`（时间戳，ISO格式）

**缺失功能：**
- ❌ 缺少 `batch_id`（批次ID）
- ❌ 缺少 `pool_id`（池号/分区）
- ❌ 缺少图像检测结果上传（检测数量、长度、高度、体重等）
- ❌ 缺少模型信息（`model_name`, `model_version`）
- ❌ 缺少置信度信息（`confidence_avg`）
- ❌ 缺少图像元数据（分辨率、格式、编解码等）

**符合度评估：**
- ✅ 触发方式：符合要求（用户触发）
- ✅ 图像采集：符合要求
- ✅ 图像上传：符合要求
- ❌ 检测结果：**未实现** - 图像检测结果（count, avg_length_mm等）需要服务端AI模型推理后返回，客户端未实现结果接收和上报
- ⚠️ 元数据完整性：**部分缺失**

**改进建议：**
1. 在图像上传时补充 `batch_id` 和 `pool_id`
2. 实现图像检测结果接收（从服务端API获取检测结果）
3. 实现检测结果上报（将检测结果发送到服务端）
4. 补充完整的图像元数据（分辨率、格式等）

---

### 1.3 ✅ 喂食机数据收集（部分满足）

**实现状态：** ⚠️ **部分实现**

**实现位置：**
- `src/services/feeder_service.py` - 喂食机服务
- `src/tasks/feed_device_schedule_task.py` - 定时喂食任务
- `src/tasks/feed_device_status_task.py` - 喂食机状态上报任务

**已实现功能：**
- ✅ 云端喂食机接口封装（登录、设备查询、状态查询、喂食指令）
- ✅ 定时喂食（按时间列表触发，默认04:00、10:00、16:00、22:00）
- ✅ 喂食机状态上报（每10分钟执行一次，可配置）
- ✅ 支持多份量喂食（高份量4份，低份量2份）

**缺失功能：**
- ❌ 缺少喂食记录上传（`feeders_logs` 表所需的数据）
- ❌ 缺少 `batch_id`（批次ID）
- ❌ 缺少 `pool_id`（池号/分区）
- ❌ 缺少 `feed_amount_g`（投喂量，克）
- ❌ 缺少 `run_time_s`（运行时长，秒）
- ❌ 缺少 `leftover_estimate_g`（剩余饵料估计，克）
- ❌ 缺少 `checksum`（完整性校验）

**符合度评估：**
- ✅ 设备控制：符合要求（可以控制喂食机）
- ✅ 定时触发：符合要求
- ❌ 数据记录：**未实现** - 喂食操作后未记录和上传喂食日志数据

**改进建议：**
1. 实现喂食记录生成（每次喂食后生成记录）
2. 实现喂食记录上传（发送到服务端 `/api/data/feeders` 端点）
3. 补充完整的元数据字段（batch_id, pool_id, feed_amount_g等）
4. 从设备状态中提取运行时长、剩余饵料等信息

---

## 2. 未实现的数据收集功能

### 2.1 ❌ 操作日志数据收集（完全缺失）

**需求：** 人工录入操作日志（投料、水质调控、巡检、清洗等）

**缺失功能：**
- ❌ 操作日志录入界面
- ❌ 操作日志数据上传
- ❌ 附件上传功能（图片或文档）

**需要实现：**
1. 创建操作日志录入界面（Web界面或桌面应用）
2. 实现操作日志数据上传（POST `/api/data/operations`）
3. 实现附件上传功能

**数据字段要求：**
- `operator_id`：操作人ID
- `batch_id`：批次ID
- `pool_id`：池号/分区
- `ts_utc`, `ts_local`：时间戳
- `action_type`：操作类型（枚举值）
- `remarks`：备注
- `attachment_uri`：附件URI（可选）

---

### 2.2 ❌ 养殖手册文档收集（完全缺失）

**需求：** 人工上传养殖手册/文档（PDF、Word、TXT等）

**缺失功能：**
- ❌ 文档上传界面
- ❌ 文档上传功能
- ❌ 文档版本管理

**需要实现：**
1. 创建文档上传界面
2. 实现文档上传（POST `/api/data/manuals`）
3. 实现文档版本管理

**数据字段要求：**
- `doc_uri`：文档URI
- `version`：版本号
- `source`：来源
- `notes`：备注

---

### 2.3 ❌ 往期养殖记录收集（完全缺失）

**需求：** 批量导入历史数据（CSV、Excel、JSON等）

**缺失功能：**
- ❌ 历史数据导入界面
- ❌ 历史数据导入功能
- ❌ 数据清洗和验证

**需要实现：**
1. 创建历史数据导入界面
2. 实现数据导入功能（批量导入到 `history_records` 表）
3. 实现数据清洗和验证

**数据字段要求：**
- `batch_id`：批次ID
- `metric_name`：指标名称
- `value`：值（文本存储）
- `unit`：单位
- `ts_utc`, `ts_local`：时间戳
- `notes`：备注

---

### 2.4 ❌ 当期养殖记录收集（完全缺失）

**需求：** 批次信息管理（创建、更新批次）

**缺失功能：**
- ❌ 批次创建界面
- ❌ 批次信息管理
- ❌ 批次数据更新

**需要实现：**
1. 创建批次管理界面
2. 实现批次创建和更新（POST `/api/batches`）
3. 实现批次信息查询

**数据字段要求：**
- `pool_id`：池号/分区标识
- `species`：物种（默认：Litopenaeus vannamei）
- `location`：场地/车间位置
- `seed_origin`：苗种来源
- `stocking_density`：放养密度
- `start_date`：开始日期
- `end_date`：结束日期（可选）
- `notes`：备注

---

## 3. 数据上传接口对比

### 3.1 已实现的接口

| 接口路径 | 实现位置 | 数据源 | 状态 |
|---------|---------|--------|------|
| `/api/updata_sensor_data` | `SensorDataStreamTask` | 传感器数据（流式） | ✅ 已实现 |
| `/api/updata_file` | `client/updata.py` | 传感器数据/操作日志/图像（批量） | ✅ 已实现 |
| `/api/camera_device_status` | `CameraControllerService` | 摄像头状态 | ✅ 已实现 |
| `/api/updata_camera_data` | `CameraControllerService` | 摄像头图像 | ✅ 已实现 |

### 3.2 服务端已提供但客户端未使用的接口

根据 `japan_server` 项目的实现，服务端已提供以下接口，但客户端未使用：

| 接口路径 | 服务端实现 | 客户端使用 | 说明 |
|---------|-----------|-----------|------|
| `/api/data/sensors` | ✅ `routes/data_collection_routes.py` | ❌ 未使用 | 传感器数据接收（推荐使用） |
| `/api/data/feeders` | ✅ `routes/data_collection_routes.py` | ❌ 未使用 | 喂食机数据接收 |
| `/api/data/operations` | ✅ `routes/data_collection_routes.py` | ❌ 未使用 | 操作日志接收 |
| `/api/data/cameras` | ❌ 未实现 | ❌ 未使用 | 摄像头图像接收（需要实现） |
| `/api/data/manuals` | ❌ 未实现 | ❌ 未使用 | 文档上传（需要实现） |

**建议：**
1. 将传感器数据流式上传改为使用 `/api/data/sensors` 接口
2. 实现喂食机数据上传到 `/api/data/feeders` 接口
3. 实现操作日志上传到 `/api/data/operations` 接口
4. 服务端需要实现 `/api/data/cameras` 和 `/api/data/manuals` 接口

---

## 4. 元数据完整性对比

### 4.1 传感器数据元数据对比

| 字段 | 要求 | 当前实现 | 状态 |
|------|------|---------|------|
| `device_id` | ✅ 必填 | ❌ 缺失 | ❌ |
| `batch_id` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `pool_id` | ✅ 必填 | ❌ 缺失 | ❌ |
| `ts_utc` | ✅ 必填 | ❌ 缺失 | ❌ |
| `ts_local` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `metric` | ✅ 必填 | ❌ 缺失 | ❌ |
| `value` | ✅ 必填 | ✅ 有 | ✅ |
| `unit` | ⚠️ 条件必填 | ⚠️ 部分（在CSV列名中） | ⚠️ |
| `quality_flag` | ✅ 必填 | ❌ 缺失 | ❌ |
| `checksum` | ⚠️ 推荐 | ❌ 缺失 | ❌ |

**符合度：** 约 **20%**

---

### 4.2 图像数据元数据对比

| 字段 | 要求 | 当前实现 | 状态 |
|------|------|---------|------|
| `camera_id` | ✅ 必填 | ✅ 有（camera_index） | ✅ |
| `batch_id` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `pool_id` | ✅ 必填 | ❌ 缺失 | ❌ |
| `ts_utc` | ✅ 必填 | ⚠️ 部分（timestamp） | ⚠️ |
| `ts_local` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `storage_uri` | ✅ 必填 | ❌ 缺失 | ❌ |
| `width_px` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `height_px` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `format` | ⚠️ 推荐 | ⚠️ 部分（jpg） | ⚠️ |
| `codec` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `quality_flag` | ✅ 必填 | ❌ 缺失 | ❌ |
| `checksum` | ⚠️ 推荐 | ❌ 缺失 | ❌ |

**符合度：** 约 **25%**

---

### 4.3 喂食机数据元数据对比

| 字段 | 要求 | 当前实现 | 状态 |
|------|------|---------|------|
| `feeder_id` | ✅ 必填 | ✅ 有（dev_id） | ✅ |
| `batch_id` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `pool_id` | ✅ 必填 | ❌ 缺失 | ❌ |
| `ts_utc` | ✅ 必填 | ❌ 缺失 | ❌ |
| `ts_local` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `feed_amount_g` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `run_time_s` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `status` | ✅ 必填 | ⚠️ 部分（从设备状态获取） | ⚠️ |
| `leftover_estimate_g` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `notes` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `checksum` | ⚠️ 推荐 | ❌ 缺失 | ❌ |

**符合度：** 约 **15%**

---

## 5. 数据质量处理

### 5.1 已实现

- ✅ 数据采集错误处理（重试机制）
- ✅ 网络上传错误处理（重试机制）
- ✅ 模拟模式支持（无硬件环境测试）

### 5.2 未实现

- ❌ 时间标准化（UTC + 本地时间）
- ❌ 单位统一转换
- ❌ 异常值检测
- ❌ 质量标记（quality_flag）
- ❌ 完整性校验（checksum）
- ❌ 数据清洗服务调用（服务端已实现 `DataCleaningService`，客户端未使用）

**改进建议：**
1. 在客户端实现基础的数据清洗（时间标准化、单位转换）
2. 或在上传前调用服务端的数据清洗接口
3. 实现质量标记和校验和生成

---

## 6. 配置管理

### 6.1 已实现的配置

- ✅ 环境变量配置（`AIJ_SENSOR_SIMULATE`, `AIJ_UPLOAD_DRY_RUN`等）
- ✅ 传感器配置（串口号、波特率等）
- ✅ 上传URL配置（可通过环境变量覆盖）

### 6.2 缺失的配置

- ❌ 设备ID配置（`device_id`, `camera_id`, `feeder_id`）
- ❌ 批次ID配置（`batch_id`）
- ❌ 池号配置（`pool_id`）
- ❌ 时区配置（用于生成本地时间戳）
- ❌ 配置文件管理（建议使用JSON或YAML配置文件）

**改进建议：**
1. 创建统一的配置文件（`config/client_config.json`）
2. 支持从配置文件读取设备ID、批次ID、池号等
3. 支持从环境变量覆盖配置

---

## 7. 总结与建议

### 7.1 满足度统计

| 数据源 | 实现状态 | 符合度 |
|--------|---------|--------|
| 传感器数据 | ✅ 已实现 | 60% |
| 图像目标监测 | ⚠️ 部分实现 | 40% |
| 喂食机数据 | ⚠️ 部分实现 | 30% |
| 操作日志 | ❌ 未实现 | 0% |
| 养殖手册文档 | ❌ 未实现 | 0% |
| 往期养殖记录 | ❌ 未实现 | 0% |
| 当期养殖记录 | ❌ 未实现 | 0% |

**总体符合度：** 约 **30%**

---

### 7.2 优先级改进建议

#### 🔴 高优先级（核心功能）

1. **补充传感器数据元数据**
   - 添加 `device_id`, `batch_id`, `pool_id`
   - 实现时间标准化（UTC + 本地时间）
   - 添加 `metric` 和 `unit` 字段
   - 实现质量标记和校验和

2. **实现喂食机数据记录和上传**
   - 每次喂食后生成记录
   - 上传到 `/api/data/feeders` 接口
   - 补充完整的元数据

3. **统一使用服务端标准接口**
   - 将传感器数据上传改为使用 `/api/data/sensors`
   - 实现喂食机数据上传到 `/api/data/feeders`

#### 🟡 中优先级（重要功能）

4. **实现操作日志录入和上传**
   - 创建操作日志录入界面
   - 实现上传到 `/api/data/operations` 接口

5. **完善图像数据元数据**
   - 补充 `batch_id`, `pool_id`
   - 添加图像尺寸、格式等元数据
   - 实现检测结果接收和上报

6. **实现配置管理**
   - 创建统一的配置文件
   - 支持设备ID、批次ID、池号等配置

#### 🟢 低优先级（辅助功能）

7. **实现文档上传功能**
   - 创建文档上传界面
   - 实现上传到 `/api/data/manuals` 接口

8. **实现历史数据导入**
   - 创建数据导入界面
   - 实现批量导入功能

9. **实现批次管理**
   - 创建批次管理界面
   - 实现批次创建和更新

---

### 7.3 技术债务

1. **代码组织**
   - 部分硬编码路径（如 `C:\Users\37897\Desktop\japan_data\`）
   - 建议使用配置文件管理路径

2. **错误处理**
   - 部分异常处理不够完善
   - 建议统一错误处理机制

3. **日志管理**
   - 日志分散在多个位置
   - 建议统一日志管理

4. **测试覆盖**
   - 缺少单元测试
   - 建议添加测试用例

---

## 8. 附录

### 8.1 相关文档

- [数据源清单](./01-数据源清单.md)
- [数据收集方式](./02-数据收集方式.md)
- [数据处理标准](./03-数据处理标准.md)
- [数据库表结构详细文档](./数据库表结构详细文档.md)

### 8.2 服务端接口文档

参考 `japan_server` 项目的实现：
- `/api/data/sensors` - 传感器数据接收
- `/api/data/feeders` - 喂食机数据接收
- `/api/data/operations` - 操作日志接收

---

**文档状态：** ✅ 已完成  
**最后更新：** 2025-01-XX





**评估日期：** 2025-01-XX  
**评估对象：** `/srv/ai_japan` - 日本陆上养殖实验室客户端服务器代码  
**评估依据：** 
- `docs/01-数据源清单.md`
- `docs/02-数据收集方式.md`
- `docs/03-数据处理标准.md`

---

## 执行摘要

`ai_japan` 项目是一个客户端数据采集和上传系统，部署在日本陆上养殖实验室的客户端服务器上。通过定时任务和触发式请求，将采集的数据发送到服务端。

**总体评估：** ⚠️ **部分满足** - 核心传感器数据采集和上传功能已实现，但缺少部分数据源的支持。

**满足度：** 约 **60%**

---

## 1. 已实现的数据收集功能

### 1.1 ✅ 传感器数据收集（完全满足）

**实现状态：** ✅ **已实现**

**实现位置：**
- `src/services/sensor_data_service.py` - 传感器数据采集服务
- `src/tasks/sensor_data_task.py` - 传感器数据采集任务
- `src/tasks/sensor_data_stream_task.py` - 传感器数据流式上传任务

**已支持的传感器：**
- ✅ 溶解氧传感器（COM18）
- ✅ 液位传感器（COM25）
- ✅ pH传感器（COM4）
- ✅ 浊度传感器（COM5）

**数据采集方式：**
- ✅ 定时自动采集（默认每10秒采样，可配置）
- ✅ 数据记录到CSV文件（`output/sensor/data_collection.csv`）
- ✅ 支持模拟模式（`AIJ_SENSOR_SIMULATE=1`）

**数据上传方式：**
- ✅ 流式上传（`SensorDataStreamTask`）：每10秒（可配置）推送数据到服务端
  - 目标URL：`http://8.216.33.92:5000/api/updata_sensor_data`
  - 数据格式：JSON，字段对齐CSV表头
- ✅ 批量上传（`client/updata.py`）：每10分钟执行一次，上传最近61天的CSV文件
  - 目标URL：`http://8.216.33.92:5000/api/updata_file`
  - 支持干运行模式（`AIJ_UPLOAD_DRY_RUN=1`）

**数据字段：**
- ✅ 时间戳
- ✅ 溶解氧饱和度
- ✅ 液位(mm)
- ✅ PH值
- ✅ PH温度(°C)
- ✅ 浊度(NTU)
- ✅ 浊度温度(°C)

**符合度评估：**
- ✅ 采集频率：符合要求（1-10分钟，当前为10秒，可调整）
- ✅ 数据格式：符合要求（结构化数据）
- ⚠️ 元数据完整性：**部分缺失**
  - ❌ 缺少 `device_id`（设备唯一标识）
  - ❌ 缺少 `batch_id`（批次ID）
  - ❌ 缺少 `pool_id`（池号/分区标识）
  - ❌ 缺少 `ts_utc` 和 `ts_local`（UTC和本地时间戳）
  - ❌ 缺少 `metric`（指标名称，如：do, ph, temp等）
  - ❌ 缺少 `unit`（计量单位，虽然CSV中有单位，但未作为独立字段）
  - ❌ 缺少 `quality_flag`（质量标记）
  - ❌ 缺少 `checksum`（完整性校验）

**改进建议：**
1. 在数据上传时补充完整的元数据字段
2. 添加设备ID配置（从配置文件或环境变量读取）
3. 添加批次ID和池号配置
4. 实现时间标准化（UTC + 本地时间）
5. 实现数据质量标记和校验和生成

---

### 1.2 ✅ 图像目标监测数据收集（部分满足）

**实现状态：** ⚠️ **部分实现**

**实现位置：**
- `src/services/camera_controller_service.py` - 摄像头控制服务
- `src/tasks/camera_controller_task.py` - 摄像头控制任务

**已实现功能：**
- ✅ 键盘触发录制（按键0-4触发对应摄像头）
- ✅ 视频录制（默认60秒，可配置）
- ✅ 视频保存到本地（`logs/videos/`）
- ✅ 录制状态上报（开始/结束事件发送到服务端）
  - 目标URL：`http://8.216.33.92:5000/api/camera_device_status`
- ✅ 视频抽帧（按固定间隔抽取帧，默认1秒）
- ✅ 图片上传（抽帧后的图片上传到服务端）
  - 目标URL：`http://8.216.33.92:5000/api/updata_camera_data`
  - 支持干运行模式（`AIJ_CAMERA_UPLOAD_DRY_RUN=1`）

**上传的元数据：**
- ✅ `camera_index`（摄像头索引）
- ✅ `video_name`（视频名称）
- ✅ `timestamp`（时间戳，ISO格式）

**缺失功能：**
- ❌ 缺少 `batch_id`（批次ID）
- ❌ 缺少 `pool_id`（池号/分区）
- ❌ 缺少图像检测结果上传（检测数量、长度、高度、体重等）
- ❌ 缺少模型信息（`model_name`, `model_version`）
- ❌ 缺少置信度信息（`confidence_avg`）
- ❌ 缺少图像元数据（分辨率、格式、编解码等）

**符合度评估：**
- ✅ 触发方式：符合要求（用户触发）
- ✅ 图像采集：符合要求
- ✅ 图像上传：符合要求
- ❌ 检测结果：**未实现** - 图像检测结果（count, avg_length_mm等）需要服务端AI模型推理后返回，客户端未实现结果接收和上报
- ⚠️ 元数据完整性：**部分缺失**

**改进建议：**
1. 在图像上传时补充 `batch_id` 和 `pool_id`
2. 实现图像检测结果接收（从服务端API获取检测结果）
3. 实现检测结果上报（将检测结果发送到服务端）
4. 补充完整的图像元数据（分辨率、格式等）

---

### 1.3 ✅ 喂食机数据收集（部分满足）

**实现状态：** ⚠️ **部分实现**

**实现位置：**
- `src/services/feeder_service.py` - 喂食机服务
- `src/tasks/feed_device_schedule_task.py` - 定时喂食任务
- `src/tasks/feed_device_status_task.py` - 喂食机状态上报任务

**已实现功能：**
- ✅ 云端喂食机接口封装（登录、设备查询、状态查询、喂食指令）
- ✅ 定时喂食（按时间列表触发，默认04:00、10:00、16:00、22:00）
- ✅ 喂食机状态上报（每10分钟执行一次，可配置）
- ✅ 支持多份量喂食（高份量4份，低份量2份）

**缺失功能：**
- ❌ 缺少喂食记录上传（`feeders_logs` 表所需的数据）
- ❌ 缺少 `batch_id`（批次ID）
- ❌ 缺少 `pool_id`（池号/分区）
- ❌ 缺少 `feed_amount_g`（投喂量，克）
- ❌ 缺少 `run_time_s`（运行时长，秒）
- ❌ 缺少 `leftover_estimate_g`（剩余饵料估计，克）
- ❌ 缺少 `checksum`（完整性校验）

**符合度评估：**
- ✅ 设备控制：符合要求（可以控制喂食机）
- ✅ 定时触发：符合要求
- ❌ 数据记录：**未实现** - 喂食操作后未记录和上传喂食日志数据

**改进建议：**
1. 实现喂食记录生成（每次喂食后生成记录）
2. 实现喂食记录上传（发送到服务端 `/api/data/feeders` 端点）
3. 补充完整的元数据字段（batch_id, pool_id, feed_amount_g等）
4. 从设备状态中提取运行时长、剩余饵料等信息

---

## 2. 未实现的数据收集功能

### 2.1 ❌ 操作日志数据收集（完全缺失）

**需求：** 人工录入操作日志（投料、水质调控、巡检、清洗等）

**缺失功能：**
- ❌ 操作日志录入界面
- ❌ 操作日志数据上传
- ❌ 附件上传功能（图片或文档）

**需要实现：**
1. 创建操作日志录入界面（Web界面或桌面应用）
2. 实现操作日志数据上传（POST `/api/data/operations`）
3. 实现附件上传功能

**数据字段要求：**
- `operator_id`：操作人ID
- `batch_id`：批次ID
- `pool_id`：池号/分区
- `ts_utc`, `ts_local`：时间戳
- `action_type`：操作类型（枚举值）
- `remarks`：备注
- `attachment_uri`：附件URI（可选）

---

### 2.2 ❌ 养殖手册文档收集（完全缺失）

**需求：** 人工上传养殖手册/文档（PDF、Word、TXT等）

**缺失功能：**
- ❌ 文档上传界面
- ❌ 文档上传功能
- ❌ 文档版本管理

**需要实现：**
1. 创建文档上传界面
2. 实现文档上传（POST `/api/data/manuals`）
3. 实现文档版本管理

**数据字段要求：**
- `doc_uri`：文档URI
- `version`：版本号
- `source`：来源
- `notes`：备注

---

### 2.3 ❌ 往期养殖记录收集（完全缺失）

**需求：** 批量导入历史数据（CSV、Excel、JSON等）

**缺失功能：**
- ❌ 历史数据导入界面
- ❌ 历史数据导入功能
- ❌ 数据清洗和验证

**需要实现：**
1. 创建历史数据导入界面
2. 实现数据导入功能（批量导入到 `history_records` 表）
3. 实现数据清洗和验证

**数据字段要求：**
- `batch_id`：批次ID
- `metric_name`：指标名称
- `value`：值（文本存储）
- `unit`：单位
- `ts_utc`, `ts_local`：时间戳
- `notes`：备注

---

### 2.4 ❌ 当期养殖记录收集（完全缺失）

**需求：** 批次信息管理（创建、更新批次）

**缺失功能：**
- ❌ 批次创建界面
- ❌ 批次信息管理
- ❌ 批次数据更新

**需要实现：**
1. 创建批次管理界面
2. 实现批次创建和更新（POST `/api/batches`）
3. 实现批次信息查询

**数据字段要求：**
- `pool_id`：池号/分区标识
- `species`：物种（默认：Litopenaeus vannamei）
- `location`：场地/车间位置
- `seed_origin`：苗种来源
- `stocking_density`：放养密度
- `start_date`：开始日期
- `end_date`：结束日期（可选）
- `notes`：备注

---

## 3. 数据上传接口对比

### 3.1 已实现的接口

| 接口路径 | 实现位置 | 数据源 | 状态 |
|---------|---------|--------|------|
| `/api/updata_sensor_data` | `SensorDataStreamTask` | 传感器数据（流式） | ✅ 已实现 |
| `/api/updata_file` | `client/updata.py` | 传感器数据/操作日志/图像（批量） | ✅ 已实现 |
| `/api/camera_device_status` | `CameraControllerService` | 摄像头状态 | ✅ 已实现 |
| `/api/updata_camera_data` | `CameraControllerService` | 摄像头图像 | ✅ 已实现 |

### 3.2 服务端已提供但客户端未使用的接口

根据 `japan_server` 项目的实现，服务端已提供以下接口，但客户端未使用：

| 接口路径 | 服务端实现 | 客户端使用 | 说明 |
|---------|-----------|-----------|------|
| `/api/data/sensors` | ✅ `routes/data_collection_routes.py` | ❌ 未使用 | 传感器数据接收（推荐使用） |
| `/api/data/feeders` | ✅ `routes/data_collection_routes.py` | ❌ 未使用 | 喂食机数据接收 |
| `/api/data/operations` | ✅ `routes/data_collection_routes.py` | ❌ 未使用 | 操作日志接收 |
| `/api/data/cameras` | ❌ 未实现 | ❌ 未使用 | 摄像头图像接收（需要实现） |
| `/api/data/manuals` | ❌ 未实现 | ❌ 未使用 | 文档上传（需要实现） |

**建议：**
1. 将传感器数据流式上传改为使用 `/api/data/sensors` 接口
2. 实现喂食机数据上传到 `/api/data/feeders` 接口
3. 实现操作日志上传到 `/api/data/operations` 接口
4. 服务端需要实现 `/api/data/cameras` 和 `/api/data/manuals` 接口

---

## 4. 元数据完整性对比

### 4.1 传感器数据元数据对比

| 字段 | 要求 | 当前实现 | 状态 |
|------|------|---------|------|
| `device_id` | ✅ 必填 | ❌ 缺失 | ❌ |
| `batch_id` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `pool_id` | ✅ 必填 | ❌ 缺失 | ❌ |
| `ts_utc` | ✅ 必填 | ❌ 缺失 | ❌ |
| `ts_local` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `metric` | ✅ 必填 | ❌ 缺失 | ❌ |
| `value` | ✅ 必填 | ✅ 有 | ✅ |
| `unit` | ⚠️ 条件必填 | ⚠️ 部分（在CSV列名中） | ⚠️ |
| `quality_flag` | ✅ 必填 | ❌ 缺失 | ❌ |
| `checksum` | ⚠️ 推荐 | ❌ 缺失 | ❌ |

**符合度：** 约 **20%**

---

### 4.2 图像数据元数据对比

| 字段 | 要求 | 当前实现 | 状态 |
|------|------|---------|------|
| `camera_id` | ✅ 必填 | ✅ 有（camera_index） | ✅ |
| `batch_id` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `pool_id` | ✅ 必填 | ❌ 缺失 | ❌ |
| `ts_utc` | ✅ 必填 | ⚠️ 部分（timestamp） | ⚠️ |
| `ts_local` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `storage_uri` | ✅ 必填 | ❌ 缺失 | ❌ |
| `width_px` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `height_px` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `format` | ⚠️ 推荐 | ⚠️ 部分（jpg） | ⚠️ |
| `codec` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `quality_flag` | ✅ 必填 | ❌ 缺失 | ❌ |
| `checksum` | ⚠️ 推荐 | ❌ 缺失 | ❌ |

**符合度：** 约 **25%**

---

### 4.3 喂食机数据元数据对比

| 字段 | 要求 | 当前实现 | 状态 |
|------|------|---------|------|
| `feeder_id` | ✅ 必填 | ✅ 有（dev_id） | ✅ |
| `batch_id` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `pool_id` | ✅ 必填 | ❌ 缺失 | ❌ |
| `ts_utc` | ✅ 必填 | ❌ 缺失 | ❌ |
| `ts_local` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `feed_amount_g` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `run_time_s` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `status` | ✅ 必填 | ⚠️ 部分（从设备状态获取） | ⚠️ |
| `leftover_estimate_g` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `notes` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `checksum` | ⚠️ 推荐 | ❌ 缺失 | ❌ |

**符合度：** 约 **15%**

---

## 5. 数据质量处理

### 5.1 已实现

- ✅ 数据采集错误处理（重试机制）
- ✅ 网络上传错误处理（重试机制）
- ✅ 模拟模式支持（无硬件环境测试）

### 5.2 未实现

- ❌ 时间标准化（UTC + 本地时间）
- ❌ 单位统一转换
- ❌ 异常值检测
- ❌ 质量标记（quality_flag）
- ❌ 完整性校验（checksum）
- ❌ 数据清洗服务调用（服务端已实现 `DataCleaningService`，客户端未使用）

**改进建议：**
1. 在客户端实现基础的数据清洗（时间标准化、单位转换）
2. 或在上传前调用服务端的数据清洗接口
3. 实现质量标记和校验和生成

---

## 6. 配置管理

### 6.1 已实现的配置

- ✅ 环境变量配置（`AIJ_SENSOR_SIMULATE`, `AIJ_UPLOAD_DRY_RUN`等）
- ✅ 传感器配置（串口号、波特率等）
- ✅ 上传URL配置（可通过环境变量覆盖）

### 6.2 缺失的配置

- ❌ 设备ID配置（`device_id`, `camera_id`, `feeder_id`）
- ❌ 批次ID配置（`batch_id`）
- ❌ 池号配置（`pool_id`）
- ❌ 时区配置（用于生成本地时间戳）
- ❌ 配置文件管理（建议使用JSON或YAML配置文件）

**改进建议：**
1. 创建统一的配置文件（`config/client_config.json`）
2. 支持从配置文件读取设备ID、批次ID、池号等
3. 支持从环境变量覆盖配置

---

## 7. 总结与建议

### 7.1 满足度统计

| 数据源 | 实现状态 | 符合度 |
|--------|---------|--------|
| 传感器数据 | ✅ 已实现 | 60% |
| 图像目标监测 | ⚠️ 部分实现 | 40% |
| 喂食机数据 | ⚠️ 部分实现 | 30% |
| 操作日志 | ❌ 未实现 | 0% |
| 养殖手册文档 | ❌ 未实现 | 0% |
| 往期养殖记录 | ❌ 未实现 | 0% |
| 当期养殖记录 | ❌ 未实现 | 0% |

**总体符合度：** 约 **30%**

---

### 7.2 优先级改进建议

#### 🔴 高优先级（核心功能）

1. **补充传感器数据元数据**
   - 添加 `device_id`, `batch_id`, `pool_id`
   - 实现时间标准化（UTC + 本地时间）
   - 添加 `metric` 和 `unit` 字段
   - 实现质量标记和校验和

2. **实现喂食机数据记录和上传**
   - 每次喂食后生成记录
   - 上传到 `/api/data/feeders` 接口
   - 补充完整的元数据

3. **统一使用服务端标准接口**
   - 将传感器数据上传改为使用 `/api/data/sensors`
   - 实现喂食机数据上传到 `/api/data/feeders`

#### 🟡 中优先级（重要功能）

4. **实现操作日志录入和上传**
   - 创建操作日志录入界面
   - 实现上传到 `/api/data/operations` 接口

5. **完善图像数据元数据**
   - 补充 `batch_id`, `pool_id`
   - 添加图像尺寸、格式等元数据
   - 实现检测结果接收和上报

6. **实现配置管理**
   - 创建统一的配置文件
   - 支持设备ID、批次ID、池号等配置

#### 🟢 低优先级（辅助功能）

7. **实现文档上传功能**
   - 创建文档上传界面
   - 实现上传到 `/api/data/manuals` 接口

8. **实现历史数据导入**
   - 创建数据导入界面
   - 实现批量导入功能

9. **实现批次管理**
   - 创建批次管理界面
   - 实现批次创建和更新

---

### 7.3 技术债务

1. **代码组织**
   - 部分硬编码路径（如 `C:\Users\37897\Desktop\japan_data\`）
   - 建议使用配置文件管理路径

2. **错误处理**
   - 部分异常处理不够完善
   - 建议统一错误处理机制

3. **日志管理**
   - 日志分散在多个位置
   - 建议统一日志管理

4. **测试覆盖**
   - 缺少单元测试
   - 建议添加测试用例

---

## 8. 附录

### 8.1 相关文档

- [数据源清单](./01-数据源清单.md)
- [数据收集方式](./02-数据收集方式.md)
- [数据处理标准](./03-数据处理标准.md)
- [数据库表结构详细文档](./数据库表结构详细文档.md)

### 8.2 服务端接口文档

参考 `japan_server` 项目的实现：
- `/api/data/sensors` - 传感器数据接收
- `/api/data/feeders` - 喂食机数据接收
- `/api/data/operations` - 操作日志接收

---

**文档状态：** ✅ 已完成  
**最后更新：** 2025-01-XX




**评估日期：** 2025-01-XX  
**评估对象：** `/srv/ai_japan` - 日本陆上养殖实验室客户端服务器代码  
**评估依据：** 
- `docs/01-数据源清单.md`
- `docs/02-数据收集方式.md`
- `docs/03-数据处理标准.md`

---

## 执行摘要

`ai_japan` 项目是一个客户端数据采集和上传系统，部署在日本陆上养殖实验室的客户端服务器上。通过定时任务和触发式请求，将采集的数据发送到服务端。

**总体评估：** ⚠️ **部分满足** - 核心传感器数据采集和上传功能已实现，但缺少部分数据源的支持。

**满足度：** 约 **60%**

---

## 1. 已实现的数据收集功能

### 1.1 ✅ 传感器数据收集（完全满足）

**实现状态：** ✅ **已实现**

**实现位置：**
- `src/services/sensor_data_service.py` - 传感器数据采集服务
- `src/tasks/sensor_data_task.py` - 传感器数据采集任务
- `src/tasks/sensor_data_stream_task.py` - 传感器数据流式上传任务

**已支持的传感器：**
- ✅ 溶解氧传感器（COM18）
- ✅ 液位传感器（COM25）
- ✅ pH传感器（COM4）
- ✅ 浊度传感器（COM5）

**数据采集方式：**
- ✅ 定时自动采集（默认每10秒采样，可配置）
- ✅ 数据记录到CSV文件（`output/sensor/data_collection.csv`）
- ✅ 支持模拟模式（`AIJ_SENSOR_SIMULATE=1`）

**数据上传方式：**
- ✅ 流式上传（`SensorDataStreamTask`）：每10秒（可配置）推送数据到服务端
  - 目标URL：`http://8.216.33.92:5000/api/updata_sensor_data`
  - 数据格式：JSON，字段对齐CSV表头
- ✅ 批量上传（`client/updata.py`）：每10分钟执行一次，上传最近61天的CSV文件
  - 目标URL：`http://8.216.33.92:5000/api/updata_file`
  - 支持干运行模式（`AIJ_UPLOAD_DRY_RUN=1`）

**数据字段：**
- ✅ 时间戳
- ✅ 溶解氧饱和度
- ✅ 液位(mm)
- ✅ PH值
- ✅ PH温度(°C)
- ✅ 浊度(NTU)
- ✅ 浊度温度(°C)

**符合度评估：**
- ✅ 采集频率：符合要求（1-10分钟，当前为10秒，可调整）
- ✅ 数据格式：符合要求（结构化数据）
- ⚠️ 元数据完整性：**部分缺失**
  - ❌ 缺少 `device_id`（设备唯一标识）
  - ❌ 缺少 `batch_id`（批次ID）
  - ❌ 缺少 `pool_id`（池号/分区标识）
  - ❌ 缺少 `ts_utc` 和 `ts_local`（UTC和本地时间戳）
  - ❌ 缺少 `metric`（指标名称，如：do, ph, temp等）
  - ❌ 缺少 `unit`（计量单位，虽然CSV中有单位，但未作为独立字段）
  - ❌ 缺少 `quality_flag`（质量标记）
  - ❌ 缺少 `checksum`（完整性校验）

**改进建议：**
1. 在数据上传时补充完整的元数据字段
2. 添加设备ID配置（从配置文件或环境变量读取）
3. 添加批次ID和池号配置
4. 实现时间标准化（UTC + 本地时间）
5. 实现数据质量标记和校验和生成

---

### 1.2 ✅ 图像目标监测数据收集（部分满足）

**实现状态：** ⚠️ **部分实现**

**实现位置：**
- `src/services/camera_controller_service.py` - 摄像头控制服务
- `src/tasks/camera_controller_task.py` - 摄像头控制任务

**已实现功能：**
- ✅ 键盘触发录制（按键0-4触发对应摄像头）
- ✅ 视频录制（默认60秒，可配置）
- ✅ 视频保存到本地（`logs/videos/`）
- ✅ 录制状态上报（开始/结束事件发送到服务端）
  - 目标URL：`http://8.216.33.92:5000/api/camera_device_status`
- ✅ 视频抽帧（按固定间隔抽取帧，默认1秒）
- ✅ 图片上传（抽帧后的图片上传到服务端）
  - 目标URL：`http://8.216.33.92:5000/api/updata_camera_data`
  - 支持干运行模式（`AIJ_CAMERA_UPLOAD_DRY_RUN=1`）

**上传的元数据：**
- ✅ `camera_index`（摄像头索引）
- ✅ `video_name`（视频名称）
- ✅ `timestamp`（时间戳，ISO格式）

**缺失功能：**
- ❌ 缺少 `batch_id`（批次ID）
- ❌ 缺少 `pool_id`（池号/分区）
- ❌ 缺少图像检测结果上传（检测数量、长度、高度、体重等）
- ❌ 缺少模型信息（`model_name`, `model_version`）
- ❌ 缺少置信度信息（`confidence_avg`）
- ❌ 缺少图像元数据（分辨率、格式、编解码等）

**符合度评估：**
- ✅ 触发方式：符合要求（用户触发）
- ✅ 图像采集：符合要求
- ✅ 图像上传：符合要求
- ❌ 检测结果：**未实现** - 图像检测结果（count, avg_length_mm等）需要服务端AI模型推理后返回，客户端未实现结果接收和上报
- ⚠️ 元数据完整性：**部分缺失**

**改进建议：**
1. 在图像上传时补充 `batch_id` 和 `pool_id`
2. 实现图像检测结果接收（从服务端API获取检测结果）
3. 实现检测结果上报（将检测结果发送到服务端）
4. 补充完整的图像元数据（分辨率、格式等）

---

### 1.3 ✅ 喂食机数据收集（部分满足）

**实现状态：** ⚠️ **部分实现**

**实现位置：**
- `src/services/feeder_service.py` - 喂食机服务
- `src/tasks/feed_device_schedule_task.py` - 定时喂食任务
- `src/tasks/feed_device_status_task.py` - 喂食机状态上报任务

**已实现功能：**
- ✅ 云端喂食机接口封装（登录、设备查询、状态查询、喂食指令）
- ✅ 定时喂食（按时间列表触发，默认04:00、10:00、16:00、22:00）
- ✅ 喂食机状态上报（每10分钟执行一次，可配置）
- ✅ 支持多份量喂食（高份量4份，低份量2份）

**缺失功能：**
- ❌ 缺少喂食记录上传（`feeders_logs` 表所需的数据）
- ❌ 缺少 `batch_id`（批次ID）
- ❌ 缺少 `pool_id`（池号/分区）
- ❌ 缺少 `feed_amount_g`（投喂量，克）
- ❌ 缺少 `run_time_s`（运行时长，秒）
- ❌ 缺少 `leftover_estimate_g`（剩余饵料估计，克）
- ❌ 缺少 `checksum`（完整性校验）

**符合度评估：**
- ✅ 设备控制：符合要求（可以控制喂食机）
- ✅ 定时触发：符合要求
- ❌ 数据记录：**未实现** - 喂食操作后未记录和上传喂食日志数据

**改进建议：**
1. 实现喂食记录生成（每次喂食后生成记录）
2. 实现喂食记录上传（发送到服务端 `/api/data/feeders` 端点）
3. 补充完整的元数据字段（batch_id, pool_id, feed_amount_g等）
4. 从设备状态中提取运行时长、剩余饵料等信息

---

## 2. 未实现的数据收集功能

### 2.1 ❌ 操作日志数据收集（完全缺失）

**需求：** 人工录入操作日志（投料、水质调控、巡检、清洗等）

**缺失功能：**
- ❌ 操作日志录入界面
- ❌ 操作日志数据上传
- ❌ 附件上传功能（图片或文档）

**需要实现：**
1. 创建操作日志录入界面（Web界面或桌面应用）
2. 实现操作日志数据上传（POST `/api/data/operations`）
3. 实现附件上传功能

**数据字段要求：**
- `operator_id`：操作人ID
- `batch_id`：批次ID
- `pool_id`：池号/分区
- `ts_utc`, `ts_local`：时间戳
- `action_type`：操作类型（枚举值）
- `remarks`：备注
- `attachment_uri`：附件URI（可选）

---

### 2.2 ❌ 养殖手册文档收集（完全缺失）

**需求：** 人工上传养殖手册/文档（PDF、Word、TXT等）

**缺失功能：**
- ❌ 文档上传界面
- ❌ 文档上传功能
- ❌ 文档版本管理

**需要实现：**
1. 创建文档上传界面
2. 实现文档上传（POST `/api/data/manuals`）
3. 实现文档版本管理

**数据字段要求：**
- `doc_uri`：文档URI
- `version`：版本号
- `source`：来源
- `notes`：备注

---

### 2.3 ❌ 往期养殖记录收集（完全缺失）

**需求：** 批量导入历史数据（CSV、Excel、JSON等）

**缺失功能：**
- ❌ 历史数据导入界面
- ❌ 历史数据导入功能
- ❌ 数据清洗和验证

**需要实现：**
1. 创建历史数据导入界面
2. 实现数据导入功能（批量导入到 `history_records` 表）
3. 实现数据清洗和验证

**数据字段要求：**
- `batch_id`：批次ID
- `metric_name`：指标名称
- `value`：值（文本存储）
- `unit`：单位
- `ts_utc`, `ts_local`：时间戳
- `notes`：备注

---

### 2.4 ❌ 当期养殖记录收集（完全缺失）

**需求：** 批次信息管理（创建、更新批次）

**缺失功能：**
- ❌ 批次创建界面
- ❌ 批次信息管理
- ❌ 批次数据更新

**需要实现：**
1. 创建批次管理界面
2. 实现批次创建和更新（POST `/api/batches`）
3. 实现批次信息查询

**数据字段要求：**
- `pool_id`：池号/分区标识
- `species`：物种（默认：Litopenaeus vannamei）
- `location`：场地/车间位置
- `seed_origin`：苗种来源
- `stocking_density`：放养密度
- `start_date`：开始日期
- `end_date`：结束日期（可选）
- `notes`：备注

---

## 3. 数据上传接口对比

### 3.1 已实现的接口

| 接口路径 | 实现位置 | 数据源 | 状态 |
|---------|---------|--------|------|
| `/api/updata_sensor_data` | `SensorDataStreamTask` | 传感器数据（流式） | ✅ 已实现 |
| `/api/updata_file` | `client/updata.py` | 传感器数据/操作日志/图像（批量） | ✅ 已实现 |
| `/api/camera_device_status` | `CameraControllerService` | 摄像头状态 | ✅ 已实现 |
| `/api/updata_camera_data` | `CameraControllerService` | 摄像头图像 | ✅ 已实现 |

### 3.2 服务端已提供但客户端未使用的接口

根据 `japan_server` 项目的实现，服务端已提供以下接口，但客户端未使用：

| 接口路径 | 服务端实现 | 客户端使用 | 说明 |
|---------|-----------|-----------|------|
| `/api/data/sensors` | ✅ `routes/data_collection_routes.py` | ❌ 未使用 | 传感器数据接收（推荐使用） |
| `/api/data/feeders` | ✅ `routes/data_collection_routes.py` | ❌ 未使用 | 喂食机数据接收 |
| `/api/data/operations` | ✅ `routes/data_collection_routes.py` | ❌ 未使用 | 操作日志接收 |
| `/api/data/cameras` | ❌ 未实现 | ❌ 未使用 | 摄像头图像接收（需要实现） |
| `/api/data/manuals` | ❌ 未实现 | ❌ 未使用 | 文档上传（需要实现） |

**建议：**
1. 将传感器数据流式上传改为使用 `/api/data/sensors` 接口
2. 实现喂食机数据上传到 `/api/data/feeders` 接口
3. 实现操作日志上传到 `/api/data/operations` 接口
4. 服务端需要实现 `/api/data/cameras` 和 `/api/data/manuals` 接口

---

## 4. 元数据完整性对比

### 4.1 传感器数据元数据对比

| 字段 | 要求 | 当前实现 | 状态 |
|------|------|---------|------|
| `device_id` | ✅ 必填 | ❌ 缺失 | ❌ |
| `batch_id` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `pool_id` | ✅ 必填 | ❌ 缺失 | ❌ |
| `ts_utc` | ✅ 必填 | ❌ 缺失 | ❌ |
| `ts_local` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `metric` | ✅ 必填 | ❌ 缺失 | ❌ |
| `value` | ✅ 必填 | ✅ 有 | ✅ |
| `unit` | ⚠️ 条件必填 | ⚠️ 部分（在CSV列名中） | ⚠️ |
| `quality_flag` | ✅ 必填 | ❌ 缺失 | ❌ |
| `checksum` | ⚠️ 推荐 | ❌ 缺失 | ❌ |

**符合度：** 约 **20%**

---

### 4.2 图像数据元数据对比

| 字段 | 要求 | 当前实现 | 状态 |
|------|------|---------|------|
| `camera_id` | ✅ 必填 | ✅ 有（camera_index） | ✅ |
| `batch_id` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `pool_id` | ✅ 必填 | ❌ 缺失 | ❌ |
| `ts_utc` | ✅ 必填 | ⚠️ 部分（timestamp） | ⚠️ |
| `ts_local` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `storage_uri` | ✅ 必填 | ❌ 缺失 | ❌ |
| `width_px` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `height_px` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `format` | ⚠️ 推荐 | ⚠️ 部分（jpg） | ⚠️ |
| `codec` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `quality_flag` | ✅ 必填 | ❌ 缺失 | ❌ |
| `checksum` | ⚠️ 推荐 | ❌ 缺失 | ❌ |

**符合度：** 约 **25%**

---

### 4.3 喂食机数据元数据对比

| 字段 | 要求 | 当前实现 | 状态 |
|------|------|---------|------|
| `feeder_id` | ✅ 必填 | ✅ 有（dev_id） | ✅ |
| `batch_id` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `pool_id` | ✅ 必填 | ❌ 缺失 | ❌ |
| `ts_utc` | ✅ 必填 | ❌ 缺失 | ❌ |
| `ts_local` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `feed_amount_g` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `run_time_s` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `status` | ✅ 必填 | ⚠️ 部分（从设备状态获取） | ⚠️ |
| `leftover_estimate_g` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `notes` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `checksum` | ⚠️ 推荐 | ❌ 缺失 | ❌ |

**符合度：** 约 **15%**

---

## 5. 数据质量处理

### 5.1 已实现

- ✅ 数据采集错误处理（重试机制）
- ✅ 网络上传错误处理（重试机制）
- ✅ 模拟模式支持（无硬件环境测试）

### 5.2 未实现

- ❌ 时间标准化（UTC + 本地时间）
- ❌ 单位统一转换
- ❌ 异常值检测
- ❌ 质量标记（quality_flag）
- ❌ 完整性校验（checksum）
- ❌ 数据清洗服务调用（服务端已实现 `DataCleaningService`，客户端未使用）

**改进建议：**
1. 在客户端实现基础的数据清洗（时间标准化、单位转换）
2. 或在上传前调用服务端的数据清洗接口
3. 实现质量标记和校验和生成

---

## 6. 配置管理

### 6.1 已实现的配置

- ✅ 环境变量配置（`AIJ_SENSOR_SIMULATE`, `AIJ_UPLOAD_DRY_RUN`等）
- ✅ 传感器配置（串口号、波特率等）
- ✅ 上传URL配置（可通过环境变量覆盖）

### 6.2 缺失的配置

- ❌ 设备ID配置（`device_id`, `camera_id`, `feeder_id`）
- ❌ 批次ID配置（`batch_id`）
- ❌ 池号配置（`pool_id`）
- ❌ 时区配置（用于生成本地时间戳）
- ❌ 配置文件管理（建议使用JSON或YAML配置文件）

**改进建议：**
1. 创建统一的配置文件（`config/client_config.json`）
2. 支持从配置文件读取设备ID、批次ID、池号等
3. 支持从环境变量覆盖配置

---

## 7. 总结与建议

### 7.1 满足度统计

| 数据源 | 实现状态 | 符合度 |
|--------|---------|--------|
| 传感器数据 | ✅ 已实现 | 60% |
| 图像目标监测 | ⚠️ 部分实现 | 40% |
| 喂食机数据 | ⚠️ 部分实现 | 30% |
| 操作日志 | ❌ 未实现 | 0% |
| 养殖手册文档 | ❌ 未实现 | 0% |
| 往期养殖记录 | ❌ 未实现 | 0% |
| 当期养殖记录 | ❌ 未实现 | 0% |

**总体符合度：** 约 **30%**

---

### 7.2 优先级改进建议

#### 🔴 高优先级（核心功能）

1. **补充传感器数据元数据**
   - 添加 `device_id`, `batch_id`, `pool_id`
   - 实现时间标准化（UTC + 本地时间）
   - 添加 `metric` 和 `unit` 字段
   - 实现质量标记和校验和

2. **实现喂食机数据记录和上传**
   - 每次喂食后生成记录
   - 上传到 `/api/data/feeders` 接口
   - 补充完整的元数据

3. **统一使用服务端标准接口**
   - 将传感器数据上传改为使用 `/api/data/sensors`
   - 实现喂食机数据上传到 `/api/data/feeders`

#### 🟡 中优先级（重要功能）

4. **实现操作日志录入和上传**
   - 创建操作日志录入界面
   - 实现上传到 `/api/data/operations` 接口

5. **完善图像数据元数据**
   - 补充 `batch_id`, `pool_id`
   - 添加图像尺寸、格式等元数据
   - 实现检测结果接收和上报

6. **实现配置管理**
   - 创建统一的配置文件
   - 支持设备ID、批次ID、池号等配置

#### 🟢 低优先级（辅助功能）

7. **实现文档上传功能**
   - 创建文档上传界面
   - 实现上传到 `/api/data/manuals` 接口

8. **实现历史数据导入**
   - 创建数据导入界面
   - 实现批量导入功能

9. **实现批次管理**
   - 创建批次管理界面
   - 实现批次创建和更新

---

### 7.3 技术债务

1. **代码组织**
   - 部分硬编码路径（如 `C:\Users\37897\Desktop\japan_data\`）
   - 建议使用配置文件管理路径

2. **错误处理**
   - 部分异常处理不够完善
   - 建议统一错误处理机制

3. **日志管理**
   - 日志分散在多个位置
   - 建议统一日志管理

4. **测试覆盖**
   - 缺少单元测试
   - 建议添加测试用例

---

## 8. 附录

### 8.1 相关文档

- [数据源清单](./01-数据源清单.md)
- [数据收集方式](./02-数据收集方式.md)
- [数据处理标准](./03-数据处理标准.md)
- [数据库表结构详细文档](./数据库表结构详细文档.md)

### 8.2 服务端接口文档

参考 `japan_server` 项目的实现：
- `/api/data/sensors` - 传感器数据接收
- `/api/data/feeders` - 喂食机数据接收
- `/api/data/operations` - 操作日志接收

---

**文档状态：** ✅ 已完成  
**最后更新：** 2025-01-XX





**评估日期：** 2025-01-XX  
**评估对象：** `/srv/ai_japan` - 日本陆上养殖实验室客户端服务器代码  
**评估依据：** 
- `docs/01-数据源清单.md`
- `docs/02-数据收集方式.md`
- `docs/03-数据处理标准.md`

---

## 执行摘要

`ai_japan` 项目是一个客户端数据采集和上传系统，部署在日本陆上养殖实验室的客户端服务器上。通过定时任务和触发式请求，将采集的数据发送到服务端。

**总体评估：** ⚠️ **部分满足** - 核心传感器数据采集和上传功能已实现，但缺少部分数据源的支持。

**满足度：** 约 **60%**

---

## 1. 已实现的数据收集功能

### 1.1 ✅ 传感器数据收集（完全满足）

**实现状态：** ✅ **已实现**

**实现位置：**
- `src/services/sensor_data_service.py` - 传感器数据采集服务
- `src/tasks/sensor_data_task.py` - 传感器数据采集任务
- `src/tasks/sensor_data_stream_task.py` - 传感器数据流式上传任务

**已支持的传感器：**
- ✅ 溶解氧传感器（COM18）
- ✅ 液位传感器（COM25）
- ✅ pH传感器（COM4）
- ✅ 浊度传感器（COM5）

**数据采集方式：**
- ✅ 定时自动采集（默认每10秒采样，可配置）
- ✅ 数据记录到CSV文件（`output/sensor/data_collection.csv`）
- ✅ 支持模拟模式（`AIJ_SENSOR_SIMULATE=1`）

**数据上传方式：**
- ✅ 流式上传（`SensorDataStreamTask`）：每10秒（可配置）推送数据到服务端
  - 目标URL：`http://8.216.33.92:5000/api/updata_sensor_data`
  - 数据格式：JSON，字段对齐CSV表头
- ✅ 批量上传（`client/updata.py`）：每10分钟执行一次，上传最近61天的CSV文件
  - 目标URL：`http://8.216.33.92:5000/api/updata_file`
  - 支持干运行模式（`AIJ_UPLOAD_DRY_RUN=1`）

**数据字段：**
- ✅ 时间戳
- ✅ 溶解氧饱和度
- ✅ 液位(mm)
- ✅ PH值
- ✅ PH温度(°C)
- ✅ 浊度(NTU)
- ✅ 浊度温度(°C)

**符合度评估：**
- ✅ 采集频率：符合要求（1-10分钟，当前为10秒，可调整）
- ✅ 数据格式：符合要求（结构化数据）
- ⚠️ 元数据完整性：**部分缺失**
  - ❌ 缺少 `device_id`（设备唯一标识）
  - ❌ 缺少 `batch_id`（批次ID）
  - ❌ 缺少 `pool_id`（池号/分区标识）
  - ❌ 缺少 `ts_utc` 和 `ts_local`（UTC和本地时间戳）
  - ❌ 缺少 `metric`（指标名称，如：do, ph, temp等）
  - ❌ 缺少 `unit`（计量单位，虽然CSV中有单位，但未作为独立字段）
  - ❌ 缺少 `quality_flag`（质量标记）
  - ❌ 缺少 `checksum`（完整性校验）

**改进建议：**
1. 在数据上传时补充完整的元数据字段
2. 添加设备ID配置（从配置文件或环境变量读取）
3. 添加批次ID和池号配置
4. 实现时间标准化（UTC + 本地时间）
5. 实现数据质量标记和校验和生成

---

### 1.2 ✅ 图像目标监测数据收集（部分满足）

**实现状态：** ⚠️ **部分实现**

**实现位置：**
- `src/services/camera_controller_service.py` - 摄像头控制服务
- `src/tasks/camera_controller_task.py` - 摄像头控制任务

**已实现功能：**
- ✅ 键盘触发录制（按键0-4触发对应摄像头）
- ✅ 视频录制（默认60秒，可配置）
- ✅ 视频保存到本地（`logs/videos/`）
- ✅ 录制状态上报（开始/结束事件发送到服务端）
  - 目标URL：`http://8.216.33.92:5000/api/camera_device_status`
- ✅ 视频抽帧（按固定间隔抽取帧，默认1秒）
- ✅ 图片上传（抽帧后的图片上传到服务端）
  - 目标URL：`http://8.216.33.92:5000/api/updata_camera_data`
  - 支持干运行模式（`AIJ_CAMERA_UPLOAD_DRY_RUN=1`）

**上传的元数据：**
- ✅ `camera_index`（摄像头索引）
- ✅ `video_name`（视频名称）
- ✅ `timestamp`（时间戳，ISO格式）

**缺失功能：**
- ❌ 缺少 `batch_id`（批次ID）
- ❌ 缺少 `pool_id`（池号/分区）
- ❌ 缺少图像检测结果上传（检测数量、长度、高度、体重等）
- ❌ 缺少模型信息（`model_name`, `model_version`）
- ❌ 缺少置信度信息（`confidence_avg`）
- ❌ 缺少图像元数据（分辨率、格式、编解码等）

**符合度评估：**
- ✅ 触发方式：符合要求（用户触发）
- ✅ 图像采集：符合要求
- ✅ 图像上传：符合要求
- ❌ 检测结果：**未实现** - 图像检测结果（count, avg_length_mm等）需要服务端AI模型推理后返回，客户端未实现结果接收和上报
- ⚠️ 元数据完整性：**部分缺失**

**改进建议：**
1. 在图像上传时补充 `batch_id` 和 `pool_id`
2. 实现图像检测结果接收（从服务端API获取检测结果）
3. 实现检测结果上报（将检测结果发送到服务端）
4. 补充完整的图像元数据（分辨率、格式等）

---

### 1.3 ✅ 喂食机数据收集（部分满足）

**实现状态：** ⚠️ **部分实现**

**实现位置：**
- `src/services/feeder_service.py` - 喂食机服务
- `src/tasks/feed_device_schedule_task.py` - 定时喂食任务
- `src/tasks/feed_device_status_task.py` - 喂食机状态上报任务

**已实现功能：**
- ✅ 云端喂食机接口封装（登录、设备查询、状态查询、喂食指令）
- ✅ 定时喂食（按时间列表触发，默认04:00、10:00、16:00、22:00）
- ✅ 喂食机状态上报（每10分钟执行一次，可配置）
- ✅ 支持多份量喂食（高份量4份，低份量2份）

**缺失功能：**
- ❌ 缺少喂食记录上传（`feeders_logs` 表所需的数据）
- ❌ 缺少 `batch_id`（批次ID）
- ❌ 缺少 `pool_id`（池号/分区）
- ❌ 缺少 `feed_amount_g`（投喂量，克）
- ❌ 缺少 `run_time_s`（运行时长，秒）
- ❌ 缺少 `leftover_estimate_g`（剩余饵料估计，克）
- ❌ 缺少 `checksum`（完整性校验）

**符合度评估：**
- ✅ 设备控制：符合要求（可以控制喂食机）
- ✅ 定时触发：符合要求
- ❌ 数据记录：**未实现** - 喂食操作后未记录和上传喂食日志数据

**改进建议：**
1. 实现喂食记录生成（每次喂食后生成记录）
2. 实现喂食记录上传（发送到服务端 `/api/data/feeders` 端点）
3. 补充完整的元数据字段（batch_id, pool_id, feed_amount_g等）
4. 从设备状态中提取运行时长、剩余饵料等信息

---

## 2. 未实现的数据收集功能

### 2.1 ❌ 操作日志数据收集（完全缺失）

**需求：** 人工录入操作日志（投料、水质调控、巡检、清洗等）

**缺失功能：**
- ❌ 操作日志录入界面
- ❌ 操作日志数据上传
- ❌ 附件上传功能（图片或文档）

**需要实现：**
1. 创建操作日志录入界面（Web界面或桌面应用）
2. 实现操作日志数据上传（POST `/api/data/operations`）
3. 实现附件上传功能

**数据字段要求：**
- `operator_id`：操作人ID
- `batch_id`：批次ID
- `pool_id`：池号/分区
- `ts_utc`, `ts_local`：时间戳
- `action_type`：操作类型（枚举值）
- `remarks`：备注
- `attachment_uri`：附件URI（可选）

---

### 2.2 ❌ 养殖手册文档收集（完全缺失）

**需求：** 人工上传养殖手册/文档（PDF、Word、TXT等）

**缺失功能：**
- ❌ 文档上传界面
- ❌ 文档上传功能
- ❌ 文档版本管理

**需要实现：**
1. 创建文档上传界面
2. 实现文档上传（POST `/api/data/manuals`）
3. 实现文档版本管理

**数据字段要求：**
- `doc_uri`：文档URI
- `version`：版本号
- `source`：来源
- `notes`：备注

---

### 2.3 ❌ 往期养殖记录收集（完全缺失）

**需求：** 批量导入历史数据（CSV、Excel、JSON等）

**缺失功能：**
- ❌ 历史数据导入界面
- ❌ 历史数据导入功能
- ❌ 数据清洗和验证

**需要实现：**
1. 创建历史数据导入界面
2. 实现数据导入功能（批量导入到 `history_records` 表）
3. 实现数据清洗和验证

**数据字段要求：**
- `batch_id`：批次ID
- `metric_name`：指标名称
- `value`：值（文本存储）
- `unit`：单位
- `ts_utc`, `ts_local`：时间戳
- `notes`：备注

---

### 2.4 ❌ 当期养殖记录收集（完全缺失）

**需求：** 批次信息管理（创建、更新批次）

**缺失功能：**
- ❌ 批次创建界面
- ❌ 批次信息管理
- ❌ 批次数据更新

**需要实现：**
1. 创建批次管理界面
2. 实现批次创建和更新（POST `/api/batches`）
3. 实现批次信息查询

**数据字段要求：**
- `pool_id`：池号/分区标识
- `species`：物种（默认：Litopenaeus vannamei）
- `location`：场地/车间位置
- `seed_origin`：苗种来源
- `stocking_density`：放养密度
- `start_date`：开始日期
- `end_date`：结束日期（可选）
- `notes`：备注

---

## 3. 数据上传接口对比

### 3.1 已实现的接口

| 接口路径 | 实现位置 | 数据源 | 状态 |
|---------|---------|--------|------|
| `/api/updata_sensor_data` | `SensorDataStreamTask` | 传感器数据（流式） | ✅ 已实现 |
| `/api/updata_file` | `client/updata.py` | 传感器数据/操作日志/图像（批量） | ✅ 已实现 |
| `/api/camera_device_status` | `CameraControllerService` | 摄像头状态 | ✅ 已实现 |
| `/api/updata_camera_data` | `CameraControllerService` | 摄像头图像 | ✅ 已实现 |

### 3.2 服务端已提供但客户端未使用的接口

根据 `japan_server` 项目的实现，服务端已提供以下接口，但客户端未使用：

| 接口路径 | 服务端实现 | 客户端使用 | 说明 |
|---------|-----------|-----------|------|
| `/api/data/sensors` | ✅ `routes/data_collection_routes.py` | ❌ 未使用 | 传感器数据接收（推荐使用） |
| `/api/data/feeders` | ✅ `routes/data_collection_routes.py` | ❌ 未使用 | 喂食机数据接收 |
| `/api/data/operations` | ✅ `routes/data_collection_routes.py` | ❌ 未使用 | 操作日志接收 |
| `/api/data/cameras` | ❌ 未实现 | ❌ 未使用 | 摄像头图像接收（需要实现） |
| `/api/data/manuals` | ❌ 未实现 | ❌ 未使用 | 文档上传（需要实现） |

**建议：**
1. 将传感器数据流式上传改为使用 `/api/data/sensors` 接口
2. 实现喂食机数据上传到 `/api/data/feeders` 接口
3. 实现操作日志上传到 `/api/data/operations` 接口
4. 服务端需要实现 `/api/data/cameras` 和 `/api/data/manuals` 接口

---

## 4. 元数据完整性对比

### 4.1 传感器数据元数据对比

| 字段 | 要求 | 当前实现 | 状态 |
|------|------|---------|------|
| `device_id` | ✅ 必填 | ❌ 缺失 | ❌ |
| `batch_id` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `pool_id` | ✅ 必填 | ❌ 缺失 | ❌ |
| `ts_utc` | ✅ 必填 | ❌ 缺失 | ❌ |
| `ts_local` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `metric` | ✅ 必填 | ❌ 缺失 | ❌ |
| `value` | ✅ 必填 | ✅ 有 | ✅ |
| `unit` | ⚠️ 条件必填 | ⚠️ 部分（在CSV列名中） | ⚠️ |
| `quality_flag` | ✅ 必填 | ❌ 缺失 | ❌ |
| `checksum` | ⚠️ 推荐 | ❌ 缺失 | ❌ |

**符合度：** 约 **20%**

---

### 4.2 图像数据元数据对比

| 字段 | 要求 | 当前实现 | 状态 |
|------|------|---------|------|
| `camera_id` | ✅ 必填 | ✅ 有（camera_index） | ✅ |
| `batch_id` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `pool_id` | ✅ 必填 | ❌ 缺失 | ❌ |
| `ts_utc` | ✅ 必填 | ⚠️ 部分（timestamp） | ⚠️ |
| `ts_local` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `storage_uri` | ✅ 必填 | ❌ 缺失 | ❌ |
| `width_px` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `height_px` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `format` | ⚠️ 推荐 | ⚠️ 部分（jpg） | ⚠️ |
| `codec` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `quality_flag` | ✅ 必填 | ❌ 缺失 | ❌ |
| `checksum` | ⚠️ 推荐 | ❌ 缺失 | ❌ |

**符合度：** 约 **25%**

---

### 4.3 喂食机数据元数据对比

| 字段 | 要求 | 当前实现 | 状态 |
|------|------|---------|------|
| `feeder_id` | ✅ 必填 | ✅ 有（dev_id） | ✅ |
| `batch_id` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `pool_id` | ✅ 必填 | ❌ 缺失 | ❌ |
| `ts_utc` | ✅ 必填 | ❌ 缺失 | ❌ |
| `ts_local` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `feed_amount_g` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `run_time_s` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `status` | ✅ 必填 | ⚠️ 部分（从设备状态获取） | ⚠️ |
| `leftover_estimate_g` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `notes` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `checksum` | ⚠️ 推荐 | ❌ 缺失 | ❌ |

**符合度：** 约 **15%**

---

## 5. 数据质量处理

### 5.1 已实现

- ✅ 数据采集错误处理（重试机制）
- ✅ 网络上传错误处理（重试机制）
- ✅ 模拟模式支持（无硬件环境测试）

### 5.2 未实现

- ❌ 时间标准化（UTC + 本地时间）
- ❌ 单位统一转换
- ❌ 异常值检测
- ❌ 质量标记（quality_flag）
- ❌ 完整性校验（checksum）
- ❌ 数据清洗服务调用（服务端已实现 `DataCleaningService`，客户端未使用）

**改进建议：**
1. 在客户端实现基础的数据清洗（时间标准化、单位转换）
2. 或在上传前调用服务端的数据清洗接口
3. 实现质量标记和校验和生成

---

## 6. 配置管理

### 6.1 已实现的配置

- ✅ 环境变量配置（`AIJ_SENSOR_SIMULATE`, `AIJ_UPLOAD_DRY_RUN`等）
- ✅ 传感器配置（串口号、波特率等）
- ✅ 上传URL配置（可通过环境变量覆盖）

### 6.2 缺失的配置

- ❌ 设备ID配置（`device_id`, `camera_id`, `feeder_id`）
- ❌ 批次ID配置（`batch_id`）
- ❌ 池号配置（`pool_id`）
- ❌ 时区配置（用于生成本地时间戳）
- ❌ 配置文件管理（建议使用JSON或YAML配置文件）

**改进建议：**
1. 创建统一的配置文件（`config/client_config.json`）
2. 支持从配置文件读取设备ID、批次ID、池号等
3. 支持从环境变量覆盖配置

---

## 7. 总结与建议

### 7.1 满足度统计

| 数据源 | 实现状态 | 符合度 |
|--------|---------|--------|
| 传感器数据 | ✅ 已实现 | 60% |
| 图像目标监测 | ⚠️ 部分实现 | 40% |
| 喂食机数据 | ⚠️ 部分实现 | 30% |
| 操作日志 | ❌ 未实现 | 0% |
| 养殖手册文档 | ❌ 未实现 | 0% |
| 往期养殖记录 | ❌ 未实现 | 0% |
| 当期养殖记录 | ❌ 未实现 | 0% |

**总体符合度：** 约 **30%**

---

### 7.2 优先级改进建议

#### 🔴 高优先级（核心功能）

1. **补充传感器数据元数据**
   - 添加 `device_id`, `batch_id`, `pool_id`
   - 实现时间标准化（UTC + 本地时间）
   - 添加 `metric` 和 `unit` 字段
   - 实现质量标记和校验和

2. **实现喂食机数据记录和上传**
   - 每次喂食后生成记录
   - 上传到 `/api/data/feeders` 接口
   - 补充完整的元数据

3. **统一使用服务端标准接口**
   - 将传感器数据上传改为使用 `/api/data/sensors`
   - 实现喂食机数据上传到 `/api/data/feeders`

#### 🟡 中优先级（重要功能）

4. **实现操作日志录入和上传**
   - 创建操作日志录入界面
   - 实现上传到 `/api/data/operations` 接口

5. **完善图像数据元数据**
   - 补充 `batch_id`, `pool_id`
   - 添加图像尺寸、格式等元数据
   - 实现检测结果接收和上报

6. **实现配置管理**
   - 创建统一的配置文件
   - 支持设备ID、批次ID、池号等配置

#### 🟢 低优先级（辅助功能）

7. **实现文档上传功能**
   - 创建文档上传界面
   - 实现上传到 `/api/data/manuals` 接口

8. **实现历史数据导入**
   - 创建数据导入界面
   - 实现批量导入功能

9. **实现批次管理**
   - 创建批次管理界面
   - 实现批次创建和更新

---

### 7.3 技术债务

1. **代码组织**
   - 部分硬编码路径（如 `C:\Users\37897\Desktop\japan_data\`）
   - 建议使用配置文件管理路径

2. **错误处理**
   - 部分异常处理不够完善
   - 建议统一错误处理机制

3. **日志管理**
   - 日志分散在多个位置
   - 建议统一日志管理

4. **测试覆盖**
   - 缺少单元测试
   - 建议添加测试用例

---

## 8. 附录

### 8.1 相关文档

- [数据源清单](./01-数据源清单.md)
- [数据收集方式](./02-数据收集方式.md)
- [数据处理标准](./03-数据处理标准.md)
- [数据库表结构详细文档](./数据库表结构详细文档.md)

### 8.2 服务端接口文档

参考 `japan_server` 项目的实现：
- `/api/data/sensors` - 传感器数据接收
- `/api/data/feeders` - 喂食机数据接收
- `/api/data/operations` - 操作日志接收

---

**文档状态：** ✅ 已完成  
**最后更新：** 2025-01-XX




**评估日期：** 2025-01-XX  
**评估对象：** `/srv/ai_japan` - 日本陆上养殖实验室客户端服务器代码  
**评估依据：** 
- `docs/01-数据源清单.md`
- `docs/02-数据收集方式.md`
- `docs/03-数据处理标准.md`

---

## 执行摘要

`ai_japan` 项目是一个客户端数据采集和上传系统，部署在日本陆上养殖实验室的客户端服务器上。通过定时任务和触发式请求，将采集的数据发送到服务端。

**总体评估：** ⚠️ **部分满足** - 核心传感器数据采集和上传功能已实现，但缺少部分数据源的支持。

**满足度：** 约 **60%**

---

## 1. 已实现的数据收集功能

### 1.1 ✅ 传感器数据收集（完全满足）

**实现状态：** ✅ **已实现**

**实现位置：**
- `src/services/sensor_data_service.py` - 传感器数据采集服务
- `src/tasks/sensor_data_task.py` - 传感器数据采集任务
- `src/tasks/sensor_data_stream_task.py` - 传感器数据流式上传任务

**已支持的传感器：**
- ✅ 溶解氧传感器（COM18）
- ✅ 液位传感器（COM25）
- ✅ pH传感器（COM4）
- ✅ 浊度传感器（COM5）

**数据采集方式：**
- ✅ 定时自动采集（默认每10秒采样，可配置）
- ✅ 数据记录到CSV文件（`output/sensor/data_collection.csv`）
- ✅ 支持模拟模式（`AIJ_SENSOR_SIMULATE=1`）

**数据上传方式：**
- ✅ 流式上传（`SensorDataStreamTask`）：每10秒（可配置）推送数据到服务端
  - 目标URL：`http://8.216.33.92:5000/api/updata_sensor_data`
  - 数据格式：JSON，字段对齐CSV表头
- ✅ 批量上传（`client/updata.py`）：每10分钟执行一次，上传最近61天的CSV文件
  - 目标URL：`http://8.216.33.92:5000/api/updata_file`
  - 支持干运行模式（`AIJ_UPLOAD_DRY_RUN=1`）

**数据字段：**
- ✅ 时间戳
- ✅ 溶解氧饱和度
- ✅ 液位(mm)
- ✅ PH值
- ✅ PH温度(°C)
- ✅ 浊度(NTU)
- ✅ 浊度温度(°C)

**符合度评估：**
- ✅ 采集频率：符合要求（1-10分钟，当前为10秒，可调整）
- ✅ 数据格式：符合要求（结构化数据）
- ⚠️ 元数据完整性：**部分缺失**
  - ❌ 缺少 `device_id`（设备唯一标识）
  - ❌ 缺少 `batch_id`（批次ID）
  - ❌ 缺少 `pool_id`（池号/分区标识）
  - ❌ 缺少 `ts_utc` 和 `ts_local`（UTC和本地时间戳）
  - ❌ 缺少 `metric`（指标名称，如：do, ph, temp等）
  - ❌ 缺少 `unit`（计量单位，虽然CSV中有单位，但未作为独立字段）
  - ❌ 缺少 `quality_flag`（质量标记）
  - ❌ 缺少 `checksum`（完整性校验）

**改进建议：**
1. 在数据上传时补充完整的元数据字段
2. 添加设备ID配置（从配置文件或环境变量读取）
3. 添加批次ID和池号配置
4. 实现时间标准化（UTC + 本地时间）
5. 实现数据质量标记和校验和生成

---

### 1.2 ✅ 图像目标监测数据收集（部分满足）

**实现状态：** ⚠️ **部分实现**

**实现位置：**
- `src/services/camera_controller_service.py` - 摄像头控制服务
- `src/tasks/camera_controller_task.py` - 摄像头控制任务

**已实现功能：**
- ✅ 键盘触发录制（按键0-4触发对应摄像头）
- ✅ 视频录制（默认60秒，可配置）
- ✅ 视频保存到本地（`logs/videos/`）
- ✅ 录制状态上报（开始/结束事件发送到服务端）
  - 目标URL：`http://8.216.33.92:5000/api/camera_device_status`
- ✅ 视频抽帧（按固定间隔抽取帧，默认1秒）
- ✅ 图片上传（抽帧后的图片上传到服务端）
  - 目标URL：`http://8.216.33.92:5000/api/updata_camera_data`
  - 支持干运行模式（`AIJ_CAMERA_UPLOAD_DRY_RUN=1`）

**上传的元数据：**
- ✅ `camera_index`（摄像头索引）
- ✅ `video_name`（视频名称）
- ✅ `timestamp`（时间戳，ISO格式）

**缺失功能：**
- ❌ 缺少 `batch_id`（批次ID）
- ❌ 缺少 `pool_id`（池号/分区）
- ❌ 缺少图像检测结果上传（检测数量、长度、高度、体重等）
- ❌ 缺少模型信息（`model_name`, `model_version`）
- ❌ 缺少置信度信息（`confidence_avg`）
- ❌ 缺少图像元数据（分辨率、格式、编解码等）

**符合度评估：**
- ✅ 触发方式：符合要求（用户触发）
- ✅ 图像采集：符合要求
- ✅ 图像上传：符合要求
- ❌ 检测结果：**未实现** - 图像检测结果（count, avg_length_mm等）需要服务端AI模型推理后返回，客户端未实现结果接收和上报
- ⚠️ 元数据完整性：**部分缺失**

**改进建议：**
1. 在图像上传时补充 `batch_id` 和 `pool_id`
2. 实现图像检测结果接收（从服务端API获取检测结果）
3. 实现检测结果上报（将检测结果发送到服务端）
4. 补充完整的图像元数据（分辨率、格式等）

---

### 1.3 ✅ 喂食机数据收集（部分满足）

**实现状态：** ⚠️ **部分实现**

**实现位置：**
- `src/services/feeder_service.py` - 喂食机服务
- `src/tasks/feed_device_schedule_task.py` - 定时喂食任务
- `src/tasks/feed_device_status_task.py` - 喂食机状态上报任务

**已实现功能：**
- ✅ 云端喂食机接口封装（登录、设备查询、状态查询、喂食指令）
- ✅ 定时喂食（按时间列表触发，默认04:00、10:00、16:00、22:00）
- ✅ 喂食机状态上报（每10分钟执行一次，可配置）
- ✅ 支持多份量喂食（高份量4份，低份量2份）

**缺失功能：**
- ❌ 缺少喂食记录上传（`feeders_logs` 表所需的数据）
- ❌ 缺少 `batch_id`（批次ID）
- ❌ 缺少 `pool_id`（池号/分区）
- ❌ 缺少 `feed_amount_g`（投喂量，克）
- ❌ 缺少 `run_time_s`（运行时长，秒）
- ❌ 缺少 `leftover_estimate_g`（剩余饵料估计，克）
- ❌ 缺少 `checksum`（完整性校验）

**符合度评估：**
- ✅ 设备控制：符合要求（可以控制喂食机）
- ✅ 定时触发：符合要求
- ❌ 数据记录：**未实现** - 喂食操作后未记录和上传喂食日志数据

**改进建议：**
1. 实现喂食记录生成（每次喂食后生成记录）
2. 实现喂食记录上传（发送到服务端 `/api/data/feeders` 端点）
3. 补充完整的元数据字段（batch_id, pool_id, feed_amount_g等）
4. 从设备状态中提取运行时长、剩余饵料等信息

---

## 2. 未实现的数据收集功能

### 2.1 ❌ 操作日志数据收集（完全缺失）

**需求：** 人工录入操作日志（投料、水质调控、巡检、清洗等）

**缺失功能：**
- ❌ 操作日志录入界面
- ❌ 操作日志数据上传
- ❌ 附件上传功能（图片或文档）

**需要实现：**
1. 创建操作日志录入界面（Web界面或桌面应用）
2. 实现操作日志数据上传（POST `/api/data/operations`）
3. 实现附件上传功能

**数据字段要求：**
- `operator_id`：操作人ID
- `batch_id`：批次ID
- `pool_id`：池号/分区
- `ts_utc`, `ts_local`：时间戳
- `action_type`：操作类型（枚举值）
- `remarks`：备注
- `attachment_uri`：附件URI（可选）

---

### 2.2 ❌ 养殖手册文档收集（完全缺失）

**需求：** 人工上传养殖手册/文档（PDF、Word、TXT等）

**缺失功能：**
- ❌ 文档上传界面
- ❌ 文档上传功能
- ❌ 文档版本管理

**需要实现：**
1. 创建文档上传界面
2. 实现文档上传（POST `/api/data/manuals`）
3. 实现文档版本管理

**数据字段要求：**
- `doc_uri`：文档URI
- `version`：版本号
- `source`：来源
- `notes`：备注

---

### 2.3 ❌ 往期养殖记录收集（完全缺失）

**需求：** 批量导入历史数据（CSV、Excel、JSON等）

**缺失功能：**
- ❌ 历史数据导入界面
- ❌ 历史数据导入功能
- ❌ 数据清洗和验证

**需要实现：**
1. 创建历史数据导入界面
2. 实现数据导入功能（批量导入到 `history_records` 表）
3. 实现数据清洗和验证

**数据字段要求：**
- `batch_id`：批次ID
- `metric_name`：指标名称
- `value`：值（文本存储）
- `unit`：单位
- `ts_utc`, `ts_local`：时间戳
- `notes`：备注

---

### 2.4 ❌ 当期养殖记录收集（完全缺失）

**需求：** 批次信息管理（创建、更新批次）

**缺失功能：**
- ❌ 批次创建界面
- ❌ 批次信息管理
- ❌ 批次数据更新

**需要实现：**
1. 创建批次管理界面
2. 实现批次创建和更新（POST `/api/batches`）
3. 实现批次信息查询

**数据字段要求：**
- `pool_id`：池号/分区标识
- `species`：物种（默认：Litopenaeus vannamei）
- `location`：场地/车间位置
- `seed_origin`：苗种来源
- `stocking_density`：放养密度
- `start_date`：开始日期
- `end_date`：结束日期（可选）
- `notes`：备注

---

## 3. 数据上传接口对比

### 3.1 已实现的接口

| 接口路径 | 实现位置 | 数据源 | 状态 |
|---------|---------|--------|------|
| `/api/updata_sensor_data` | `SensorDataStreamTask` | 传感器数据（流式） | ✅ 已实现 |
| `/api/updata_file` | `client/updata.py` | 传感器数据/操作日志/图像（批量） | ✅ 已实现 |
| `/api/camera_device_status` | `CameraControllerService` | 摄像头状态 | ✅ 已实现 |
| `/api/updata_camera_data` | `CameraControllerService` | 摄像头图像 | ✅ 已实现 |

### 3.2 服务端已提供但客户端未使用的接口

根据 `japan_server` 项目的实现，服务端已提供以下接口，但客户端未使用：

| 接口路径 | 服务端实现 | 客户端使用 | 说明 |
|---------|-----------|-----------|------|
| `/api/data/sensors` | ✅ `routes/data_collection_routes.py` | ❌ 未使用 | 传感器数据接收（推荐使用） |
| `/api/data/feeders` | ✅ `routes/data_collection_routes.py` | ❌ 未使用 | 喂食机数据接收 |
| `/api/data/operations` | ✅ `routes/data_collection_routes.py` | ❌ 未使用 | 操作日志接收 |
| `/api/data/cameras` | ❌ 未实现 | ❌ 未使用 | 摄像头图像接收（需要实现） |
| `/api/data/manuals` | ❌ 未实现 | ❌ 未使用 | 文档上传（需要实现） |

**建议：**
1. 将传感器数据流式上传改为使用 `/api/data/sensors` 接口
2. 实现喂食机数据上传到 `/api/data/feeders` 接口
3. 实现操作日志上传到 `/api/data/operations` 接口
4. 服务端需要实现 `/api/data/cameras` 和 `/api/data/manuals` 接口

---

## 4. 元数据完整性对比

### 4.1 传感器数据元数据对比

| 字段 | 要求 | 当前实现 | 状态 |
|------|------|---------|------|
| `device_id` | ✅ 必填 | ❌ 缺失 | ❌ |
| `batch_id` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `pool_id` | ✅ 必填 | ❌ 缺失 | ❌ |
| `ts_utc` | ✅ 必填 | ❌ 缺失 | ❌ |
| `ts_local` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `metric` | ✅ 必填 | ❌ 缺失 | ❌ |
| `value` | ✅ 必填 | ✅ 有 | ✅ |
| `unit` | ⚠️ 条件必填 | ⚠️ 部分（在CSV列名中） | ⚠️ |
| `quality_flag` | ✅ 必填 | ❌ 缺失 | ❌ |
| `checksum` | ⚠️ 推荐 | ❌ 缺失 | ❌ |

**符合度：** 约 **20%**

---

### 4.2 图像数据元数据对比

| 字段 | 要求 | 当前实现 | 状态 |
|------|------|---------|------|
| `camera_id` | ✅ 必填 | ✅ 有（camera_index） | ✅ |
| `batch_id` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `pool_id` | ✅ 必填 | ❌ 缺失 | ❌ |
| `ts_utc` | ✅ 必填 | ⚠️ 部分（timestamp） | ⚠️ |
| `ts_local` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `storage_uri` | ✅ 必填 | ❌ 缺失 | ❌ |
| `width_px` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `height_px` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `format` | ⚠️ 推荐 | ⚠️ 部分（jpg） | ⚠️ |
| `codec` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `quality_flag` | ✅ 必填 | ❌ 缺失 | ❌ |
| `checksum` | ⚠️ 推荐 | ❌ 缺失 | ❌ |

**符合度：** 约 **25%**

---

### 4.3 喂食机数据元数据对比

| 字段 | 要求 | 当前实现 | 状态 |
|------|------|---------|------|
| `feeder_id` | ✅ 必填 | ✅ 有（dev_id） | ✅ |
| `batch_id` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `pool_id` | ✅ 必填 | ❌ 缺失 | ❌ |
| `ts_utc` | ✅ 必填 | ❌ 缺失 | ❌ |
| `ts_local` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `feed_amount_g` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `run_time_s` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `status` | ✅ 必填 | ⚠️ 部分（从设备状态获取） | ⚠️ |
| `leftover_estimate_g` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `notes` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `checksum` | ⚠️ 推荐 | ❌ 缺失 | ❌ |

**符合度：** 约 **15%**

---

## 5. 数据质量处理

### 5.1 已实现

- ✅ 数据采集错误处理（重试机制）
- ✅ 网络上传错误处理（重试机制）
- ✅ 模拟模式支持（无硬件环境测试）

### 5.2 未实现

- ❌ 时间标准化（UTC + 本地时间）
- ❌ 单位统一转换
- ❌ 异常值检测
- ❌ 质量标记（quality_flag）
- ❌ 完整性校验（checksum）
- ❌ 数据清洗服务调用（服务端已实现 `DataCleaningService`，客户端未使用）

**改进建议：**
1. 在客户端实现基础的数据清洗（时间标准化、单位转换）
2. 或在上传前调用服务端的数据清洗接口
3. 实现质量标记和校验和生成

---

## 6. 配置管理

### 6.1 已实现的配置

- ✅ 环境变量配置（`AIJ_SENSOR_SIMULATE`, `AIJ_UPLOAD_DRY_RUN`等）
- ✅ 传感器配置（串口号、波特率等）
- ✅ 上传URL配置（可通过环境变量覆盖）

### 6.2 缺失的配置

- ❌ 设备ID配置（`device_id`, `camera_id`, `feeder_id`）
- ❌ 批次ID配置（`batch_id`）
- ❌ 池号配置（`pool_id`）
- ❌ 时区配置（用于生成本地时间戳）
- ❌ 配置文件管理（建议使用JSON或YAML配置文件）

**改进建议：**
1. 创建统一的配置文件（`config/client_config.json`）
2. 支持从配置文件读取设备ID、批次ID、池号等
3. 支持从环境变量覆盖配置

---

## 7. 总结与建议

### 7.1 满足度统计

| 数据源 | 实现状态 | 符合度 |
|--------|---------|--------|
| 传感器数据 | ✅ 已实现 | 60% |
| 图像目标监测 | ⚠️ 部分实现 | 40% |
| 喂食机数据 | ⚠️ 部分实现 | 30% |
| 操作日志 | ❌ 未实现 | 0% |
| 养殖手册文档 | ❌ 未实现 | 0% |
| 往期养殖记录 | ❌ 未实现 | 0% |
| 当期养殖记录 | ❌ 未实现 | 0% |

**总体符合度：** 约 **30%**

---

### 7.2 优先级改进建议

#### 🔴 高优先级（核心功能）

1. **补充传感器数据元数据**
   - 添加 `device_id`, `batch_id`, `pool_id`
   - 实现时间标准化（UTC + 本地时间）
   - 添加 `metric` 和 `unit` 字段
   - 实现质量标记和校验和

2. **实现喂食机数据记录和上传**
   - 每次喂食后生成记录
   - 上传到 `/api/data/feeders` 接口
   - 补充完整的元数据

3. **统一使用服务端标准接口**
   - 将传感器数据上传改为使用 `/api/data/sensors`
   - 实现喂食机数据上传到 `/api/data/feeders`

#### 🟡 中优先级（重要功能）

4. **实现操作日志录入和上传**
   - 创建操作日志录入界面
   - 实现上传到 `/api/data/operations` 接口

5. **完善图像数据元数据**
   - 补充 `batch_id`, `pool_id`
   - 添加图像尺寸、格式等元数据
   - 实现检测结果接收和上报

6. **实现配置管理**
   - 创建统一的配置文件
   - 支持设备ID、批次ID、池号等配置

#### 🟢 低优先级（辅助功能）

7. **实现文档上传功能**
   - 创建文档上传界面
   - 实现上传到 `/api/data/manuals` 接口

8. **实现历史数据导入**
   - 创建数据导入界面
   - 实现批量导入功能

9. **实现批次管理**
   - 创建批次管理界面
   - 实现批次创建和更新

---

### 7.3 技术债务

1. **代码组织**
   - 部分硬编码路径（如 `C:\Users\37897\Desktop\japan_data\`）
   - 建议使用配置文件管理路径

2. **错误处理**
   - 部分异常处理不够完善
   - 建议统一错误处理机制

3. **日志管理**
   - 日志分散在多个位置
   - 建议统一日志管理

4. **测试覆盖**
   - 缺少单元测试
   - 建议添加测试用例

---

## 8. 附录

### 8.1 相关文档

- [数据源清单](./01-数据源清单.md)
- [数据收集方式](./02-数据收集方式.md)
- [数据处理标准](./03-数据处理标准.md)
- [数据库表结构详细文档](./数据库表结构详细文档.md)

### 8.2 服务端接口文档

参考 `japan_server` 项目的实现：
- `/api/data/sensors` - 传感器数据接收
- `/api/data/feeders` - 喂食机数据接收
- `/api/data/operations` - 操作日志接收

---

**文档状态：** ✅ 已完成  
**最后更新：** 2025-01-XX





**评估日期：** 2025-01-XX  
**评估对象：** `/srv/ai_japan` - 日本陆上养殖实验室客户端服务器代码  
**评估依据：** 
- `docs/01-数据源清单.md`
- `docs/02-数据收集方式.md`
- `docs/03-数据处理标准.md`

---

## 执行摘要

`ai_japan` 项目是一个客户端数据采集和上传系统，部署在日本陆上养殖实验室的客户端服务器上。通过定时任务和触发式请求，将采集的数据发送到服务端。

**总体评估：** ⚠️ **部分满足** - 核心传感器数据采集和上传功能已实现，但缺少部分数据源的支持。

**满足度：** 约 **60%**

---

## 1. 已实现的数据收集功能

### 1.1 ✅ 传感器数据收集（完全满足）

**实现状态：** ✅ **已实现**

**实现位置：**
- `src/services/sensor_data_service.py` - 传感器数据采集服务
- `src/tasks/sensor_data_task.py` - 传感器数据采集任务
- `src/tasks/sensor_data_stream_task.py` - 传感器数据流式上传任务

**已支持的传感器：**
- ✅ 溶解氧传感器（COM18）
- ✅ 液位传感器（COM25）
- ✅ pH传感器（COM4）
- ✅ 浊度传感器（COM5）

**数据采集方式：**
- ✅ 定时自动采集（默认每10秒采样，可配置）
- ✅ 数据记录到CSV文件（`output/sensor/data_collection.csv`）
- ✅ 支持模拟模式（`AIJ_SENSOR_SIMULATE=1`）

**数据上传方式：**
- ✅ 流式上传（`SensorDataStreamTask`）：每10秒（可配置）推送数据到服务端
  - 目标URL：`http://8.216.33.92:5000/api/updata_sensor_data`
  - 数据格式：JSON，字段对齐CSV表头
- ✅ 批量上传（`client/updata.py`）：每10分钟执行一次，上传最近61天的CSV文件
  - 目标URL：`http://8.216.33.92:5000/api/updata_file`
  - 支持干运行模式（`AIJ_UPLOAD_DRY_RUN=1`）

**数据字段：**
- ✅ 时间戳
- ✅ 溶解氧饱和度
- ✅ 液位(mm)
- ✅ PH值
- ✅ PH温度(°C)
- ✅ 浊度(NTU)
- ✅ 浊度温度(°C)

**符合度评估：**
- ✅ 采集频率：符合要求（1-10分钟，当前为10秒，可调整）
- ✅ 数据格式：符合要求（结构化数据）
- ⚠️ 元数据完整性：**部分缺失**
  - ❌ 缺少 `device_id`（设备唯一标识）
  - ❌ 缺少 `batch_id`（批次ID）
  - ❌ 缺少 `pool_id`（池号/分区标识）
  - ❌ 缺少 `ts_utc` 和 `ts_local`（UTC和本地时间戳）
  - ❌ 缺少 `metric`（指标名称，如：do, ph, temp等）
  - ❌ 缺少 `unit`（计量单位，虽然CSV中有单位，但未作为独立字段）
  - ❌ 缺少 `quality_flag`（质量标记）
  - ❌ 缺少 `checksum`（完整性校验）

**改进建议：**
1. 在数据上传时补充完整的元数据字段
2. 添加设备ID配置（从配置文件或环境变量读取）
3. 添加批次ID和池号配置
4. 实现时间标准化（UTC + 本地时间）
5. 实现数据质量标记和校验和生成

---

### 1.2 ✅ 图像目标监测数据收集（部分满足）

**实现状态：** ⚠️ **部分实现**

**实现位置：**
- `src/services/camera_controller_service.py` - 摄像头控制服务
- `src/tasks/camera_controller_task.py` - 摄像头控制任务

**已实现功能：**
- ✅ 键盘触发录制（按键0-4触发对应摄像头）
- ✅ 视频录制（默认60秒，可配置）
- ✅ 视频保存到本地（`logs/videos/`）
- ✅ 录制状态上报（开始/结束事件发送到服务端）
  - 目标URL：`http://8.216.33.92:5000/api/camera_device_status`
- ✅ 视频抽帧（按固定间隔抽取帧，默认1秒）
- ✅ 图片上传（抽帧后的图片上传到服务端）
  - 目标URL：`http://8.216.33.92:5000/api/updata_camera_data`
  - 支持干运行模式（`AIJ_CAMERA_UPLOAD_DRY_RUN=1`）

**上传的元数据：**
- ✅ `camera_index`（摄像头索引）
- ✅ `video_name`（视频名称）
- ✅ `timestamp`（时间戳，ISO格式）

**缺失功能：**
- ❌ 缺少 `batch_id`（批次ID）
- ❌ 缺少 `pool_id`（池号/分区）
- ❌ 缺少图像检测结果上传（检测数量、长度、高度、体重等）
- ❌ 缺少模型信息（`model_name`, `model_version`）
- ❌ 缺少置信度信息（`confidence_avg`）
- ❌ 缺少图像元数据（分辨率、格式、编解码等）

**符合度评估：**
- ✅ 触发方式：符合要求（用户触发）
- ✅ 图像采集：符合要求
- ✅ 图像上传：符合要求
- ❌ 检测结果：**未实现** - 图像检测结果（count, avg_length_mm等）需要服务端AI模型推理后返回，客户端未实现结果接收和上报
- ⚠️ 元数据完整性：**部分缺失**

**改进建议：**
1. 在图像上传时补充 `batch_id` 和 `pool_id`
2. 实现图像检测结果接收（从服务端API获取检测结果）
3. 实现检测结果上报（将检测结果发送到服务端）
4. 补充完整的图像元数据（分辨率、格式等）

---

### 1.3 ✅ 喂食机数据收集（部分满足）

**实现状态：** ⚠️ **部分实现**

**实现位置：**
- `src/services/feeder_service.py` - 喂食机服务
- `src/tasks/feed_device_schedule_task.py` - 定时喂食任务
- `src/tasks/feed_device_status_task.py` - 喂食机状态上报任务

**已实现功能：**
- ✅ 云端喂食机接口封装（登录、设备查询、状态查询、喂食指令）
- ✅ 定时喂食（按时间列表触发，默认04:00、10:00、16:00、22:00）
- ✅ 喂食机状态上报（每10分钟执行一次，可配置）
- ✅ 支持多份量喂食（高份量4份，低份量2份）

**缺失功能：**
- ❌ 缺少喂食记录上传（`feeders_logs` 表所需的数据）
- ❌ 缺少 `batch_id`（批次ID）
- ❌ 缺少 `pool_id`（池号/分区）
- ❌ 缺少 `feed_amount_g`（投喂量，克）
- ❌ 缺少 `run_time_s`（运行时长，秒）
- ❌ 缺少 `leftover_estimate_g`（剩余饵料估计，克）
- ❌ 缺少 `checksum`（完整性校验）

**符合度评估：**
- ✅ 设备控制：符合要求（可以控制喂食机）
- ✅ 定时触发：符合要求
- ❌ 数据记录：**未实现** - 喂食操作后未记录和上传喂食日志数据

**改进建议：**
1. 实现喂食记录生成（每次喂食后生成记录）
2. 实现喂食记录上传（发送到服务端 `/api/data/feeders` 端点）
3. 补充完整的元数据字段（batch_id, pool_id, feed_amount_g等）
4. 从设备状态中提取运行时长、剩余饵料等信息

---

## 2. 未实现的数据收集功能

### 2.1 ❌ 操作日志数据收集（完全缺失）

**需求：** 人工录入操作日志（投料、水质调控、巡检、清洗等）

**缺失功能：**
- ❌ 操作日志录入界面
- ❌ 操作日志数据上传
- ❌ 附件上传功能（图片或文档）

**需要实现：**
1. 创建操作日志录入界面（Web界面或桌面应用）
2. 实现操作日志数据上传（POST `/api/data/operations`）
3. 实现附件上传功能

**数据字段要求：**
- `operator_id`：操作人ID
- `batch_id`：批次ID
- `pool_id`：池号/分区
- `ts_utc`, `ts_local`：时间戳
- `action_type`：操作类型（枚举值）
- `remarks`：备注
- `attachment_uri`：附件URI（可选）

---

### 2.2 ❌ 养殖手册文档收集（完全缺失）

**需求：** 人工上传养殖手册/文档（PDF、Word、TXT等）

**缺失功能：**
- ❌ 文档上传界面
- ❌ 文档上传功能
- ❌ 文档版本管理

**需要实现：**
1. 创建文档上传界面
2. 实现文档上传（POST `/api/data/manuals`）
3. 实现文档版本管理

**数据字段要求：**
- `doc_uri`：文档URI
- `version`：版本号
- `source`：来源
- `notes`：备注

---

### 2.3 ❌ 往期养殖记录收集（完全缺失）

**需求：** 批量导入历史数据（CSV、Excel、JSON等）

**缺失功能：**
- ❌ 历史数据导入界面
- ❌ 历史数据导入功能
- ❌ 数据清洗和验证

**需要实现：**
1. 创建历史数据导入界面
2. 实现数据导入功能（批量导入到 `history_records` 表）
3. 实现数据清洗和验证

**数据字段要求：**
- `batch_id`：批次ID
- `metric_name`：指标名称
- `value`：值（文本存储）
- `unit`：单位
- `ts_utc`, `ts_local`：时间戳
- `notes`：备注

---

### 2.4 ❌ 当期养殖记录收集（完全缺失）

**需求：** 批次信息管理（创建、更新批次）

**缺失功能：**
- ❌ 批次创建界面
- ❌ 批次信息管理
- ❌ 批次数据更新

**需要实现：**
1. 创建批次管理界面
2. 实现批次创建和更新（POST `/api/batches`）
3. 实现批次信息查询

**数据字段要求：**
- `pool_id`：池号/分区标识
- `species`：物种（默认：Litopenaeus vannamei）
- `location`：场地/车间位置
- `seed_origin`：苗种来源
- `stocking_density`：放养密度
- `start_date`：开始日期
- `end_date`：结束日期（可选）
- `notes`：备注

---

## 3. 数据上传接口对比

### 3.1 已实现的接口

| 接口路径 | 实现位置 | 数据源 | 状态 |
|---------|---------|--------|------|
| `/api/updata_sensor_data` | `SensorDataStreamTask` | 传感器数据（流式） | ✅ 已实现 |
| `/api/updata_file` | `client/updata.py` | 传感器数据/操作日志/图像（批量） | ✅ 已实现 |
| `/api/camera_device_status` | `CameraControllerService` | 摄像头状态 | ✅ 已实现 |
| `/api/updata_camera_data` | `CameraControllerService` | 摄像头图像 | ✅ 已实现 |

### 3.2 服务端已提供但客户端未使用的接口

根据 `japan_server` 项目的实现，服务端已提供以下接口，但客户端未使用：

| 接口路径 | 服务端实现 | 客户端使用 | 说明 |
|---------|-----------|-----------|------|
| `/api/data/sensors` | ✅ `routes/data_collection_routes.py` | ❌ 未使用 | 传感器数据接收（推荐使用） |
| `/api/data/feeders` | ✅ `routes/data_collection_routes.py` | ❌ 未使用 | 喂食机数据接收 |
| `/api/data/operations` | ✅ `routes/data_collection_routes.py` | ❌ 未使用 | 操作日志接收 |
| `/api/data/cameras` | ❌ 未实现 | ❌ 未使用 | 摄像头图像接收（需要实现） |
| `/api/data/manuals` | ❌ 未实现 | ❌ 未使用 | 文档上传（需要实现） |

**建议：**
1. 将传感器数据流式上传改为使用 `/api/data/sensors` 接口
2. 实现喂食机数据上传到 `/api/data/feeders` 接口
3. 实现操作日志上传到 `/api/data/operations` 接口
4. 服务端需要实现 `/api/data/cameras` 和 `/api/data/manuals` 接口

---

## 4. 元数据完整性对比

### 4.1 传感器数据元数据对比

| 字段 | 要求 | 当前实现 | 状态 |
|------|------|---------|------|
| `device_id` | ✅ 必填 | ❌ 缺失 | ❌ |
| `batch_id` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `pool_id` | ✅ 必填 | ❌ 缺失 | ❌ |
| `ts_utc` | ✅ 必填 | ❌ 缺失 | ❌ |
| `ts_local` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `metric` | ✅ 必填 | ❌ 缺失 | ❌ |
| `value` | ✅ 必填 | ✅ 有 | ✅ |
| `unit` | ⚠️ 条件必填 | ⚠️ 部分（在CSV列名中） | ⚠️ |
| `quality_flag` | ✅ 必填 | ❌ 缺失 | ❌ |
| `checksum` | ⚠️ 推荐 | ❌ 缺失 | ❌ |

**符合度：** 约 **20%**

---

### 4.2 图像数据元数据对比

| 字段 | 要求 | 当前实现 | 状态 |
|------|------|---------|------|
| `camera_id` | ✅ 必填 | ✅ 有（camera_index） | ✅ |
| `batch_id` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `pool_id` | ✅ 必填 | ❌ 缺失 | ❌ |
| `ts_utc` | ✅ 必填 | ⚠️ 部分（timestamp） | ⚠️ |
| `ts_local` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `storage_uri` | ✅ 必填 | ❌ 缺失 | ❌ |
| `width_px` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `height_px` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `format` | ⚠️ 推荐 | ⚠️ 部分（jpg） | ⚠️ |
| `codec` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `quality_flag` | ✅ 必填 | ❌ 缺失 | ❌ |
| `checksum` | ⚠️ 推荐 | ❌ 缺失 | ❌ |

**符合度：** 约 **25%**

---

### 4.3 喂食机数据元数据对比

| 字段 | 要求 | 当前实现 | 状态 |
|------|------|---------|------|
| `feeder_id` | ✅ 必填 | ✅ 有（dev_id） | ✅ |
| `batch_id` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `pool_id` | ✅ 必填 | ❌ 缺失 | ❌ |
| `ts_utc` | ✅ 必填 | ❌ 缺失 | ❌ |
| `ts_local` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `feed_amount_g` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `run_time_s` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `status` | ✅ 必填 | ⚠️ 部分（从设备状态获取） | ⚠️ |
| `leftover_estimate_g` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `notes` | ⚠️ 推荐 | ❌ 缺失 | ❌ |
| `checksum` | ⚠️ 推荐 | ❌ 缺失 | ❌ |

**符合度：** 约 **15%**

---

## 5. 数据质量处理

### 5.1 已实现

- ✅ 数据采集错误处理（重试机制）
- ✅ 网络上传错误处理（重试机制）
- ✅ 模拟模式支持（无硬件环境测试）

### 5.2 未实现

- ❌ 时间标准化（UTC + 本地时间）
- ❌ 单位统一转换
- ❌ 异常值检测
- ❌ 质量标记（quality_flag）
- ❌ 完整性校验（checksum）
- ❌ 数据清洗服务调用（服务端已实现 `DataCleaningService`，客户端未使用）

**改进建议：**
1. 在客户端实现基础的数据清洗（时间标准化、单位转换）
2. 或在上传前调用服务端的数据清洗接口
3. 实现质量标记和校验和生成

---

## 6. 配置管理

### 6.1 已实现的配置

- ✅ 环境变量配置（`AIJ_SENSOR_SIMULATE`, `AIJ_UPLOAD_DRY_RUN`等）
- ✅ 传感器配置（串口号、波特率等）
- ✅ 上传URL配置（可通过环境变量覆盖）

### 6.2 缺失的配置

- ❌ 设备ID配置（`device_id`, `camera_id`, `feeder_id`）
- ❌ 批次ID配置（`batch_id`）
- ❌ 池号配置（`pool_id`）
- ❌ 时区配置（用于生成本地时间戳）
- ❌ 配置文件管理（建议使用JSON或YAML配置文件）

**改进建议：**
1. 创建统一的配置文件（`config/client_config.json`）
2. 支持从配置文件读取设备ID、批次ID、池号等
3. 支持从环境变量覆盖配置

---

## 7. 总结与建议

### 7.1 满足度统计

| 数据源 | 实现状态 | 符合度 |
|--------|---------|--------|
| 传感器数据 | ✅ 已实现 | 60% |
| 图像目标监测 | ⚠️ 部分实现 | 40% |
| 喂食机数据 | ⚠️ 部分实现 | 30% |
| 操作日志 | ❌ 未实现 | 0% |
| 养殖手册文档 | ❌ 未实现 | 0% |
| 往期养殖记录 | ❌ 未实现 | 0% |
| 当期养殖记录 | ❌ 未实现 | 0% |

**总体符合度：** 约 **30%**

---

### 7.2 优先级改进建议

#### 🔴 高优先级（核心功能）

1. **补充传感器数据元数据**
   - 添加 `device_id`, `batch_id`, `pool_id`
   - 实现时间标准化（UTC + 本地时间）
   - 添加 `metric` 和 `unit` 字段
   - 实现质量标记和校验和

2. **实现喂食机数据记录和上传**
   - 每次喂食后生成记录
   - 上传到 `/api/data/feeders` 接口
   - 补充完整的元数据

3. **统一使用服务端标准接口**
   - 将传感器数据上传改为使用 `/api/data/sensors`
   - 实现喂食机数据上传到 `/api/data/feeders`

#### 🟡 中优先级（重要功能）

4. **实现操作日志录入和上传**
   - 创建操作日志录入界面
   - 实现上传到 `/api/data/operations` 接口

5. **完善图像数据元数据**
   - 补充 `batch_id`, `pool_id`
   - 添加图像尺寸、格式等元数据
   - 实现检测结果接收和上报

6. **实现配置管理**
   - 创建统一的配置文件
   - 支持设备ID、批次ID、池号等配置

#### 🟢 低优先级（辅助功能）

7. **实现文档上传功能**
   - 创建文档上传界面
   - 实现上传到 `/api/data/manuals` 接口

8. **实现历史数据导入**
   - 创建数据导入界面
   - 实现批量导入功能

9. **实现批次管理**
   - 创建批次管理界面
   - 实现批次创建和更新

---

### 7.3 技术债务

1. **代码组织**
   - 部分硬编码路径（如 `C:\Users\37897\Desktop\japan_data\`）
   - 建议使用配置文件管理路径

2. **错误处理**
   - 部分异常处理不够完善
   - 建议统一错误处理机制

3. **日志管理**
   - 日志分散在多个位置
   - 建议统一日志管理

4. **测试覆盖**
   - 缺少单元测试
   - 建议添加测试用例

---

## 8. 附录

### 8.1 相关文档

- [数据源清单](./01-数据源清单.md)
- [数据收集方式](./02-数据收集方式.md)
- [数据处理标准](./03-数据处理标准.md)
- [数据库表结构详细文档](./数据库表结构详细文档.md)

### 8.2 服务端接口文档

参考 `japan_server` 项目的实现：
- `/api/data/sensors` - 传感器数据接收
- `/api/data/feeders` - 喂食机数据接收
- `/api/data/operations` - 操作日志接收

---

**文档状态：** ✅ 已完成  
**最后更新：** 2025-01-XX



